<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ ‡å‡†ç‰©è´¨ç®¡ç†åŠ©æ‰‹ - è°ƒè¯•é¢„è§ˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', primaryDark: '#2563eb',
                        success: '#22c55e', danger: '#ef4444',
                        warning: '#f59e0b', info: '#0ea5e9',
                        background: '#f1f5f9', surface: '#ffffff'
                    }
                }
            }
        }
    </script>
    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; }
        body { font-family: 'Inter', 'PingFang SC', sans-serif; background: #f1f5f9; }
        
        .page { display: none; min-height: 100vh; padding-bottom: 80px; }
        .page.active { display: block; }
        
        .header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 1rem;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
        }
        
        .content { margin-top: 4.5rem; padding: 1rem; }
        
        .card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .stat-card {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .stat-icon {
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }
        
        .quick-action-btn {
            background: white;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .quick-action-btn:hover { transform: translateY(-3px); box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); }
        
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.75rem;
            color: #64748b;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .nav-item.active { color: #3b82f6; }
        .nav-item i { font-size: 1.25rem; margin-bottom: 0.25rem; }
        .nav-item span { font-size: 0.75rem; }
        
        .footer {
            background: white;
            border-top: 1px solid #e2e8f0;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 50;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .modal.show { display: flex; }
        
        .modal-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 28rem;
            max-height: 90vh;
            overflow: hidden;
            animation: modalSlideUp 0.3s ease;
        }
        
        @keyframes modalSlideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .modal-header {
            background: #3b82f6;
            color: white;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .tab-btn {
            flex: 1;
            padding: 0.75rem;
            text-align: center;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-btn.active {
            border-bottom-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        
        .form-input {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        
        .form-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        
        .btn {
            padding: 0.625rem 1.25rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .btn-primary { background: #3b82f6; color: white; }
        .btn-primary:hover { background: #2563eb; }
        .btn-secondary { background: #e5e7eb; color: #374151; }
        .btn-secondary:hover { background: #d1d5db; }
        .btn-success { background: #22c55e; color: white; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-warning { background: #f59e0b; color: white; }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .status-normal { background: #dcfce7; color: #166534; }
        .status-warning { background: #fef3c7; color: #92400e; }
        .status-danger { background: #fee2e2; color: #991b1b; }
        .status-info { background: #dbeafe; color: #1e40af; }
        
        .stock-group { border: 1px solid #e2e8f0; border-radius: 0.5rem; overflow: hidden; margin-bottom: 1rem; }
        .stock-group-header { background: #f8fafc; padding: 1rem; cursor: pointer; }
        .stock-item { border-bottom: 1px solid #f1f5f9; padding: 1rem; }
        .stock-item:last-child { border-bottom: none; }
        
        .activity-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem 0;
            border-bottom: 1px solid #f1f5f9;
        }
        
        .activity-item:last-child { border-bottom: none; }
        
        /* æ¶ˆæ¯æ ·å¼ä¼˜åŒ– */
        .message-item {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e2e8f0;
            background: white;
        }
        
        .message-item:hover { 
            background: #f8fafc; 
            transform: translateX(4px);
        }
        
        .message-item.unread { 
            background: #eff6ff; 
            border-left: 4px solid #3b82f6;
        }
        
        .message-item.read {
            background: white;
            border-left: 4px solid transparent;
            opacity: 0.9;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .message-sender {
            font-weight: 600;
            color: #1e293b;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: #64748b;
        }
        
        .message-content {
            color: #374151;
            line-height: 1.5;
            word-break: break-word;
        }
        
        .message-to {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px dashed #e2e8f0;
        }
        
        .unread-badge {
            display: inline-block;
            background: #3b82f6;
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 9999px;
            font-weight: 600;
        }
        
        .personnel-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .personnel-item:last-child { border-bottom: none; }
        
        .record-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; }
        .record-item:last-child { border-bottom: none; }
        
        .setting-item { border-bottom: 1px solid #e2e8f0; padding: 1rem 0; display: flex; justify-content: space-between; align-items: center; }
        .setting-item:last-child { border-bottom: none; }
        
        .login-container {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 1.5rem;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            padding: 2.5rem;
            width: 100%;
            max-width: 420px;
            animation: slideUp 0.5s ease-out;
        }
        
        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .notification-badge {
            position: absolute;
            top: -0.25rem;
            right: -0.25rem;
            background: #ef4444;
            color: white;
            font-size: 0.625rem;
            min-width: 1rem;
            height: 1rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 0.25rem;
        }
        
        .empty-state { text-align: center; padding: 2rem; color: #9ca3af; }
        
        .image-preview-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.5rem; }
        .image-preview-item { position: relative; }
        .image-preview-item img { width: 100%; height: 6rem; object-fit: cover; border-radius: 0.375rem; }
        
        .tab-nav { display: flex; border-bottom: 1px solid #e2e8f0; margin-bottom: 1rem; }
        .tab-nav-item { flex: 1; padding: 0.75rem; text-align: center; cursor: pointer; border-bottom: 2px solid transparent; }
        .tab-nav-item.active { border-bottom-color: #3b82f6; color: #3b82f6; font-weight: 600; }
        
        /* å›¾ç‰‡ç½‘æ ¼æ ·å¼ */
        .record-images {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .record-image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 0.375rem;
            overflow: hidden;
            cursor: pointer;
            border: 1px solid #e2e8f0;
        }
        
        .record-image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .record-image-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.75rem;
        }
        
        /* å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† */
        .image-viewer-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
        }
        
        .image-viewer-modal.show { display: flex; }
        
        .image-viewer-content {
            max-width: 90%;
            max-height: 90%;
        }
        
        .image-viewer-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        
        /* è°ƒè¯•é¢æ¿æ ·å¼ */
        .debug-panel {
            position: fixed;
            top: 80px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #0f0;
            padding: 10px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            z-index: 9999;
            max-width: 300px;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }
        
        .debug-toggle {
            position: fixed;
            top: 80px;
            right: 10px;
            background: #3b82f6;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 9998;
            cursor: pointer;
        }
        
        /* æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† */
        .message-detail-modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 60;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        
        .message-detail-modal.show { display: flex; }
        
        .message-detail-content {
            background: white;
            border-radius: 1rem;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 1.5rem;
        }
    </style>
</head>
<body>
    <!-- è°ƒè¯•å·¥å…· -->
    <div class="debug-toggle" onclick="toggleDebug()">ğŸ”§ è°ƒè¯•</div>
    <div id="debugPanel" class="debug-panel">
        <h4 class="text-white mb-2">è°ƒè¯•ä¿¡æ¯</h4>
        <div id="debugContent"></div>
        <button onclick="clearAllData()" class="mt-2 bg-red-600 text-white px-2 py-1 rounded text-xs">æ¸…ç©ºæ‰€æœ‰æ•°æ®</button>
        <button onclick="loadDemoData()" class="mt-2 bg-green-600 text-white px-2 py-1 rounded text-xs ml-2">åŠ è½½æ¼”ç¤ºæ•°æ®</button>
        <button onclick="testMessage()" class="mt-2 bg-blue-600 text-white px-2 py-1 rounded text-xs ml-2">æµ‹è¯•æ¶ˆæ¯</button>
    </div>

    <!-- ç™»å½•é¡µé¢ -->
    <div id="loginPage" class="page active" style="display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 50%, #1e40af 100%);">
        <div class="login-container">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-br from-blue-500 to-blue-700 rounded-2xl flex items-center justify-center mx-auto mb-4">
                    <i class="fa fa-cubes text-4xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold bg-gradient-to-r from-blue-500 to-blue-700 bg-clip-text text-transparent">æ ‡å‡†ç‰©è´¨ç®¡ç†åŠ©æ‰‹</h1>
                <p class="text-gray-500 mt-1">è°ƒè¯•é¢„è§ˆç‰ˆ v1.0.0</p>
            </div>
            
            <div id="loginError" class="hidden bg-red-50 border border-red-200 text-red-600 px-4 py-2 rounded-lg mb-4 text-sm"></div>
            
            <form id="loginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å</label>
                    <div class="relative">
                        <input type="text" id="loginUsername" class="form-input pl-10" placeholder="è¯·è¾“å…¥ç”¨æˆ·å" required>
                        <i class="fa fa-user absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç </label>
                    <div class="relative">
                        <input type="password" id="loginPassword" class="form-input pl-10 pr-10" placeholder="è¯·è¾“å…¥å¯†ç " required>
                        <i class="fa fa-lock absolute left-3 top-3 text-gray-400"></i>
                        <button type="button" onclick="togglePassword()" class="absolute right-3 top-3 text-gray-400">
                            <i class="fa fa-eye" id="passwordToggleIcon"></i>
                        </button>
                    </div>
                </div>
                
                <div class="flex items-center justify-between">
                    <label class="flex items-center">
                        <input type="checkbox" id="rememberMe" class="w-4 h-4 text-primary rounded">
                        <span class="ml-2 text-sm text-gray-600">è®°ä½æˆ‘</span>
                    </label>
                </div>
                
                <button type="submit" class="w-full btn btn-primary py-3 text-base">
                    <i class="fa fa-sign-in mr-2"></i>ç™»å½•
                </button>
            </form>
            
            <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                <p class="text-center text-sm text-gray-500 mb-2">æµ‹è¯•è´¦å·</p>
                <div class="space-y-2 text-xs">
                    <div class="flex justify-between bg-blue-100 text-blue-800 px-3 py-2 rounded">
                        <span>ç®¡ç†å‘˜</span>
                        <span class="font-mono">admin / admin123</span>
                    </div>
                    <div class="flex justify-between bg-green-100 text-green-800 px-3 py-2 rounded">
                        <span>æ“ä½œå‘˜</span>
                        <span class="font-mono">user1 / user123</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ä¸»åº”ç”¨å®¹å™¨ -->
    <div id="appContainer" style="display: none;">
        <!-- å¤´éƒ¨ -->
        <div class="header flex items-center justify-between">
            <h1 id="pageTitle" class="text-xl font-bold flex items-center">
                <i class="fa fa-cubes mr-2"></i>
                <span>æ ‡å‡†ç‰©è´¨ç®¡ç†</span>
            </h1>
            <div class="flex items-center space-x-4">
                <button onclick="openNotificationModal()" class="relative p-2">
                    <i class="fa fa-bell-o text-xl"></i>
                    <span id="notificationCount" class="notification-badge hidden">0</span>
                </button>
                <button onclick="showScanModal()" class="p-2">
                    <i class="fa fa-qrcode text-xl"></i>
                </button>
                <button onclick="logout()" class="flex items-center p-2">
                    <i class="fa fa-user-circle text-xl mr-1"></i>
                    <span id="currentUserName" class="text-sm">ç®¡ç†å‘˜</span>
                </button>
            </div>
        </div>

        <!-- å†…å®¹åŒºåŸŸ -->
        <div class="content">
            <!-- é¦–é¡µ -->
            <div id="dashboardPage" class="page active">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="stat-card">
                        <div>
                            <p class="text-sm text-gray-500">æ€»åº“å­˜</p>
                            <p id="totalStock" class="text-3xl font-bold text-primary">0</p>
                        </div>
                        <div class="stat-icon bg-blue-100">
                            <i class="fa fa-cubes text-primary"></i>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div>
                            <p class="text-sm text-gray-500">è¿‘æ•ˆæœŸé¢„è­¦</p>
                            <p id="expiryWarning" class="text-3xl font-bold text-warning">0</p>
                        </div>
                        <div class="stat-icon bg-yellow-100">
                            <i class="fa fa-exclamation-triangle text-warning"></i>
                        </div>
                    </div>
                </div>

                <!-- åº“å­˜çŠ¶æ€å›¾è¡¨ -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-pie-chart text-primary mr-2"></i>
                        åº“å­˜çŠ¶æ€åˆ†å¸ƒ
                    </h2>
                    <div class="h-56">
                        <canvas id="stockStatusChart"></canvas>
                    </div>
                </div>

                <!-- å¿«é€Ÿæ“ä½œ -->
                <div class="card">
                    <h2 class="text-lg font-semibold mb-4 flex items-center">
                        <i class="fa fa-bolt text-warning mr-2"></i>
                        å¿«é€Ÿæ“ä½œ
                    </h2>
                    <div class="grid grid-cols-4 gap-4">
                        <div class="quick-action-btn" onclick="showAddStockModal()">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-archive text-primary text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-600">å…¥åº“</span>
                        </div>
                        <div class="quick-action-btn" onclick="showOutStockModal()">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-sign-out text-success text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-600">å‡ºåº“</span>
                        </div>
                        <div class="quick-action-btn" onclick="switchPage('stock')">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-list text-purple-600 text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-600">åº“å­˜</span>
                        </div>
                        <div class="quick-action-btn" onclick="switchPage('records')">
                            <div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center mb-2">
                                <i class="fa fa-history text-gray-600 text-xl"></i>
                            </div>
                            <span class="text-xs text-gray-600">è®°å½•</span>
                        </div>
                    </div>
                </div>

                <!-- æœ€è¿‘æ´»åŠ¨ -->
                <div class="card">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-lg font-semibold flex items-center">
                            <i class="fa fa-clock-o text-info mr-2"></i>
                            æœ€è¿‘æ´»åŠ¨
                        </h2>
                        <button onclick="switchPage('records')" class="text-primary text-sm hover:underline">æŸ¥çœ‹å…¨éƒ¨</button>
                    </div>
                    <div id="recentActivities">
                        <div class="empty-state">
                            <i class="fa fa-inbox text-4xl mb-2"></i>
                            <p>æš‚æ— æ´»åŠ¨è®°å½•</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- åº“å­˜é¡µé¢ -->
            <div id="stockPage" class="page">
                <!-- æœç´¢æ  -->
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="stockSearchInput" placeholder="æœç´¢æ ‡å‡†ç‰©è´¨..." class="form-input pl-10" oninput="renderStockList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <!-- æ ‡ç­¾é¡µ -->
                <div class="tab-nav">
                    <div class="tab-nav-item active" onclick="switchStockTab('all', this)">å…¨éƒ¨</div>
                    <div class="tab-nav-item" onclick="switchStockTab('normal', this)">æ­£å¸¸</div>
                    <div class="tab-nav-item" onclick="switchStockTab('warning', this)">å³å°†è¿‡æœŸ</div>
                    <div class="tab-nav-item" onclick="switchStockTab('expired', this)">å·²è¿‡æœŸ</div>
                    <div class="tab-nav-item" onclick="switchStockTab('low', this)">åº“å­˜ä¸è¶³</div>
                </div>

                <!-- åº“å­˜åˆ—è¡¨ -->
                <div id="stockList">
                    <div class="empty-state">
                        <i class="fa fa-inbox text-4xl mb-2"></i>
                        <p>æš‚æ— åº“å­˜æ•°æ®</p>
                    </div>
                </div>
            </div>

            <!-- äººå‘˜é¡µé¢ -->
            <div id="personnelPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="personnelSearchInput" placeholder="æœç´¢äººå‘˜..." class="form-input pl-10" oninput="renderPersonnelList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold">äººå‘˜åˆ—è¡¨</h2>
                    <button onclick="showAddPersonnelModal()" class="btn btn-primary">
                        <i class="fa fa-plus mr-1"></i>æ·»åŠ 
                    </button>
                </div>

                <div id="personnelList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-users text-4xl mb-2"></i>
                        <p>æš‚æ— äººå‘˜æ•°æ®</p>
                    </div>
                </div>
            </div>

            <!-- è®°å½•é¡µé¢ -->
            <div id="recordsPage" class="page">
                <div class="card mb-4">
                    <div class="relative">
                        <input type="text" id="recordsSearchInput" placeholder="æœç´¢è®°å½•..." class="form-input pl-10" oninput="renderRecordsList()">
                        <i class="fa fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>

                <div id="recordsList" class="card">
                    <div class="empty-state">
                        <i class="fa fa-history text-4xl mb-2"></i>
                        <p>æš‚æ— æ“ä½œè®°å½•</p>
                    </div>
                </div>
            </div>

            <!-- è®¾ç½®é¡µé¢ -->
            <div id="settingsPage" class="page">
                <!-- ä¸ªäººä¿¡æ¯ -->
                <div class="card mb-4">
                    <div class="flex items-center">
                        <div class="w-16 h-16 bg-primary text-white rounded-full flex items-center justify-center text-2xl font-bold mr-4">
                            <span id="settingUserInitial">ç®¡</span>
                        </div>
                        <div>
                            <h2 class="text-lg font-semibold" id="settingUserName">ç®¡ç†å‘˜</h2>
                            <p class="text-sm text-gray-500" id="settingUserRole">ç³»ç»Ÿç®¡ç†å‘˜</p>
                        </div>
                    </div>
                </div>

                <!-- è®¾ç½®é¡¹ -->
                <div class="card">
                    <div class="setting-item" onclick="showChangePasswordModal()">
                        <div class="flex items-center">
                            <i class="fa fa-lock text-primary mr-3"></i>
                            <span>ä¿®æ”¹å¯†ç </span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="exportData()">
                        <div class="flex items-center">
                            <i class="fa fa-download text-success mr-3"></i>
                            <span>æ•°æ®å¯¼å‡º(Excel)</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item" onclick="clearAllData()">
                        <div class="flex items-center">
                            <i class="fa fa-trash text-danger mr-3"></i>
                            <span>æ¸…ç©ºæ•°æ®</span>
                        </div>
                        <i class="fa fa-chevron-right text-gray-400"></i>
                    </div>
                    <div class="setting-item">
                        <div class="flex items-center">
                            <i class="fa fa-info-circle text-info mr-3"></i>
                            <span>å…³äºç³»ç»Ÿ</span>
                        </div>
                        <div>
                            <span class="text-sm text-gray-500">v1.0.0</span>
                            <i class="fa fa-chevron-right text-gray-400 ml-2"></i>
                        </div>
                    </div>
                </div>

                <button onclick="logout()" class="w-full bg-white text-danger font-semibold py-3 rounded-lg mt-6 border border-gray-200">
                    <i class="fa fa-sign-out mr-2"></i>é€€å‡ºç™»å½•
                </button>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆª -->
        <div class="footer">
            <div class="flex justify-around">
                <div class="nav-item active" onclick="switchPage('dashboard')">
                    <i class="fa fa-home"></i>
                    <span>é¦–é¡µ</span>
                </div>
                <div class="nav-item" onclick="switchPage('stock')">
                    <i class="fa fa-cubes"></i>
                    <span>åº“å­˜</span>
                </div>
                <div class="nav-item" onclick="switchPage('personnel')">
                    <i class="fa fa-users"></i>
                    <span>äººå‘˜</span>
                </div>
                <div class="nav-item" onclick="switchPage('settings')">
                    <i class="fa fa-cog"></i>
                    <span>è®¾ç½®</span>
                </div>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡† -->
    <!-- æ¶ˆæ¯æ¨¡æ€æ¡† -->
    <div id="notificationModal" class="modal" onclick="closeModalOnBg(event, 'notificationModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">æ¶ˆæ¯ä¸­å¿ƒ</h2>
                <button onclick="closeNotificationModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="flex border-b border-gray-200">
                <div class="tab-btn active" onclick="switchMessageTab('messages', this)">æ¶ˆæ¯åˆ—è¡¨</div>
                <div class="tab-btn" onclick="switchMessageTab('compose', this)">å‘é€æ¶ˆæ¯</div>
            </div>
            
            <!-- æ¶ˆæ¯åˆ—è¡¨ -->
            <div id="messagesContent" class="p-4 max-h-96 overflow-y-auto">
                <div class="empty-state">
                    <i class="fa fa-inbox text-4xl mb-2"></i>
                    <p>æš‚æ— æ¶ˆæ¯</p>
                </div>
            </div>
            
            <!-- å‘é€æ¶ˆæ¯ -->
            <div id="composeContent" class="p-4 hidden">
                <form id="composeForm" onsubmit="sendMessage(event)">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¥æ”¶äºº <span class="text-red-500">*</span></label>
                        <select id="messageRecipient" name="recipient" class="form-input" required>
                            <option value="">è¯·é€‰æ‹©æ¥æ”¶äºº</option>
                            <option value="all">æ‰€æœ‰äºº</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¶ˆæ¯å†…å®¹ <span class="text-red-500">*</span></label>
                        <textarea id="messageContent" name="content" class="form-input" rows="4" placeholder="è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹..." required></textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button type="button" onclick="closeNotificationModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-send mr-1"></i>å‘é€
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ¶ˆæ¯è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="messageDetailModal" class="message-detail-modal" onclick="closeMessageDetail(event)">
        <div class="message-detail-content" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-4">
                <h3 class="text-lg font-bold text-gray-900">æ¶ˆæ¯è¯¦æƒ…</h3>
                <button onclick="closeMessageDetailModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="messageDetailBody">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="closeMessageDetailModal()" class="btn btn-secondary">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ‰«ç æ¨¡æ€æ¡† -->
    <div id="scanModal" class="modal" onclick="closeModalOnBg(event, 'scanModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">æ¨¡æ‹Ÿæ‰«ç </h2>
                <button onclick="closeScanModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <div class="bg-gray-100 rounded-lg p-8 text-center mb-4">
                    <i class="fa fa-qrcode text-6xl text-gray-400 mb-4"></i>
                    <p class="text-gray-500">æ¨¡æ‹Ÿæ‰«ç åŠŸèƒ½</p>
                    <p class="text-xs text-gray-400 mt-2">åœ¨è°ƒè¯•æ¨¡å¼ä¸‹ï¼Œç‚¹å‡»ä¸‹æ–¹çš„åº“å­˜é¡¹è¿›è¡Œæ¨¡æ‹Ÿæ‰«ç </p>
                </div>
                <div id="scanStockList" class="max-h-64 overflow-y-auto space-y-2">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å…¥åº“æ¨¡æ€æ¡† -->
    <div id="addStockModal" class="modal" onclick="closeModalOnBg(event, 'addStockModal')">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <div class="modal-header">
                <h2 class="text-lg font-bold">å…¥åº“ç™»è®°</h2>
                <button onclick="closeAddStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addStockForm" onsubmit="handleStockIn(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡å‡†ç‰©è´¨åç§° <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ ‡å‡†ç‰©è´¨ç¼–å· <span class="text-red-500">*</span></label>
                            <input type="text" name="code" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ‰¹æ¬¡å·</label>
                            <input type="text" name="batchNumber" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å”¯ä¸€æ€§æ ‡è¯†æ–¹å¼</label>
                            <div class="flex space-x-4 mb-2">
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="auto" checked class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>è‡ªåŠ¨ç”Ÿæˆ</span>
                                </label>
                                <label class="flex items-center">
                                    <input type="radio" name="uniqueIdType" value="manual" class="mr-2" onchange="toggleUniqueIdInput()">
                                    <span>æ‰‹åŠ¨è¾“å…¥</span>
                                </label>
                            </div>
                            <input type="text" name="uniqueId" id="manualUniqueId" class="form-input hidden" placeholder="è¯·è¾“å…¥å”¯ä¸€æ€§æ ‡è¯†">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æµ“åº¦</label>
                                <input type="text" name="concentration" class="form-input" placeholder="å¦‚ï¼š100Î¼g/mL">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">ä¸ç¡®å®šåº¦</label>
                                <input type="text" name="uncertainty" class="form-input" placeholder="å¦‚ï¼š0.5%">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”Ÿäº§å‚å®¶</label>
                            <input type="text" name="manufacturer" class="form-input">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¨€é‡Šæ¡ä»¶</label>
                            <input type="text" name="storageCondition" class="form-input" placeholder="å¦‚ï¼šä½¿ç”¨å‰ç”¨çº¯æ°´ç¨€é‡Š">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æ•°é‡ <span class="text-red-500">*</span></label>
                                <input type="number" name="quantity" class="form-input" min="1" value="1" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">æœ‰æ•ˆæœŸ <span class="text-red-500">*</span></label>
                                <input type="date" name="expiryDate" class="form-input" required>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œäººå‘˜ <span class="text-red-500">*</span></label>
                            <select name="operator" id="stockInOperator" class="form-input" required>
                                <option value="">è¯·é€‰æ‹©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å›¾ç‰‡ä¸Šä¼ </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('stockImages').click()">
                                <input type="file" id="stockImages" multiple accept="image/*" class="hidden" onchange="previewImages(this, 'stockImagePreview')">
                                <div id="stockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="stockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆæœ€å¤š3å¼ ï¼‰</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddStockModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- å‡ºåº“æ¨¡æ€æ¡† -->
    <div id="outStockModal" class="modal" onclick="closeModalOnBg(event, 'outStockModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">å‡ºåº“ç™»è®°</h2>
                <button onclick="closeOutStockModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="outStockForm" onsubmit="handleStockOut(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ ‡å‡†ç‰©è´¨ <span class="text-red-500">*</span></label>
                            <select name="stockId" id="outStockSelect" class="form-input" required>
                                <option value="">è¯·é€‰æ‹©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ“ä½œäººå‘˜ <span class="text-red-500">*</span></label>
                            <select name="operator" id="stockOutOperator" class="form-input" required>
                                <option value="">è¯·é€‰æ‹©</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å‡ºåº“ç”¨é€”</label>
                            <input type="text" name="purpose" class="form-input" placeholder="è¯·è¾“å…¥å‡ºåº“ç”¨é€”">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å›¾ç‰‡ä¸Šä¼ </label>
                            <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center cursor-pointer hover:border-primary" onclick="document.getElementById('outStockImages').click()">
                                <input type="file" id="outStockImages" multiple accept="image/*" class="hidden" onchange="previewImages(this, 'outStockImagePreview')">
                                <div id="outStockImagePreview" class="image-preview-grid mb-2 hidden"></div>
                                <div id="outStockUploadPlaceholder">
                                    <i class="fa fa-camera text-3xl text-gray-400 mb-2"></i>
                                    <p class="text-gray-500 text-sm">ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡ï¼ˆæœ€å¤š3å¼ ï¼‰</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeOutStockModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-warning">ç¡®è®¤å‡ºåº“</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æ·»åŠ äººå‘˜æ¨¡æ€æ¡† -->
    <div id="addPersonnelModal" class="modal" onclick="closeModalOnBg(event, 'addPersonnelModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">æ·»åŠ äººå‘˜</h2>
                <button onclick="closeAddPersonnelModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="addPersonnelForm" onsubmit="handleAddPersonnel(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å§“å <span class="text-red-500">*</span></label>
                            <input type="text" name="name" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç”¨æˆ·å <span class="text-red-500">*</span></label>
                            <input type="text" name="username" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å¯†ç  <span class="text-red-500">*</span></label>
                            <input type="password" name="password" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">è§’è‰² <span class="text-red-500">*</span></label>
                            <select name="role" class="form-input" required>
                                <option value="admin">ç®¡ç†å‘˜</option>
                                <option value="user">æ™®é€šç”¨æˆ·</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeAddPersonnelModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ä¿®æ”¹å¯†ç æ¨¡æ€æ¡† -->
    <div id="changePasswordModal" class="modal" onclick="closeModalOnBg(event, 'changePasswordModal')">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="text-lg font-bold">ä¿®æ”¹å¯†ç </h2>
                <button onclick="closeChangePasswordModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div class="p-4">
                <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å½“å‰å¯†ç  <span class="text-red-500">*</span></label>
                            <input type="password" name="currentPassword" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">æ–°å¯†ç  <span class="text-red-500">*</span></label>
                            <input type="password" name="newPassword" class="form-input" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ç¡®è®¤æ–°å¯†ç  <span class="text-red-500">*</span></label>
                            <input type="password" name="confirmPassword" class="form-input" required>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" onclick="closeChangePasswordModal()" class="btn btn-secondary">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- æŸ¥çœ‹è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="viewDetailModal" class="modal" onclick="closeModalOnBg(event, 'viewDetailModal')">
        <div class="modal-content max-h-[90vh] overflow-y-auto">
            <div class="modal-header">
                <h2 class="text-lg font-bold">æ ‡å‡†ç‰©è´¨è¯¦æƒ…</h2>
                <button onclick="closeViewDetailModal()" class="text-white hover:text-gray-200">
                    <i class="fa fa-times text-xl"></i>
                </button>
            </div>
            <div id="viewDetailContent" class="p-4">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="imageViewerModal" class="image-viewer-modal" onclick="closeImageViewer()">
        <div class="image-viewer-content text-center">
            <button onclick="closeImageViewer()" class="absolute top-4 right-4 text-white text-2xl">
                <i class="fa fa-times"></i>
            </button>
            <img id="viewerImage" src="" alt="æŸ¥çœ‹å›¾ç‰‡">
            <p id="viewerCaption" class="text-white mt-4"></p>
        </div>
    </div>

    <script>
        // ==================== æ•°æ®å­˜å‚¨ ====================
        const Storage = {
            get(key) {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            },
            set(key, value) {
                localStorage.setItem(key, JSON.stringify(value));
            },
            remove(key) {
                localStorage.removeItem(key);
            }
        };

        // ==================== åˆå§‹åŒ–æ•°æ® ====================
        function initData() {
            // åˆå§‹åŒ–äººå‘˜æ•°æ®
            if (!Storage.get('personnel')) {
                Storage.set('personnel', [
                    { id: 1, name: 'ç³»ç»Ÿç®¡ç†å‘˜', username: 'admin', password: 'admin123', role: 'admin' },
                    { id: 2, name: 'å¼ ä¸‰', username: 'user1', password: 'user123', role: 'user' }
                ]);
            }
            
            // åˆå§‹åŒ–å…¶ä»–æ•°æ®
            if (!Storage.get('stock')) Storage.set('stock', []);
            if (!Storage.get('records')) Storage.set('records', []);
            if (!Storage.get('messages')) Storage.set('messages', []);
            if (!Storage.get('currentUser')) Storage.set('currentUser', null);
        }

        // ==================== å…¨å±€çŠ¶æ€ ====================
        let currentUser = null;
        let stockStatusChart = null;
        let currentStockTab = 'all';
        // ä¸´æ—¶å­˜å‚¨å›¾ç‰‡æ•°æ®
        const imageStorage = new Map();

        // ==================== ç™»å½•åŠŸèƒ½ ====================
        document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            
            const personnel = Storage.get('personnel') || [];
            const user = personnel.find(p => p.username === username && p.password === password);
            
            if (user) {
                currentUser = user;
                Storage.set('currentUser', user);
                if (document.getElementById('rememberMe').checked) {
                    Storage.set('rememberedUser', username);
                }
                showApp();
            } else {
                showLoginError('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
            }
        });

        function togglePassword() {
            const input = document.getElementById('loginPassword');
            const icon = document.getElementById('passwordToggleIcon');
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fa fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fa fa-eye';
            }
        }

        function showLoginError(msg) {
            const error = document.getElementById('loginError');
            error.textContent = msg;
            error.classList.remove('hidden');
            setTimeout(() => error.classList.add('hidden'), 3000);
        }

        // ==================== é¡µé¢åˆ‡æ¢ ====================
        function showApp() {
            document.getElementById('loginPage').classList.remove('active');
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯
            document.getElementById('currentUserName').textContent = currentUser.name;
            document.getElementById('settingUserName').textContent = currentUser.name;
            document.getElementById('settingUserRole').textContent = currentUser.role === 'admin' ? 'ç³»ç»Ÿç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·';
            document.getElementById('settingUserInitial').textContent = currentUser.name.charAt(0);
            
            // åˆå§‹åŒ–å›¾è¡¨
            initChart();
            
            // åˆ·æ–°æ•°æ®
            refreshAllData();
            
            // æ£€æŸ¥è®°ä½çš„ç”¨æˆ·å
            const remembered = Storage.get('rememberedUser');
            if (remembered) {
                document.getElementById('loginUsername').value = remembered;
            }
        }

        function switchPage(page) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(p => {
                p.classList.remove('active');
                p.style.display = 'none';
            });
            
            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const targetPage = document.getElementById(page + 'Page');
            if (targetPage) {
                targetPage.classList.add('active');
                targetPage.style.display = 'block';
            }
            
            // æ›´æ–°åº•éƒ¨å¯¼èˆª
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                const pages = ['dashboard', 'stock', 'personnel', 'settings'];
                if (pages[index] === page) {
                    item.classList.add('active');
                }
            });
            
            // æ›´æ–°æ ‡é¢˜
            const titles = {
                dashboard: 'æ ‡å‡†ç‰©è´¨ç®¡ç†',
                stock: 'åº“å­˜ç®¡ç†',
                personnel: 'äººå‘˜ç®¡ç†',
                records: 'æ“ä½œè®°å½•',
                settings: 'ç³»ç»Ÿè®¾ç½®'
            };
            document.querySelector('#pageTitle span').textContent = titles[page] || 'æ ‡å‡†ç‰©è´¨ç®¡ç†';
            
            // åˆ·æ–°æ•°æ®
            if (page === 'dashboard') refreshDashboard();
            if (page === 'stock') renderStockList();
            if (page === 'personnel') renderPersonnelList();
            if (page === 'records') renderRecordsList();
        }

        function logout() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ')) {
                currentUser = null;
                Storage.set('currentUser', null);
                document.getElementById('appContainer').style.display = 'none';
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('loginPage').classList.add('active');
                document.getElementById('loginForm').reset();
            }
        }

        // ==================== å›¾è¡¨åŠŸèƒ½ ====================
        function initChart() {
            const ctx = document.getElementById('stockStatusChart').getContext('2d');
            stockStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['æ­£å¸¸', 'å³å°†è¿‡æœŸ', 'å·²è¿‡æœŸ', 'åº“å­˜ä¸è¶³'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, usePointStyle: true }
                        }
                    }
                }
            });
        }

        // ==================== æ•°æ®åˆ·æ–° ====================
        function refreshAllData() {
            refreshDashboard();
            renderStockList();
            renderPersonnelList();
            renderRecordsList();
            updateNotificationBadge();
        }

        function refreshDashboard() {
            const stock = Storage.get('stock') || [];
            const records = Storage.get('records') || [];
            
            // è®¡ç®—ç»Ÿè®¡æ•°æ®
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0);
            document.getElementById('totalStock').textContent = totalStock;
            
            // è®¡ç®—è¿‘æ•ˆæœŸé¢„è­¦
            const today = new Date();
            const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiryWarning = stock.filter(item => {
                const expiryDate = new Date(item.expiryDate);
                return expiryDate <= thirtyDaysLater && expiryDate >= today;
            }).length;
            document.getElementById('expiryWarning').textContent = expiryWarning;
            
            // è®¡ç®—çŠ¶æ€åˆ†å¸ƒ
            let normal = 0, warning = 0, expired = 0, low = 0;
            stock.forEach(item => {
                const expiryDate = new Date(item.expiryDate);
                if (item.quantity <= 0) {
                    low++;
                } else if (expiryDate < today) {
                    expired++;
                } else if (expiryDate <= thirtyDaysLater) {
                    warning++;
                } else {
                    normal++;
                }
            });
            
            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normal, warning, expired, low];
                stockStatusChart.update();
            }
            
            // åŠ è½½æœ€è¿‘æ´»åŠ¨
            const recentActivities = document.getElementById('recentActivities');
            if (records.length === 0) {
                recentActivities.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>æš‚æ— æ´»åŠ¨è®°å½•</p></div>';
            } else {
                const sorted = records.sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
                recentActivities.innerHTML = sorted.map(record => {
                    const icons = { in: 'fa-archive text-primary', out: 'fa-sign-out text-success', warning: 'fa-exclamation-triangle text-warning' };
                    const actions = { in: 'å…¥åº“', out: 'å‡ºåº“', warning: 'é¢„è­¦' };
                    return `
                        <div class="activity-item">
                            <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                <i class="fa ${icons[record.type] || 'fa-info-circle'}"></i>
                            </div>
                            <div class="flex-1">
                                <p class="text-sm font-medium">${record.materialName} ${actions[record.type]}</p>
                                <p class="text-xs text-gray-500">${record.operator} Â· ${record.date}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ==================== åº“å­˜ç®¡ç† ====================
        function renderStockList() {
            const stock = Storage.get('stock') || [];
            const search = document.getElementById('stockSearchInput')?.value?.toLowerCase() || '';
            
            let filtered = stock;
            if (search) {
                filtered = filtered.filter(item => 
                    item.name.toLowerCase().includes(search) || 
                    item.code.toLowerCase().includes(search)
                );
            }
            
            // æŒ‰çŠ¶æ€è¿‡æ»¤
            if (currentStockTab !== 'all') {
                filtered = filtered.filter(item => item.status === currentStockTab);
            }
            
            // æŒ‰åç§°åˆ†ç»„
            const grouped = {};
            filtered.forEach(item => {
                if (!grouped[item.name]) {
                    grouped[item.name] = { items: [], total: 0 };
                }
                grouped[item.name].items.push(item);
                grouped[item.name].total += item.quantity;
            });
            
            const container = document.getElementById('stockList');
            if (Object.keys(grouped).length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-inbox text-4xl mb-2"></i><p>æš‚æ— åº“å­˜æ•°æ®</p></div>';
                return;
            }
            
            container.innerHTML = Object.entries(grouped).map(([name, group]) => {
                const statusCounts = { normal: 0, warning: 0, expired: 0, low: 0 };
                group.items.forEach(item => {
                    statusCounts[item.status] = (statusCounts[item.status] || 0) + item.quantity;
                });
                
                let statusLabels = '';
                if (statusCounts.normal > 0) statusLabels += `<span class="ml-2 status-badge status-normal">æ­£å¸¸:${statusCounts.normal}</span>`;
                if (statusCounts.warning > 0) statusLabels += `<span class="ml-2 status-badge status-warning">å³å°†:${statusCounts.warning}</span>`;
                if (statusCounts.expired > 0) statusLabels += `<span class="ml-2 status-badge status-danger">è¿‡æœŸ:${statusCounts.expired}</span>`;
                
                const groupId = 'group-' + name.replace(/\s+/g, '-');
                
                return `
                    <div class="stock-group">
                        <div class="stock-group-header flex justify-between items-center" onclick="toggleGroup('${groupId}')">
                            <div class="flex items-center">
                                <i class="fa fa-chevron-down mr-2 text-gray-400 transition-transform" id="arrow-${groupId}"></i>
                                <h3 class="font-semibold">${name}${statusLabels}</h3>
                            </div>
                            <span class="text-lg font-bold">${group.total}</span>
                        </div>
                        <div id="${groupId}" class="hidden">
                            ${group.items.map(item => `
                                <div class="stock-item">
                                    <div class="flex justify-between items-start">
                                        <div class="flex-1">
                                            <p class="text-sm font-medium">å”¯ä¸€æ€§æ ‡è¯†: ${item.uniqueId}</p>
                                            <p class="text-xs text-gray-500">æœ‰æ•ˆæœŸ: ${item.expiryDate} | æµ“åº¦: ${item.concentration || 'N/A'}</p>
                                            <span class="status-badge status-${item.status} mt-1">
                                                ${item.status === 'normal' ? 'æ­£å¸¸' : item.status === 'warning' ? 'å³å°†è¿‡æœŸ' : item.status === 'expired' ? 'å·²è¿‡æœŸ' : 'åº“å­˜ä¸è¶³'}
                                            </span>
                                        </div>
                                        <div class="flex space-x-1">
                                            <button onclick="viewStockDetail(${item.id})" class="px-2 py-1 bg-info text-white text-xs rounded">æŸ¥çœ‹</button>
                                            <button onclick="quickOut(${item.id})" class="px-2 py-1 bg-warning text-white text-xs rounded">å‡ºåº“</button>
                                            <button onclick="deleteStock(${item.id})" class="px-2 py-1 bg-danger text-white text-xs rounded">åˆ é™¤</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function switchStockTab(tab, element) {
            currentStockTab = tab;
            document.querySelectorAll('.tab-nav-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            renderStockList();
        }

        function toggleGroup(id) {
            const el = document.getElementById(id);
            const arrow = document.getElementById('arrow-' + id);
            if (el.classList.contains('hidden')) {
                el.classList.remove('hidden');
                arrow.style.transform = 'rotate(180deg)';
            } else {
                el.classList.add('hidden');
                arrow.style.transform = 'rotate(0)';
            }
        }

        // ==================== å…¥åº“åŠŸèƒ½ ====================
        function showAddStockModal() {
            document.getElementById('addStockModal').classList.add('show');
            // åŠ è½½æ“ä½œäººå‘˜
            const operators = document.getElementById('stockInOperator');
            operators.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const personnel = Storage.get('personnel') || [];
            personnel.forEach(p => {
                operators.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸º30å¤©å
            const date = new Date();
            date.setDate(date.getDate() + 30);
            document.querySelector('input[name="expiryDate"]').value = date.toISOString().split('T')[0];
        }

        function closeAddStockModal() {
            document.getElementById('addStockModal').classList.remove('show');
            document.getElementById('addStockForm').reset();
            document.getElementById('stockImagePreview').innerHTML = '';
            document.getElementById('stockImagePreview').classList.add('hidden');
            document.getElementById('stockUploadPlaceholder').classList.remove('hidden');
        }

        function toggleUniqueIdInput() {
            const type = document.querySelector('input[name="uniqueIdType"]:checked').value;
            const input = document.getElementById('manualUniqueId');
            if (type === 'manual') {
                input.classList.remove('hidden');
                input.required = true;
            } else {
                input.classList.add('hidden');
                input.required = false;
            }
        }

        function previewImages(input, previewId) {
            const preview = document.getElementById(previewId);
            const placeholder = preview.nextElementSibling;
            
            if (input.files.length > 3) {
                alert('æœ€å¤šåªèƒ½ä¸Šä¼ 3å¼ å›¾ç‰‡');
                input.value = '';
                return;
            }
            
            preview.innerHTML = '';
            preview.classList.remove('hidden');
            placeholder.classList.add('hidden');
            
            Array.from(input.files).forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // å­˜å‚¨å›¾ç‰‡æ•°æ®
                    const imageId = 'img_' + Date.now() + '_' + index;
                    imageStorage.set(imageId, e.target.result);
                    
                    preview.innerHTML += `
                        <div class="image-preview-item" data-image-id="${imageId}">
                            <img src="${e.target.result}" alt="">
                            <button type="button" onclick="removeImage(this, '${previewId}')" class="absolute -top-1 -right-1 w-5 h-5 bg-red-500 text-white rounded-full text-xs">
                                <i class="fa fa-times"></i>
                            </button>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            });
        }

        function removeImage(btn, previewId) {
            const item = btn.closest('.image-preview-item');
            const imageId = item.dataset.imageId;
            imageStorage.delete(imageId);
            item.remove();
            
            const preview = document.getElementById(previewId);
            const placeholder = preview.nextElementSibling;
            if (preview.children.length === 0) {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function handleStockIn(e) {
            e.preventDefault();
            const form = e.target;
            const formData = new FormData(form);
            
            const stock = Storage.get('stock') || [];
            const quantity = parseInt(formData.get('quantity')) || 1;
            const baseTime = Date.now();
            
            // æ”¶é›†å›¾ç‰‡æ•°æ®
            const images = [];
            const previewItems = document.querySelectorAll('#stockImagePreview .image-preview-item');
            previewItems.forEach(item => {
                const imageId = item.dataset.imageId;
                const imageData = imageStorage.get(imageId);
                if (imageData) {
                    images.push({
                        id: imageId,
                        data: imageData,
                        name: 'å…¥åº“å›¾ç‰‡_' + images.length
                    });
                }
            });
            
            // ä¸ºæ¯ç“¶åˆ›å»ºè®°å½•
            const addedItems = [];
            for (let i = 0; i < quantity; i++) {
                const uniqueId = formData.get('uniqueIdType') === 'manual' 
                    ? `${formData.get('uniqueId')}-${i + 1}`
                    : `${formData.get('batchNumber') || 'BATCH'}-${baseTime.toString().slice(-4)}-${String(i + 1).padStart(2, '0')}`;
                
                // è®¡ç®—çŠ¶æ€
                const today = new Date();
                const expiry = new Date(formData.get('expiryDate'));
                const diffDays = Math.ceil((expiry - today) / (1000 * 60 * 60 * 24));
                
                let status = 'normal';
                if (diffDays < 0) status = 'expired';
                else if (diffDays <= 30) status = 'warning';
                
                const newItem = {
                    id: baseTime + i,
                    name: formData.get('name'),
                    code: formData.get('code'),
                    batchNumber: formData.get('batchNumber'),
                    uniqueId: uniqueId,
                    manufacturer: formData.get('manufacturer'),
                    concentration: formData.get('concentration'),
                    uncertainty: formData.get('uncertainty'),
                    storageCondition: formData.get('storageCondition'),
                    quantity: 1,
                    expiryDate: formData.get('expiryDate'),
                    operator: formData.get('operator'),
                    status: status,
                    images: i === 0 ? images : [], // åªæœ‰ç¬¬ä¸€ç“¶å¸¦å›¾ç‰‡ï¼Œé¿å…é‡å¤
                    createdAt: new Date().toISOString()
                };
                
                stock.push(newItem);
                addedItems.push(newItem);
            }
            
            Storage.set('stock', stock);
            
            // æ·»åŠ è®°å½•ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
            addRecord('in', formData.get('name'), quantity, formData.get('operator'), 
                `æ‰¹æ¬¡å·: ${formData.get('batchNumber') || 'N/A'}ï¼Œå…¥åº“${quantity}ç“¶`, images);
            
            closeAddStockModal();
            refreshAllData();
            alert(`å…¥åº“æˆåŠŸï¼å·²æ·»åŠ ${quantity}ç“¶æ ‡å‡†ç‰©è´¨`);
        }

        // ==================== å‡ºåº“åŠŸèƒ½ ====================
        function showOutStockModal() {
            document.getElementById('outStockModal').classList.add('show');
            loadOutStockOptions();
            loadOutOperators();
        }

        function closeOutStockModal() {
            document.getElementById('outStockModal').classList.remove('show');
            document.getElementById('outStockForm').reset();
            document.getElementById('outStockImagePreview').innerHTML = '';
            document.getElementById('outStockImagePreview').classList.add('hidden');
            document.getElementById('outStockUploadPlaceholder').classList.remove('hidden');
        }

        function loadOutStockOptions() {
            const select = document.getElementById('outStockSelect');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const stock = Storage.get('stock') || [];
            stock.forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name}ï¼ˆ${item.uniqueId}ï¼‰</option>`;
            });
        }

        function loadOutOperators() {
            const select = document.getElementById('stockOutOperator');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©</option>';
            const personnel = Storage.get('personnel') || [];
            personnel.forEach(p => {
                select.innerHTML += `<option value="${p.name}">${p.name}</option>`;
            });
        }

        function quickOut(id) {
            showOutStockModal();
            document.getElementById('outStockSelect').value = id;
        }

        function handleStockOut(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const stockId = parseInt(formData.get('stockId'));
            
            let stock = Storage.get('stock') || [];
            const itemIndex = stock.findIndex(s => s.id === stockId);
            
            if (itemIndex === -1) {
                alert('æœªæ‰¾åˆ°è¯¥æ ‡å‡†ç‰©è´¨');
                return;
            }
            
            const item = stock[itemIndex];
            
            // æ”¶é›†å‡ºåº“å›¾ç‰‡
            const images = [];
            const previewItems = document.querySelectorAll('#outStockImagePreview .image-preview-item');
            previewItems.forEach(item => {
                const imageId = item.dataset.imageId;
                const imageData = imageStorage.get(imageId);
                if (imageData) {
                    images.push({
                        id: imageId,
                        data: imageData,
                        name: 'å‡ºåº“å›¾ç‰‡_' + images.length
                    });
                }
            });
            
            if (confirm(`ç¡®å®šè¦å°† ${item.name}ï¼ˆ${item.uniqueId}ï¼‰å‡ºåº“å—ï¼Ÿ`)) {
                // ç§»é™¤åº“å­˜
                stock.splice(itemIndex, 1);
                Storage.set('stock', stock);
                
                // æ·»åŠ è®°å½•ï¼ˆåŒ…å«å›¾ç‰‡ï¼‰
                addRecord('out', item.name, 1, formData.get('operator'), 
                    `å”¯ä¸€æ€§æ ‡è¯†: ${item.uniqueId}ï¼Œç”¨é€”: ${formData.get('purpose') || 'æœªå¡«å†™'}`, images);
                
                closeOutStockModal();
                refreshAllData();
                alert('å‡ºåº“æˆåŠŸï¼');
            }
        }

        function deleteStock(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ ‡å‡†ç‰©è´¨å—ï¼Ÿ')) return;
            let stock = Storage.get('stock') || [];
            stock = stock.filter(s => s.id !== id);
            Storage.set('stock', stock);
            refreshAllData();
            alert('åˆ é™¤æˆåŠŸï¼');
        }

        function viewStockDetail(id) {
            const stock = Storage.get('stock') || [];
            const item = stock.find(s => s.id === id);
            if (!item) return;
            
            const statusText = {
                normal: 'æ­£å¸¸',
                warning: 'å³å°†è¿‡æœŸ',
                expired: 'å·²è¿‡æœŸ',
                low: 'åº“å­˜ä¸è¶³'
            }[item.status];
            
            // ç”ŸæˆäºŒç»´ç æ•°æ®
            const qrData = JSON.stringify({
                åç§°: item.name,
                ç¼–å·: item.code,
                æ‰¹æ¬¡: item.batchNumber,
                å”¯ä¸€æ ‡è¯†: item.uniqueId,
                æœ‰æ•ˆæœŸ: item.expiryDate,
                çŠ¶æ€: statusText
            });
            
            // æ˜¾ç¤ºå›¾ç‰‡
            let imagesHtml = '';
            if (item.images && item.images.length > 0) {
                imagesHtml = `
                    <div class="mb-4">
                        <h3 class="text-lg font-semibold mb-2">ç›¸å…³å›¾ç‰‡</h3>
                        <div class="record-images">
                            ${item.images.map((img, idx) => `
                                <div class="record-image-item" onclick="viewImage('${img.data}', 'å…¥åº“å›¾ç‰‡ ${idx + 1}')">
                                    <img src="${img.data}" alt="å…¥åº“å›¾ç‰‡">
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('viewDetailContent').innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div><span class="text-gray-500">æ ‡å‡†ç‰©è´¨åç§°:</span> ${item.name}</div>
                        <div><span class="text-gray-500">æ ‡å‡†ç‰©è´¨ç¼–å·:</span> ${item.code}</div>
                        <div><span class="text-gray-500">æ‰¹æ¬¡å·:</span> ${item.batchNumber || 'N/A'}</div>
                        <div><span class="text-gray-500">å”¯ä¸€æ€§æ ‡è¯†:</span> ${item.uniqueId}</div>
                        <div><span class="text-gray-500">ç”Ÿäº§å‚å®¶:</span> ${item.manufacturer || 'N/A'}</div>
                        <div><span class="text-gray-500">æµ“åº¦:</span> ${item.concentration || 'N/A'}</div>
                        <div><span class="text-gray-500">ä¸ç¡®å®šåº¦:</span> ${item.uncertainty || 'N/A'}</div>
                        <div><span class="text-gray-500">ç¨€é‡Šæ¡ä»¶:</span> ${item.storageCondition || 'N/A'}</div>
                        <div><span class="text-gray-500">æ•°é‡:</span> ${item.quantity}</div>
                        <div><span class="text-gray-500">æœ‰æ•ˆæœŸ:</span> ${item.expiryDate}</div>
                        <div><span class="text-gray-500">çŠ¶æ€:</span> <span class="status-badge status-${item.status}">${statusText}</span></div>
                        <div><span class="text-gray-500">åˆ›å»ºæ—¶é—´:</span> ${new Date(item.createdAt).toLocaleString('zh-CN')}</div>
                    </div>
                    
                    ${imagesHtml}
                    
                    <div class="text-center">
                        <canvas id="detailQRCode"></canvas>
                        <p class="text-xs text-gray-500 mt-2">æ‰«æäºŒç»´ç æŸ¥çœ‹è¯¦æƒ…</p>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="quickOut(${item.id}); closeViewDetailModal();" class="flex-1 btn btn-warning">å‡ºåº“</button>
                        <button onclick="closeViewDetailModal()" class="flex-1 btn btn-secondary">å…³é—­</button>
                    </div>
                </div>
            `;
            
            document.getElementById('viewDetailModal').classList.add('show');
            
            // ç”ŸæˆäºŒç»´ç 
            setTimeout(() => {
                QRCode.toCanvas(document.getElementById('detailQRCode'), qrData, {
                    width: 200,
                    margin: 1
                });
            }, 100);
        }

        function closeViewDetailModal() {
            document.getElementById('viewDetailModal').classList.remove('show');
        }

        // ==================== å›¾ç‰‡æŸ¥çœ‹åŠŸèƒ½ ====================
        function viewImage(imageData, caption) {
            document.getElementById('viewerImage').src = imageData;
            document.getElementById('viewerCaption').textContent = caption;
            document.getElementById('imageViewerModal').classList.add('show');
        }

        function closeImageViewer() {
            document.getElementById('imageViewerModal').classList.remove('show');
        }

        // ==================== è®°å½•ç®¡ç† ====================
        function addRecord(type, materialName, quantity, operator, note, images = []) {
            const records = Storage.get('records') || [];
            records.push({
                id: Date.now(),
                type,
                materialName,
                quantity,
                operator,
                date: new Date().toLocaleString('zh-CN'),
                note,
                images: images || []
            });
            Storage.set('records', records);
        }

        function renderRecordsList() {
            const records = Storage.get('records') || [];
            const search = document.getElementById('recordsSearchInput')?.value?.toLowerCase() || '';
            
            let filtered = records;
            if (search) {
                filtered = filtered.filter(r => 
                    r.materialName.toLowerCase().includes(search) || 
                    r.operator.toLowerCase().includes(search)
                );
            }
            
            // æŒ‰æ—¶é—´å€’åº
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const container = document.getElementById('recordsList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-history text-4xl mb-2"></i><p>æš‚æ— æ“ä½œè®°å½•</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(record => {
                const icons = { in: 'fa-archive text-blue-500', out: 'fa-sign-out text-green-500', warning: 'fa-exclamation-triangle text-yellow-500' };
                const types = { in: 'å…¥åº“', out: 'å‡ºåº“', warning: 'é¢„è­¦' };
                const badges = { in: 'bg-blue-100 text-blue-800', out: 'bg-green-100 text-green-800', warning: 'bg-yellow-100 text-yellow-800' };
                
                // æ¸²æŸ“å›¾ç‰‡
                let imagesHtml = '';
                if (record.images && record.images.length > 0) {
                    imagesHtml = `
                        <div class="record-images mt-3">
                            ${record.images.map((img, idx) => `
                                <div class="record-image-item" onclick="viewImage('${img.data}', '${types[record.type]}å›¾ç‰‡ ${idx + 1}')">
                                    <img src="${img.data}" alt="è®°å½•å›¾ç‰‡">
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                return `
                    <div class="record-item">
                        <div class="flex justify-between items-start">
                            <div class="flex items-center">
                                <div class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center mr-3">
                                    <i class="fa ${icons[record.type]}"></i>
                                </div>
                                <div>
                                    <h3 class="font-semibold">${record.materialName}</h3>
                                    <p class="text-sm text-gray-500">${record.operator} Â· ${record.date}</p>
                                </div>
                            </div>
                            <span class="status-badge ${badges[record.type] || 'bg-gray-100 text-gray-600'}">${types[record.type]}</span>
                        </div>
                        <div class="mt-2">
                            <p class="text-sm">æ•°é‡: ${record.quantity}</p>
                            <p class="text-sm text-gray-500">å¤‡æ³¨: ${record.note}</p>
                            ${imagesHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ==================== äººå‘˜ç®¡ç† ====================
        function renderPersonnelList() {
            const personnel = Storage.get('personnel') || [];
            const search = document.getElementById('personnelSearchInput')?.value?.toLowerCase() || '';
            
            let filtered = personnel;
            if (search) {
                filtered = filtered.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.username.toLowerCase().includes(search)
                );
            }
            
            const container = document.getElementById('personnelList');
            if (filtered.length === 0) {
                container.innerHTML = '<div class="empty-state"><i class="fa fa-users text-4xl mb-2"></i><p>æš‚æ— äººå‘˜æ•°æ®</p></div>';
                return;
            }
            
            container.innerHTML = filtered.map(person => `
                <div class="personnel-item">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-semibold">${person.name}</h3>
                            <p class="text-sm text-gray-500">ç”¨æˆ·å: ${person.username}</p>
                        </div>
                        <span class="status-badge ${person.role === 'admin' ? 'bg-blue-100 text-blue-800' : 'bg-green-100 text-green-800'}">
                            ${person.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·'}
                        </span>
                    </div>
                    <div class="flex justify-end space-x-2 mt-3">
                        ${person.id !== currentUser?.id ? `
                            <button onclick="deletePersonnel(${person.id})" class="text-danger text-sm">
                                <i class="fa fa-trash"></i> åˆ é™¤
                            </button>
                        ` : '<span class="text-xs text-gray-400">å½“å‰ç”¨æˆ·</span>'}
                    </div>
                </div>
            `).join('');
        }

        function showAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.add('show');
        }

        function closeAddPersonnelModal() {
            document.getElementById('addPersonnelModal').classList.remove('show');
            document.getElementById('addPersonnelForm').reset();
        }

        function handleAddPersonnel(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            const personnel = Storage.get('personnel') || [];
            
            // æ£€æŸ¥ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
            if (personnel.some(p => p.username === formData.get('username'))) {
                alert('ç”¨æˆ·åå·²å­˜åœ¨ï¼');
                return;
            }
            
            personnel.push({
                id: Date.now(),
                name: formData.get('name'),
                username: formData.get('username'),
                password: formData.get('password'),
                role: formData.get('role')
            });
            
            Storage.set('personnel', personnel);
            closeAddPersonnelModal();
            renderPersonnelList();
            alert('äººå‘˜æ·»åŠ æˆåŠŸï¼');
        }

        function deletePersonnel(id) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººå‘˜å—ï¼Ÿ')) return;
            if (id === currentUser?.id) {
                alert('ä¸èƒ½åˆ é™¤å½“å‰ç™»å½•çš„ç”¨æˆ·ï¼');
                return;
            }
            let personnel = Storage.get('personnel') || [];
            personnel = personnel.filter(p => p.id !== id);
            Storage.set('personnel', personnel);
            renderPersonnelList();
            alert('åˆ é™¤æˆåŠŸï¼');
        }

        // ==================== æ¶ˆæ¯åŠŸèƒ½ï¼ˆå·²ä¿®å¤ï¼‰ ====================
        function openNotificationModal() {
            document.getElementById('notificationModal').classList.add('show');
            // é»˜è®¤æ˜¾ç¤ºæ¶ˆæ¯åˆ—è¡¨
            switchMessageTab('messages', document.querySelector('#notificationModal .tab-btn'));
            renderMessages();
            loadMessageRecipients();
        }

        function closeNotificationModal() {
            document.getElementById('notificationModal').classList.remove('show');
        }

        function switchMessageTab(tab, element) {
            document.querySelectorAll('#notificationModal .tab-btn').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            
            const messagesContent = document.getElementById('messagesContent');
            const composeContent = document.getElementById('composeContent');
            
            if (tab === 'messages') {
                messagesContent.classList.remove('hidden');
                composeContent.classList.add('hidden');
                renderMessages();
            } else {
                messagesContent.classList.add('hidden');
                composeContent.classList.remove('hidden');
            }
        }

        function renderMessages() {
            const messages = Storage.get('messages') || [];
            const container = document.getElementById('messagesContent');
            
            // è·å–å½“å‰ç”¨æˆ·åº”è¯¥æ”¶åˆ°çš„æ¶ˆæ¯
            const myMessages = messages.filter(msg => 
                msg.recipient === 'all' || 
                msg.recipient === currentUser?.username ||
                msg.sender === currentUser?.name // ä¹Ÿæ˜¾ç¤ºè‡ªå·±å‘é€çš„
            );
            
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            myMessages.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            if (myMessages.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fa fa-inbox text-4xl mb-2"></i>
                        <p>æš‚æ— æ¶ˆæ¯</p>
                        <p class="text-sm text-gray-400 mt-2">ç‚¹å‡»"å‘é€æ¶ˆæ¯"å¼€å§‹æ²Ÿé€š</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = myMessages.map(msg => {
                const isUnread = !msg.readBy?.includes(currentUser?.username);
                const isSentByMe = msg.sender === currentUser?.name;
                
                return `
                    <div class="message-item ${isUnread ? 'unread' : 'read'}" onclick="showMessageDetail('${msg.id}')">
                        <div class="message-header">
                            <div class="message-sender">
                                <i class="fa ${isSentByMe ? 'fa-send text-blue-500' : 'fa-user-circle text-gray-400'}"></i>
                                ${isSentByMe ? 'æˆ‘' : msg.sender}
                                ${isUnread && !isSentByMe ? '<span class="unread-badge">æ–°æ¶ˆæ¯</span>' : ''}
                            </div>
                            <span class="message-time">${msg.date}</span>
                        </div>
                        <div class="message-content">${escapeHtml(msg.content)}</div>
                        <div class="message-to">
                            <i class="fa ${msg.recipient === 'all' ? 'fa-users' : 'fa-user'} mr-1"></i>
                            ${msg.recipient === 'all' ? 'å‘é€ç»™æ‰€æœ‰äºº' : `å‘é€ç»™: ${msg.recipientName || msg.recipient}`}
                            ${isSentByMe ? '<span class="text-blue-500 ml-2"><i class="fa fa-check"></i> å·²å‘é€</span>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadMessageRecipients() {
            const select = document.getElementById('messageRecipient');
            select.innerHTML = '<option value="">è¯·é€‰æ‹©æ¥æ”¶äºº</option><option value="all">æ‰€æœ‰äºº</option>';
            const personnel = Storage.get('personnel') || [];
            personnel.forEach(p => {
                if (p.id !== currentUser?.id) {
                    select.innerHTML += `<option value="${p.username}" data-name="${p.name}">${p.name} (${p.username})</option>`;
                }
            });
        }

        function sendMessage(e) {
            e.preventDefault();
            
            const recipientSelect = document.getElementById('messageRecipient');
            const contentInput = document.getElementById('messageContent');
            
            const recipient = recipientSelect.value;
            const content = contentInput.value.trim();
            
            if (!recipient) {
                alert('è¯·é€‰æ‹©æ¥æ”¶äººï¼');
                return;
            }
            
            if (!content) {
                alert('è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹ï¼');
                return;
            }
            
            // è·å–æ¥æ”¶äººå§“å
            const selectedOption = recipientSelect.options[recipientSelect.selectedIndex];
            const recipientName = recipient === 'all' ? 'æ‰€æœ‰äºº' : selectedOption.dataset.name;
            
            const messages = Storage.get('messages') || [];
            const newMessage = {
                id: Date.now().toString(),
                sender: currentUser.name,
                senderUsername: currentUser.username,
                recipient: recipient,
                recipientName: recipientName,
                content: content,
                date: new Date().toLocaleString('zh-CN'),
                timestamp: Date.now(),
                readBy: [currentUser.username] // å‘é€è€…è‡ªåŠ¨æ ‡è®°ä¸ºå·²è¯»
            };
            
            messages.push(newMessage);
            Storage.set('messages', messages);
            
            // æ¸…ç©ºè¡¨å•
            contentInput.value = '';
            recipientSelect.value = '';
            
            // åˆ‡æ¢åˆ°æ¶ˆæ¯åˆ—è¡¨å¹¶åˆ·æ–°
            const messagesTab = document.querySelector('#notificationModal .tab-btn');
            switchMessageTab('messages', messagesTab);
            
            // æ›´æ–°æœªè¯»æ•°
            updateNotificationBadge();
            
            alert('æ¶ˆæ¯å‘é€æˆåŠŸï¼');
        }

        function showMessageDetail(msgId) {
            const messages = Storage.get('messages') || [];
            const msg = messages.find(m => m.id === msgId);
            
            if (!msg) return;
            
            // æ ‡è®°ä¸ºå·²è¯»
            if (!msg.readBy) msg.readBy = [];
            if (!msg.readBy.includes(currentUser.username)) {
                msg.readBy.push(currentUser.username);
                Storage.set('messages', messages);
                renderMessages();
                updateNotificationBadge();
            }
            
            const isSentByMe = msg.sender === currentUser?.name;
            
            document.getElementById('messageDetailBody').innerHTML = `
                <div class="space-y-4">
                    <div class="flex items-center justify-between pb-3 border-b border-gray-200">
                        <div>
                            <p class="text-sm text-gray-500">å‘ä»¶äºº</p>
                            <p class="font-semibold text-lg">${isSentByMe ? 'æˆ‘' : msg.sender}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-gray-500">æ—¶é—´</p>
                            <p class="font-medium">${msg.date}</p>
                        </div>
                    </div>
                    
                    <div>
                        <p class="text-sm text-gray-500 mb-2">æ¥æ”¶äºº</p>
                        <p class="font-medium">
                            <i class="fa ${msg.recipient === 'all' ? 'fa-users' : 'fa-user'} mr-2"></i>
                            ${msg.recipientName || (msg.recipient === 'all' ? 'æ‰€æœ‰äºº' : msg.recipient)}
                        </p>
                    </div>
                    
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <p class="text-sm text-gray-500 mb-2">æ¶ˆæ¯å†…å®¹</p>
                        <p class="text-gray-800 whitespace-pre-wrap">${escapeHtml(msg.content)}</p>
                    </div>
                    
                    <div class="text-sm text-gray-400 text-center">
                        ${msg.readBy.length > 1 ? `<i class="fa fa-check-circle text-green-500 mr-1"></i> å·²è¯» (${msg.readBy.length}äºº)` : '<i class="fa fa-clock-o mr-1"></i> å¾…å¯¹æ–¹é˜…è¯»'}
                    </div>
                </div>
            `;
            
            document.getElementById('messageDetailModal').classList.add('show');
        }

        function closeMessageDetail(e) {
            if (e.target.id === 'messageDetailModal') {
                closeMessageDetailModal();
            }
        }

        function closeMessageDetailModal() {
            document.getElementById('messageDetailModal').classList.remove('show');
        }

        function updateNotificationBadge() {
            const messages = Storage.get('messages') || [];
            // åªç»Ÿè®¡å‘é€ç»™å½“å‰ç”¨æˆ·ä¸”æœªè¯»çš„æ¶ˆæ¯
            const unread = messages.filter(msg => 
                (msg.recipient === currentUser?.username || msg.recipient === 'all') && 
                !msg.readBy?.includes(currentUser?.username) &&
                msg.sender !== currentUser?.name // ä¸ç»Ÿè®¡è‡ªå·±å‘é€çš„
            ).length;
            
            const badge = document.getElementById('notificationCount');
            if (unread > 0) {
                badge.textContent = unread > 99 ? '99+' : unread;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        // ==================== æ‰«ç åŠŸèƒ½ ====================
        function showScanModal() {
            document.getElementById('scanModal').classList.add('show');
            // åŠ è½½åº“å­˜åˆ—è¡¨ä¾›æ¨¡æ‹Ÿæ‰«ç 
            const stock = Storage.get('stock') || [];
            const container = document.getElementById('scanStockList');
            
            if (stock.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">æš‚æ— åº“å­˜å¯æ‰«ç </p>';
            } else {
                container.innerHTML = stock.map(item => `
                    <div class="p-3 bg-gray-50 rounded cursor-pointer hover:bg-gray-100" onclick="simulateScan(${item.id})">
                        <p class="font-medium">${item.name}</p>
                        <p class="text-sm text-gray-500">${item.uniqueId}</p>
                    </div>
                `).join('');
            }
        }

        function closeScanModal() {
            document.getElementById('scanModal').classList.remove('show');
        }

        function simulateScan(id) {
            const stock = Storage.get('stock') || [];
            const item = stock.find(s => s.id === id);
            if (item) {
                closeScanModal();
                alert(`æ‰«ç æˆåŠŸï¼\nåç§°ï¼š${item.name}\nç¼–å·ï¼š${item.code}\nå”¯ä¸€æ ‡è¯†ï¼š${item.uniqueId}`);
                if (confirm('æ˜¯å¦ç«‹å³å‡ºåº“ï¼Ÿ')) {
                    quickOut(id);
                } else {
                    viewStockDetail(id);
                }
            }
        }

        // ==================== è®¾ç½®åŠŸèƒ½ ====================
        function showChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.add('show');
        }

        function closeChangePasswordModal() {
            document.getElementById('changePasswordModal').classList.remove('show');
            document.getElementById('changePasswordForm').reset();
        }

        function handleChangePassword(e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            
            if (formData.get('currentPassword') !== currentUser.password) {
                alert('å½“å‰å¯†ç é”™è¯¯ï¼');
                return;
            }
            
            if (formData.get('newPassword') !== formData.get('confirmPassword')) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„æ–°å¯†ç ä¸ä¸€è‡´ï¼');
                return;
            }
            
            // æ›´æ–°å¯†ç 
            const personnel = Storage.get('personnel') || [];
            const user = personnel.find(p => p.id === currentUser.id);
            if (user) {
                user.password = formData.get('newPassword');
                currentUser.password = formData.get('newPassword');
                Storage.set('personnel', personnel);
                Storage.set('currentUser', currentUser);
                closeChangePasswordModal();
                alert('å¯†ç ä¿®æ”¹æˆåŠŸï¼');
            }
        }

        // ==================== Excelå¯¼å‡ºåŠŸèƒ½ ====================
        function exportData() {
            const stock = Storage.get('stock') || [];
            const records = Storage.get('records') || [];
            const personnel = Storage.get('personnel') || [];
            
            // åˆ›å»ºå·¥ä½œç°¿
            const wb = XLSX.utils.book_new();
            wb.Props = {
                Title: "æ ‡å‡†ç‰©è´¨ç®¡ç†ç³»ç»Ÿæ•°æ®",
                Subject: "æ•°æ®å¯¼å‡º",
                Author: "æ ‡å‡†ç‰©è´¨ç®¡ç†åŠ©æ‰‹",
                CreatedDate: new Date()
            };
            
            // 1. åº“å­˜æ•°æ®è¡¨
            const stockData = stock.map(item => ({
                'æ ‡å‡†ç‰©è´¨åç§°': item.name,
                'æ ‡å‡†ç‰©è´¨ç¼–å·': item.code,
                'æ‰¹æ¬¡å·': item.batchNumber || '',
                'å”¯ä¸€æ€§æ ‡è¯†': item.uniqueId,
                'ç”Ÿäº§å‚å®¶': item.manufacturer || '',
                'æµ“åº¦': item.concentration || '',
                'ä¸ç¡®å®šåº¦': item.uncertainty || '',
                'ç¨€é‡Šæ¡ä»¶': item.storageCondition || '',
                'æ•°é‡': item.quantity,
                'æœ‰æ•ˆæœŸ': item.expiryDate,
                'çŠ¶æ€': item.status === 'normal' ? 'æ­£å¸¸' : item.status === 'warning' ? 'å³å°†è¿‡æœŸ' : item.status === 'expired' ? 'å·²è¿‡æœŸ' : 'åº“å­˜ä¸è¶³',
                'æ“ä½œäººå‘˜': item.operator,
                'åˆ›å»ºæ—¶é—´': new Date(item.createdAt).toLocaleString('zh-CN'),
                'å›¾ç‰‡æ•°é‡': item.images ? item.images.length : 0
            }));
            
            const stockWS = XLSX.utils.json_to_sheet(stockData);
            // è®¾ç½®åˆ—å®½
            stockWS['!cols'] = [
                {wch: 20}, {wch: 15}, {wch: 15}, {wch: 20}, {wch: 20},
                {wch: 15}, {wch: 12}, {wch: 20}, {wch: 8}, {wch: 12},
                {wch: 12}, {wch: 12}, {wch: 20}, {wch: 10}
            ];
            XLSX.utils.book_append_sheet(wb, stockWS, "åº“å­˜æ•°æ®");
            
            // 2. æ“ä½œè®°å½•è¡¨
            const recordsData = records.map(record => ({
                'æ“ä½œç±»å‹': record.type === 'in' ? 'å…¥åº“' : record.type === 'out' ? 'å‡ºåº“' : 'é¢„è­¦',
                'æ ‡å‡†ç‰©è´¨åç§°': record.materialName,
                'æ•°é‡': record.quantity,
                'æ“ä½œäººå‘˜': record.operator,
                'æ“ä½œæ—¶é—´': record.date,
                'å¤‡æ³¨': record.note,
                'å›¾ç‰‡æ•°é‡': record.images ? record.images.length : 0
            }));
            
            const recordsWS = XLSX.utils.json_to_sheet(recordsData);
            recordsWS['!cols'] = [
                {wch: 12}, {wch: 20}, {wch: 8}, {wch: 12}, {wch: 20}, {wch: 40}, {wch: 10}
            ];
            XLSX.utils.book_append_sheet(wb, recordsWS, "æ“ä½œè®°å½•");
            
            // 3. äººå‘˜æ•°æ®è¡¨
            const personnelData = personnel.map(p => ({
                'å§“å': p.name,
                'ç”¨æˆ·å': p.username,
                'è§’è‰²': p.role === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç”¨æˆ·',
                'å¯†ç ': '******' // å‡ºäºå®‰å…¨è€ƒè™‘ï¼Œä¸æ˜¾ç¤ºçœŸå®å¯†ç 
            }));
            
            const personnelWS = XLSX.utils.json_to_sheet(personnelData);
            personnelWS['!cols'] = [{wch: 15}, {wch: 15}, {wch: 12}, {wch: 10}];
            XLSX.utils.book_append_sheet(wb, personnelWS, "äººå‘˜ä¿¡æ¯");
            
            // 4. ç»Ÿè®¡æ±‡æ€»è¡¨
            const today = new Date();
            const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            let normal = 0, warning = 0, expired = 0, low = 0;
            stock.forEach(item => {
                const expiryDate = new Date(item.expiryDate);
                if (item.quantity <= 0) low++;
                else if (expiryDate < today) expired++;
                else if (expiryDate <= thirtyDaysLater) warning++;
                else normal++;
            });
            
            const summaryData = [
                { 'ç»Ÿè®¡é¡¹ç›®': 'æ€»åº“å­˜æ•°é‡', 'æ•°å€¼': stock.reduce((sum, item) => sum + item.quantity, 0) },
                { 'ç»Ÿè®¡é¡¹ç›®': 'æ­£å¸¸çŠ¶æ€', 'æ•°å€¼': normal },
                { 'ç»Ÿè®¡é¡¹ç›®': 'å³å°†è¿‡æœŸ', 'æ•°å€¼': warning },
                { 'ç»Ÿè®¡é¡¹ç›®': 'å·²è¿‡æœŸ', 'æ•°å€¼': expired },
                { 'ç»Ÿè®¡é¡¹ç›®': 'åº“å­˜ä¸è¶³', 'æ•°å€¼': low },
                { 'ç»Ÿè®¡é¡¹ç›®': 'å…¥åº“è®°å½•æ•°', 'æ•°å€¼': records.filter(r => r.type === 'in').length },
                { 'ç»Ÿè®¡é¡¹ç›®': 'å‡ºåº“è®°å½•æ•°', 'æ•°å€¼': records.filter(r => r.type === 'out').length },
                { 'ç»Ÿè®¡é¡¹ç›®': 'ç³»ç»Ÿäººå‘˜æ•°', 'æ•°å€¼': personnel.length },
                { 'ç»Ÿè®¡é¡¹ç›®': 'å¯¼å‡ºæ—¶é—´', 'æ•°å€¼': new Date().toLocaleString('zh-CN') }
            ];
            
            const summaryWS = XLSX.utils.json_to_sheet(summaryData);
            summaryWS['!cols'] = [{wch: 20}, {wch: 15}];
            XLSX.utils.book_append_sheet(wb, summaryWS, "ç»Ÿè®¡æ±‡æ€»");
            
            // ä¸‹è½½æ–‡ä»¶
            const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'binary' });
            
            function s2ab(s) {
                const buf = new ArrayBuffer(s.length);
                const view = new Uint8Array(buf);
                for (let i = 0; i < s.length; i++) view[i] = s.charCodeAt(i) & 0xFF;
                return buf;
            }
            
            const blob = new Blob([s2ab(wbout)], { type: 'application/octet-stream' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `æ ‡å‡†ç‰©è´¨ç®¡ç†æ•°æ®_${new Date().toISOString().slice(0, 10)}.xlsx`;
            link.click();
            
            alert('Excelæ•°æ®å¯¼å‡ºæˆåŠŸï¼\nåŒ…å«ï¼šåº“å­˜æ•°æ®ã€æ“ä½œè®°å½•ã€äººå‘˜ä¿¡æ¯ã€ç»Ÿè®¡æ±‡æ€»');
        }

        // ==================== è°ƒè¯•åŠŸèƒ½ ====================
        function toggleDebug() {
            const panel = document.getElementById('debugPanel');
            panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
            updateDebugInfo();
        }

        function updateDebugInfo() {
            const stock = Storage.get('stock') || [];
            const personnel = Storage.get('personnel') || [];
            const records = Storage.get('records') || [];
            const messages = Storage.get('messages') || [];
            
            document.getElementById('debugContent').innerHTML = `
                <div class="mb-2">åº“å­˜: ${stock.length} æ¡</div>
                <div class="mb-2">äººå‘˜: ${personnel.length} æ¡</div>
                <div class="mb-2">è®°å½•: ${records.length} æ¡</div>
                <div class="mb-2">æ¶ˆæ¯: ${messages.length} æ¡</div>
                <div class="mb-2">å½“å‰ç”¨æˆ·: ${currentUser?.name || 'æœªç™»å½•'}</div>
            `;
        }

        function clearAllData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) return;
            Storage.set('stock', []);
            Storage.set('records', []);
            Storage.set('messages', []);
            imageStorage.clear();
            refreshAllData();
            updateDebugInfo();
            alert('æ‰€æœ‰æ•°æ®å·²æ¸…ç©ºï¼');
        }

        function loadDemoData() {
            // æ·»åŠ æ¼”ç¤ºåº“å­˜æ•°æ®
            const demoStock = [
                {
                    id: Date.now(),
                    name: 'ç”²é†‡æ ‡å‡†æº¶æ¶²',
                    code: 'STD-001',
                    batchNumber: 'B2024001',
                    uniqueId: 'B2024001-0001-01',
                    manufacturer: 'å›½å®¶æ ‡å‡†ç‰©è´¨ä¸­å¿ƒ',
                    concentration: '1000Î¼g/mL',
                    uncertainty: '0.5%',
                    storageCondition: '4â„ƒé¿å…‰ä¿å­˜',
                    quantity: 1,
                    expiryDate: '2025-12-31',
                    operator: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    status: 'normal',
                    images: [],
                    createdAt: new Date().toISOString()
                },
                {
                    id: Date.now() + 1,
                    name: 'ä¹™é†‡æ ‡å‡†æº¶æ¶²',
                    code: 'STD-002',
                    batchNumber: 'B2024002',
                    uniqueId: 'B2024002-0001-01',
                    manufacturer: 'å›½å®¶æ ‡å‡†ç‰©è´¨ä¸­å¿ƒ',
                    concentration: '500Î¼g/mL',
                    uncertainty: '1.0%',
                    storageCondition: 'å¸¸æ¸©ä¿å­˜',
                    quantity: 1,
                    expiryDate: new Date(Date.now() + 15 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                    operator: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    status: 'warning',
                    images: [],
                    createdAt: new Date().toISOString()
                }
            ];
            
            Storage.set('stock', demoStock);
            
            // æ·»åŠ æ¼”ç¤ºè®°å½•
            const demoRecords = [
                {
                    id: Date.now(),
                    type: 'in',
                    materialName: 'ç”²é†‡æ ‡å‡†æº¶æ¶²',
                    quantity: 1,
                    operator: 'ç³»ç»Ÿç®¡ç†å‘˜',
                    date: new Date().toLocaleString('zh-CN'),
                    note: 'æ‰¹æ¬¡å·: B2024001ï¼Œå…¥åº“1ç“¶',
                    images: []
                }
            ];
            Storage.set('records', demoRecords);
            
            refreshAllData();
            updateDebugInfo();
            alert('æ¼”ç¤ºæ•°æ®åŠ è½½æˆåŠŸï¼');
        }

        // æµ‹è¯•æ¶ˆæ¯åŠŸèƒ½
        function testMessage() {
            const messages = Storage.get('messages') || [];
            messages.push({
                id: Date.now().toString(),
                sender: 'ç³»ç»Ÿ',
                senderUsername: 'system',
                recipient: currentUser?.username || 'admin',
                recipientName: currentUser?.name || 'ç³»ç»Ÿç®¡ç†å‘˜',
                content: 'è¿™æ˜¯ä¸€æ¡æµ‹è¯•æ¶ˆæ¯ï¼Œç”¨äºéªŒè¯æ¶ˆæ¯åŠŸèƒ½æ˜¯å¦æ­£å¸¸å·¥ä½œã€‚\n\nå¦‚æœæ‚¨èƒ½çœ‹åˆ°è¿™æ¡æ¶ˆæ¯ï¼Œè¯´æ˜æ¶ˆæ¯ç³»ç»Ÿè¿è¡Œæ­£å¸¸ï¼',
                date: new Date().toLocaleString('zh-CN'),
                timestamp: Date.now(),
                readBy: []
            });
            Storage.set('messages', messages);
            updateNotificationBadge();
            alert('æµ‹è¯•æ¶ˆæ¯å·²å‘é€ï¼è¯·æŸ¥çœ‹æ¶ˆæ¯ä¸­å¿ƒã€‚');
        }

        // ==================== é€šç”¨åŠŸèƒ½ ====================
        function closeModalOnBg(event, modalId) {
            if (event.target.id === modalId) {
                document.getElementById(modalId).classList.remove('show');
            }
        }

        // ==================== åˆå§‹åŒ– ====================
        document.addEventListener('DOMContentLoaded', function() {
            initData();
            
            // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
            const savedUser = Storage.get('currentUser');
            if (savedUser) {
                currentUser = savedUser;
                showApp();
            }
            
            // å®šæœŸæ›´æ–°è°ƒè¯•ä¿¡æ¯
            setInterval(updateDebugInfo, 2000);
        });
    </script>
</body>
</html>



