<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="filename" content="index.html">
    <title>ç»¥åŒ–æ°´è´¨å®éªŒå®¤è¯„ä»·ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#0F62FE',
                        secondary: '#002D9C',
                        accent: '#00FBFF',
                        surface: '#F4F7FB',
                        card: '#FFFFFF',
                        danger: '#DA1E28',
                        success: '#198038',
                        warning: '#F1C21B'
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans SC', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <style>
        body {
            background-color: #F8FAFC;
            min-height: 100vh;
            width: 100%;
            margin: 0 auto;
            position: relative;
        }
        .glass-panel {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        .data-table-container {
            max-height: 500px;
            overflow-y: auto;
        }
        .ai-chat-bubble {
            border-radius: 18px 18px 0 18px;
        }
        .user-chat-bubble {
            border-radius: 18px 18px 18px 0;
        }
        .standard-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
    <style>
        html, body {
            max-width: 100vw;
            overflow-x: hidden;
        }
    </style>
</head>
<body class="font-sans text-slate-900 overflow-x-hidden max-w-full box-border">
    <!-- Navigation -->
    <nav class="h-16 flex items-center justify-between px-4 md:px-8 bg-white border-b sticky top-0 z-50 max-w-full overflow-hidden">
        <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center text-white">
                <i data-lucide="droplets"></i>
            </div>
            <span class="text-xl font-bold tracking-tight text-secondary">ç»¥åŒ–æ°´è´¨å®éªŒå®¤</span>
        </div>
        <div class="flex items-center gap-6 text-sm font-medium text-slate-500">
            <button id="exportBtn" onclick="exportResults()" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-secondary transition-all disabled:opacity-50 disabled:cursor-not-allowed" disabled>å¯¼å‡ºç»“æœ</button>
        </div>
    </nav>

    <!-- æ ‡å‡†æŸ¥çœ‹æ¨¡æ€æ¡† -->
    <div id="standardModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center" onclick="this.classList.add('hidden')">
        <div class="bg-white rounded-lg p-4 max-w-4xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
            <div class="flex justify-between items-center mb-4">
                <h3 id="standardModalTitle" class="font-bold text-lg"></h3>
                <button onclick="document.getElementById('standardModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <div id="standardModalContent"></div>
        </div>
    </div>

    <main class="p-4 md:p-8 grid grid-cols-12 gap-4 md:gap-6 max-w-full mx-auto">
        <!-- Left Section: Upload and Table -->
        <div id="mainContent" class="col-span-12 flex flex-col gap-6">
            <!-- Upload Area -->
            <div id="dropZone" class="border-2 border-dashed border-slate-300 rounded-2xl p-8 bg-white text-center hover:border-primary transition-all cursor-pointer group">
                <input type="file" id="fileInput" class="hidden" accept=".xlsx, .csv">
                <div class="w-16 h-16 bg-blue-50 text-primary rounded-full flex items-center justify-center mx-auto mb-4 group-hover:scale-110 transition-transform">
                    <i data-lucide="upload-cloud" class="w-8 h-8"></i>
                </div>
                <h3 class="text-lg font-bold mb-1">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ ç›‘æµ‹æ•°æ®</h3>
                <p class="text-slate-400 text-sm">æ”¯æŒ Excel (.xlsx) æˆ– CSV æ ¼å¼ï¼ˆå«ï¼šæº¶è§£æ°§ã€æ°¨æ°®ã€æ€»ç£·ã€æ€»æ°®ç­‰ï¼‰</p>
            </div>

            <!-- Table Preview -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="px-6 py-4 border-b flex justify-between items-center bg-slate-50/50">
                    <h3 class="font-bold flex items-center gap-2">
                        <i data-lucide="table" class="w-4 h-4 text-primary"></i>
                        æ•°æ®é¢„è§ˆä¸å®æ—¶è¯„ä»·
                    </h3>
                    <div class="flex gap-2 items-center">
                        <button type="button" id="lakeTPBtn" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-white min-w-[180px] text-left">
                            --æ¹–åº“ç«™ç‚¹--
                        </button>
                        <button type="button" id="showLakeStandard" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-blue-50 text-blue-600 hover:bg-blue-100">
                            æ¹–åº“è¯„åˆ†è¡¨
                        </button>
                        <button type="button" id="showGBStandard" class="text-xs border border-slate-300 rounded px-2 py-1.5 bg-green-50 text-green-600 hover:bg-green-100">
                            GB3838æ ‡å‡†
                        </button>
                        <div id="lakeTPDropdown" class="hidden fixed bg-white border border-slate-300 rounded shadow-lg z-50 max-h-60 overflow-auto p-2" style="min-width: 200px;">
                            <div id="lakeTPOptions"></div>
                        </div>
                        <button id="runEval" class="text-xs bg-success text-white px-3 py-1.5 rounded-md flex items-center gap-1 hover:bg-green-700 transition-colors">
                            <i data-lucide="play" class="w-3 h-3"></i> å¼€å§‹è¯„ä»·
                        </button>
                    </div>
                </div>
                <div class="data-table-container overflow-x-auto">
                    <table class="w-full text-sm text-left border-collapse" id="dataTable">
                        <thead class="bg-slate-50 text-slate-500 sticky top-0 z-10">
                            <tr>
                                <th class="px-2 py-2 border-b font-medium bg-blue-50 sticky left-0 z-20">ç«™ç‚¹åç§°</th>
                                <th class="px-2 py-2 border-b font-medium">æ°´ä½</th>
                                <th class="px-2 py-2 border-b font-medium">æµé€Ÿ</th>
                                <th class="px-2 py-2 border-b font-medium">æµé‡</th>
                                <th class="px-2 py-2 border-b font-medium">æ°”æ¸©</th>
                                <th class="px-2 py-2 border-b font-medium">æ°´æ¸©</th>
                                <th class="px-2 py-2 border-b font-medium">pHå€¼</th>
                                <th class="px-2 py-2 border-b font-medium">ç”µå¯¼ç‡</th>
                                <th class="px-2 py-2 border-b font-medium">æº¶è§£æ°§</th>
                                <th class="px-2 py-2 border-b font-medium">é«˜é”°é…¸ç›æŒ‡æ•°</th>
                                <th class="px-2 py-2 border-b font-medium">åŒ–å­¦éœ€æ°§é‡</th>
                                <th class="px-2 py-2 border-b font-medium">äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡</th>
                                <th class="px-2 py-2 border-b font-medium">æ°¨æ°®</th>
                                <th class="px-2 py-2 border-b font-medium">æ€»æ°®</th>
                                <th class="px-2 py-2 border-b font-medium">æ€»ç£·</th>
                                <th class="px-2 py-2 border-b font-medium">é“œ</th>
                                <th class="px-2 py-2 border-b font-medium">é”Œ</th>
                                <th class="px-2 py-2 border-b font-medium">æ°ŸåŒ–ç‰©</th>
                                <th class="px-2 py-2 border-b font-medium">ç¡’</th>
                                <th class="px-2 py-2 border-b font-medium">ç ·</th>
                                <th class="px-2 py-2 border-b font-medium">æ±</th>
                                <th class="px-2 py-2 border-b font-medium">é•‰</th>
                                <th class="px-2 py-2 border-b font-medium">é“¬ï¼ˆå…­ä»·ï¼‰</th>
                                <th class="px-2 py-2 border-b font-medium">é“…</th>
                                <th class="px-2 py-2 border-b font-medium">æ°°åŒ–ç‰©</th>
                                <th class="px-2 py-2 border-b font-medium">æŒ¥å‘é…š</th>
                                <th class="px-2 py-2 border-b font-medium">çŸ³æ²¹ç±»</th>
                                <th class="px-2 py-2 border-b font-medium">é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚</th>
                                <th class="px-2 py-2 border-b font-medium">ç¡«åŒ–ç‰©</th>
                                <th class="px-2 py-2 border-b font-medium">å¶ç»¿ç´ a</th>
                                <th class="px-2 py-2 border-b font-medium">é€æ˜åº¦</th>
                                <th class="px-2 py-2 border-b font-medium">ç¡é…¸ç›æ°®</th>
                                <th class="px-2 py-2 border-b font-medium">é“</th>
                                <th class="px-2 py-2 border-b font-medium">é”°</th>
                                <th class="px-2 py-2 border-b font-medium">æ°¯åŒ–ç‰©</th>
                                <th class="px-2 py-2 border-b font-medium">ç¡«é…¸ç›</th>
                                <th class="px-2 py-2 border-b font-medium">ç²ªå¤§è‚ èŒç¾¤</th>
                                <th class="px-2 py-2 border-b font-medium">æ€»ç¡¬åº¦</th>
                                <th class="px-2 py-2 border-b font-medium">é’™</th>
                                <th class="px-2 py-2 border-b font-medium">é•</th>
                                <th class="px-2 py-2 border-b font-medium">ç¢³é…¸ç›</th>
                                <th class="px-2 py-2 border-b font-medium">é‡ç¢³é…¸ç›</th>
                                <th class="px-2 py-2 border-b font-medium">çŸ¿åŒ–åº¦</th>
                                <th class="px-2 py-2 border-b font-medium">é’ </th>
                                <th class="px-2 py-2 border-b font-medium">é’¾</th>
                                <th class="px-3 py-2 border-b font-bold text-primary bg-amber-100 min-w-[80px]">æ°´è´¨ç±»åˆ«</th>
                                <th class="px-4 py-2 border-b font-bold text-primary bg-amber-100 min-w-[200px]">è¶…æ ‡é¡¹ç›®åŠå€æ•°</th>
                                <th class="px-3 py-2 border-b font-bold text-primary bg-amber-100 min-w-[90px]">å¯Œè¥å…»åŒ–</th>
                                <th class="px-2 py-2 border-b font-bold text-primary bg-amber-100 min-w-[70px]">TLIæŒ‡æ•°</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-100" id="tableBody">
                            <!-- Placeholder Data -->
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-4 font-medium">å¤ªæ¹–A1æµ‹ç‚¹</td>
                                <td class="px-4 py-4">7.2</td>
                                <td class="px-4 py-4">3.5</td>
                                <td class="px-4 py-4">0.42</td>
                                <td class="px-4 py-4"><span class="standard-badge bg-green-100 text-green-700">â…¡ç±»</span></td>
                                <td class="px-4 py-4"><span class="standard-badge bg-blue-100 text-blue-700">ä¸­è¥å…»</span></td>
                            </tr>
                             <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-4 font-medium">æ·€å±±æ¹–ä¸­å¿ƒ</td>
                                <td class="px-4 py-4">4.8</td>
                                <td class="px-4 py-4">5.2</td>
                                <td class="px-4 py-4">1.10</td>
                                <td class="px-4 py-4"><span class="standard-badge bg-yellow-100 text-yellow-700">â…£ç±»</span></td>
                                <td class="px-4 py-4"><span class="standard-badge bg-orange-100 text-orange-700">è½»åº¦å¯Œè¥å…»</span></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <footer class="mt-12 p-8 border-t bg-white">
        <div class="flex flex-col md:flex-row justify-between items-center text-sm text-slate-400">
            <p>Â© 2024 ç»¥åŒ–æ°´è´¨å®éªŒå®¤ | æ”¯æŒ GB3838-2002 å…¨å‚æ•°è¯„ä»·</p>
            <div class="flex gap-6 mt-4 md:mt-0">
                <a href="#" class="hover:text-primary">æœåŠ¡æ¡æ¬¾</a>
                <a href="#" class="hover:text-primary">è”ç³»ä¸“å®¶</a>
            </div>
        </div>
    </footer>

    <script>
        // åˆç†æ€§ç»Ÿè®¡å‡½æ•° - å®šä¹‰åœ¨å…¨å±€ä½œç”¨åŸŸ
        function performRationalityCheck() {
            if (typeof parsedData === 'undefined' || parsedData.length === 0) {
                return "æš‚æ— æ•°æ®ï¼Œè¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶ã€‚";
            }

            let report = "ğŸ“Š æ•°æ®åˆç†æ€§æ£€éªŒç»“æœ\n\n";

            // æ£€éªŒ1: å…«å¤§ç¦»å­ä¸çŸ¿åŒ–åº¦åˆç†æ€§
            report += "ã€1ã€‘å…«å¤§ç¦»å­ä¸çŸ¿åŒ–åº¦åˆç†æ€§\n";
            let ionIssues = [];
            parsedData.forEach(row => {
                const station = row['ç«™ç‚¹åç§°'] || 'æœªçŸ¥ç«™ç‚¹';
                const ions = ['æ°¯åŒ–ç‰©', 'ç¡«é…¸ç›', 'ç¢³é…¸ç›', 'é‡ç¢³é…¸ç›', 'é’ ', 'é’¾', 'é’™', 'é•'];
                let ionSum = 0;
                ions.forEach(ion => {
                    if (row[ion] !== null && row[ion] !== undefined && !isNaN(row[ion])) {
                        ionSum += row[ion];
                    }
                });
                const mdd = row['çŸ¿åŒ–åº¦'];
                if (mdd !== null && mdd !== undefined && !isNaN(mdd)) {
                    if (ionSum > mdd) {
                        ionIssues.push(station);
                    }
                }
            });
            if (ionIssues.length === 0) {
                report += "âœ… åˆç†ï¼šå…«å¤§ç¦»å­æµ“åº¦ä¹‹å’Œ â‰¤ çŸ¿åŒ–åº¦æµ“åº¦\n\n";
            } else {
                report += "âš ï¸ ä¸åˆç†ï¼š" + ionIssues.join('ã€') + "\n\n";
            }

            // æ£€éªŒ2: COD/é«˜é”°é…¸ç›æŒ‡æ•°/äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡å…³ç³»
            report += "ã€2ã€‘CODä¸é«˜é”°é…¸ç›æŒ‡æ•°ã€äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡å…³ç³»\n";
            let codIssues = [];
            parsedData.forEach(row => {
                const station = row['ç«™ç‚¹åç§°'] || 'æœªçŸ¥ç«™ç‚¹';
                const cod = row['åŒ–å­¦éœ€æ°§é‡'];
                const kmno4 = row['é«˜é”°é…¸ç›æŒ‡æ•°'];
                const bod5 = row['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'];
                if (cod !== null && cod !== undefined && !isNaN(cod) &&
                    kmno4 !== null && kmno4 !== undefined && !isNaN(kmno4) &&
                    bod5 !== null && bod5 !== undefined && !isNaN(bod5)) {
                    if (!(cod > kmno4 && kmno4 > bod5)) {
                        codIssues.push(station);
                    }
                }
            });
            if (codIssues.length === 0) {
                report += "âœ… åˆç†ï¼šåŒ–å­¦éœ€æ°§é‡ > é«˜é”°é…¸ç›æŒ‡æ•° > äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡\n\n";
            } else {
                report += "âš ï¸ ä¸åˆç†ï¼š" + codIssues.join('ã€') + "\n\n";
            }

            // æ£€éªŒ3: pHä¸ç¢³é…¸ç›å…³ç³»
            report += "ã€3ã€‘pHä¸ç¢³é…¸ç›å…³ç³»\n";
            let phIssues = [];
            parsedData.forEach(row => {
                const station = row['ç«™ç‚¹åç§°'] || 'æœªçŸ¥ç«™ç‚¹';
                const ph = row['pHå€¼'];
                const carbonate = row['ç¢³é…¸ç›'];
                if (ph !== null && ph !== undefined && !isNaN(ph)) {
                    if (ph > 8.3) {
                        if (carbonate === null || carbonate === undefined || isNaN(carbonate) || carbonate === 0) {
                            phIssues.push(station);
                        }
                    }
                }
            });
            if (phIssues.length === 0) {
                report += "âœ… åˆç†ï¼špH>8.3æ—¶ï¼Œç¢³é…¸ç›æœ‰æ•°å€¼\n\n";
            } else {
                report += "âš ï¸ ä¸åˆç†ï¼š" + phIssues.join('ã€') + "\n\n";
            }

            // æ£€éªŒ4: æ€»æ°®ä¸æ°¨æ°®ã€ç¡é…¸ç›æ°®ã€äºšç¡é…¸ç›æ°®å…³ç³»
            report += "ã€4ã€‘æ€»æ°®ä¸æ°¨æ°®ã€ç¡é…¸ç›æ°®ã€äºšç¡é…¸ç›æ°®å…³ç³»\n";
            let tnIssues = [];
            parsedData.forEach(row => {
                const station = row['ç«™ç‚¹åç§°'] || 'æœªçŸ¥ç«™ç‚¹';
                const tn = row['æ€»æ°®'];
                const nh3 = row['æ°¨æ°®'];
                const no3 = row['ç¡é…¸ç›'];
                const no2 = row['äºšç¡é…¸ç›æ°®'];
                if (tn !== null && tn !== undefined && !isNaN(tn)) {
                    let nSum = 0;
                    if (nh3 !== null && nh3 !== undefined && !isNaN(nh3)) nSum += nh3;
                    if (no3 !== null && no3 !== undefined && !isNaN(no3)) nSum += no3;
                    if (no2 !== null && no2 !== undefined && !isNaN(no2)) nSum += no2;
                    if (tn < nSum) {
                        tnIssues.push(station);
                    }
                }
            });
            if (tnIssues.length === 0) {
                report += "âœ… åˆç†ï¼šæ€»æ°® â‰¥ æ°¨æ°® + ç¡é…¸ç›æ°® + äºšç¡é…¸ç›æ°®\n\n";
            } else {
                report += "âš ï¸ ä¸åˆç†ï¼š" + tnIssues.join('ã€') + "\n\n";
            }

            // æ£€éªŒ5: æº¶è§£æ°§ä¸æ°¨æ°®ã€ç¡é…¸ç›æ°®å…³ç³»
            report += "ã€5ã€‘æº¶è§£æ°§ä¸æ°¨æ°®ã€ç¡é…¸ç›æ°®å…³ç³»\n";
            let doIssues = [];
            parsedData.forEach(row => {
                const station = row['ç«™ç‚¹åç§°'] || 'æœªçŸ¥ç«™ç‚¹';
                const doVal = row['æº¶è§£æ°§'];
                const nh3 = row['æ°¨æ°®'];
                const no3 = row['ç¡é…¸ç›'];
                if (doVal !== null && doVal !== undefined && !isNaN(doVal) && doVal > 5) {
                    if (nh3 !== null && nh3 !== undefined && !isNaN(nh3) && no3 !== null && no3 !== undefined && !isNaN(no3)) {
                        if (no3 <= nh3) {
                            doIssues.push(station);
                        }
                    }
                }
            });
            if (doIssues.length === 0) {
                report += "âœ… åˆç†ï¼šæº¶è§£æ°§>5æ—¶ï¼Œç¡é…¸ç›æ°® > æ°¨æ°®\n\n";
            } else {
                report += "âš ï¸ ä¸åˆç†ï¼š" + doIssues.join('ã€') + "\n\n";
            }

            report += "==================\næ£€éªŒå®Œæˆï¼Œå…±æ£€éªŒ " + parsedData.length + " ä¸ªç«™ç‚¹ã€‚";

            return report;
        }

        // å…¨å±€èŠå¤©æ¶ˆæ¯å‡½æ•°
        function addBotMessage(text) {
            const chatHistory = document.getElementById('chatHistory');
            if (!chatHistory) return;
            
            const div = document.createElement('div');
            div.className = 'flex gap-2 animate-in fade-in slide-in-from-bottom-2 duration-300';
            div.innerHTML = `
                <div class="w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center text-primary">
                    <i data-lucide="bot" class="w-4 h-4"></i>
                </div>
                <div class="ai-chat-bubble bg-white border border-slate-200 p-3 text-sm shadow-sm whitespace-pre-line">${text}</div>
            `;
            chatHistory.appendChild(div);
            chatHistory.scrollTop = chatHistory.scrollHeight;
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        // GB3838-2002 æ°´è´¨è¯„ä»·æ ‡å‡† (å•ä½: mg/Lï¼Œé™¤pHæ— å•ä½)
        // æ²³æµ/æ¹–åº“å…¬å…±æ ‡å‡† - åŸºæœ¬é¡¹ç›®
        const GB3838_COMMON = {
            'pHå€¼': { 'â… ': [6,9], 'â…¡': [6,9], 'â…¢': [6,9], 'â…£': [5.5,9], 'â…¤': [5,9] },
            'æº¶è§£æ°§': { 'â… ': 7.5, 'â…¡': 6, 'â…¢': 5, 'â…£': 3, 'â…¤': 2 },
            'é«˜é”°é…¸ç›æŒ‡æ•°': { 'â… ': 2, 'â…¡': 4, 'â…¢': 6, 'â…£': 10, 'â…¤': 15 },
            'æ°¨æ°®': { 'â… ': 0.15, 'â…¡': 0.5, 'â…¢': 1.0, 'â…£': 1.5, 'â…¤': 2.0 },
            'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡': { 'â… ': 3, 'â…¡': 3, 'â…¢': 4, 'â…£': 6, 'â…¤': 10 },
            'åŒ–å­¦éœ€æ°§é‡': { 'â… ': 15, 'â…¡': 15, 'â…¢': 20, 'â…£': 30, 'â…¤': 40 },
            'ç²ªå¤§è‚ èŒç¾¤': { 'â… ': 200, 'â…¡': 2000, 'â…¢': 10000, 'â…£': 20000, 'â…¤': 40000 }
        };

        // æ¹–åº“æ ‡å‡† (æ€»ç£·ã€æ€»æ°®æ›´ä¸¥æ ¼)
        const GB3838_LAKE = {
            'æ€»ç£·': { 'â… ': 0.01, 'â…¡': 0.025, 'â…¢': 0.05, 'â…£': 0.1, 'â…¤': 0.2 },
            'æ€»æ°®': { 'â… ': 0.3, 'â…¡': 0.5, 'â…¢': 1.0, 'â…£': 1.5, 'â…¤': 2.0 }
        };

        // æ²³æµæ ‡å‡†
        const GB3838_RIVER = {
            'æ€»ç£·': { 'â… ': 0.02, 'â…¡': 0.1, 'â…¢': 0.2, 'â…£': 0.3, 'â…¤': 0.6 },
            'æ€»æ°®': { 'â… ': 0.2, 'â…¡': 0.5, 'â…¢': 1.0, 'â…£': 1.5, 'â…¤': 2.0 }
        };

        // é‡é‡‘å±å’Œæœ‰æ¯’ç‰©è´¨æ ‡å‡† (mg/L)
        const GB3838_HEAVY = {
            'é“œ': { 'â… ': 0.01, 'â…¡': 0.05, 'â…¢': 0.1, 'â…£': 1.0, 'â…¤': 1.0 },
            'é”Œ': { 'â… ': 0.05, 'â…¡': 0.5, 'â…¢': 1.0, 'â…£': 2.0, 'â…¤': 2.0 },
            'æ°ŸåŒ–ç‰©': { 'â… ': 1.0, 'â…¡': 1.0, 'â…¢': 1.0, 'â…£': 1.5, 'â…¤': 1.5 },
            'ç¡’': { 'â… ': 0.01, 'â…¡': 0.01, 'â…¢': 0.01, 'â…£': 0.02, 'â…¤': 0.02 },
            'ç ·': { 'â… ': 0.05, 'â…¡': 0.05, 'â…¢': 0.05, 'â…£': 0.1, 'â…¤': 0.1 },
            'æ±': { 'â… ': 0.00005, 'â…¡': 0.00005, 'â…¢': 0.0001, 'â…£': 0.001, 'â…¤': 0.001 },
            'é•‰': { 'â… ': 0.001, 'â…¡': 0.005, 'â…¢': 0.005, 'â…£': 0.01, 'â…¤': 0.01 },
            'é“¬å…­ä»·': { 'â… ': 0.01, 'â…¡': 0.05, 'â…¢': 0.05, 'â…£': 0.05, 'â…¤': 0.1 },
            'é“…': { 'â… ': 0.01, 'â…¡': 0.01, 'â…¢': 0.05, 'â…£': 0.05, 'â…¤': 0.1 },
            'æ°°åŒ–ç‰©': { 'â… ': 0.005, 'â…¡': 0.05, 'â…¢': 0.2, 'â…£': 0.2, 'â…¤': 0.2 },
            'æŒ¥å‘é…š': { 'â… ': 0.002, 'â…¡': 0.002, 'â…¢': 0.005, 'â…£': 0.01, 'â…¤': 0.1 },
            'çŸ³æ²¹ç±»': { 'â… ': 0.05, 'â…¡': 0.05, 'â…¢': 0.05, 'â…£': 0.5, 'â…¤': 1.0 },
            'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚': { 'â… ': 0.2, 'â…¡': 0.2, 'â…¢': 0.3, 'â…£': 0.3, 'â…¤': 0.3 },
            'ç¡«åŒ–ç‰©': { 'â… ': 0.01, 'â…¡': 0.1, 'â…¢': 0.2, 'â…£': 0.5, 'â…¤': 1.0 }
        };

        // æ¹–åº“è¯†åˆ«å…³é”®è¯
        const LAKE_KEYWORDS = ['æ¹–', 'åº“', 'æ°´åº“', 'æ·€', 'æµ·', 'æ´¼', 'æ½­', 'æ± ', 'æ³Š'];

        // TLI è¥å…»çŠ¶æ€æŒ‡æ•°å‚æ•° (æ¹–æ³Šæ°´åº“) - æ ‡å‡†å…¬å¼
        const TLI_PARAMS = {
            'å¶ç»¿ç´ a': { formula: '10*(2.5+1.086*Math.log(chla))', unit: 'Î¼g/L' },
            'æ€»ç£·': { formula: '10*(9.436+1.624*Math.log(tp))', unit: 'mg/L' },
            'æ€»æ°®': { formula: '10*(5.453+1.694*Math.log(tn))', unit: 'mg/L' },
            'é«˜é”°é…¸ç›æŒ‡æ•°': { formula: '10*(0.109+2.619*Math.log(cod))', unit: 'mg/L' },
            'é€æ˜åº¦': { formula: '10*(5.118-1.588*Math.log(sd))', unit: 'm', inverse: true }
        };

        // å½“å‰è¯„ä»·æ¨¡å¼
        let currentEvalMode = 'gb3838';

        // å­˜å‚¨è§£æåçš„æ•°æ®
        let parsedData = [];
        let evaluationResults = [];

        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();

            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');
            const tableBody = document.getElementById('tableBody');
            const runEvalBtn = document.getElementById('runEval');
            const chatHistory = document.getElementById('chatHistory');
            const chatInput = document.getElementById('chatInput');
            const sendMsgBtn = document.getElementById('sendMsg');

            // æ–‡ä»¶ä¸Šä¼ 
            dropZone.addEventListener('click', () => fileInput.click());
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-primary', 'bg-blue-50');
            });
            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('border-primary', 'bg-blue-50');
            });
            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-primary', 'bg-blue-50');
                if (e.dataTransfer.files.length > 0) {
                    handleFile(e.dataTransfer.files[0]);
                }
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });

            // å¤„ç†Excelæ–‡ä»¶
            function handleFile(file) {
                console.log('handleFile called:', file.name);
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('FileReader loaded');
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    
                    console.log('Excel parsed, rows:', jsonData.length);
                    parseExcelData(jsonData);
                };
                reader.onerror = function(e) {
                    console.error('FileReader error:', e);
                    addBotMessage("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ï¼");
                };
                reader.readAsArrayBuffer(file);
            }

            // è§£æExcelæ•°æ® - é€‚é…å¤šè¡Œè¡¨å¤´æ ¼å¼
            function parseExcelData(data) {
                if (data.length < 3) {
                    addBotMessage("æ–‡ä»¶æ•°æ®ä¸ºç©ºæˆ–æ ¼å¼ä¸æ­£ç¡®ï¼");
                    return;
                }

                // æŸ¥æ‰¾æ•°æ®å¼€å§‹çš„è¡Œï¼ˆè·³è¿‡æ ‡é¢˜è¡Œå’Œå•ä½è¡Œï¼‰
                let headerRowIndex = -1;
                for (let i = 0; i < Math.min(5, data.length); i++) {
                    const row = data[i];
                    if (row && row.some(cell => /æ°´è´¨ç«™åç§°|ç«™ç‚¹|æµ‹ç‚¹|æ–­é¢/.test(String(cell)))) {
                        headerRowIndex = i;
                        break;
                    }
                }

                if (headerRowIndex === -1) {
                    addBotMessage("æœªæ‰¾åˆ°æ•°æ®è¡¨å¤´ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼");
                    return;
                }

                const headers = data[headerRowIndex].map(h => String(h).trim());
                
                // åˆ—åæ˜ å°„ - æ”¯æŒå¤šç§å¯èƒ½çš„åˆ—å
                const columnMap = {
                    'ç«™ç‚¹åç§°': headers.findIndex(h => /æ°´è´¨ç«™åç§°|ç«™ç‚¹|æµ‹ç‚¹|æ–­é¢|ç›‘æµ‹ç‚¹/.test(h)),
                    'æ‰€åœ¨æ°´ä½“åç§°': headers.findIndex(h => /æ‰€åœ¨æ°´ä½“åç§°|æ°´ä½“åç§°|æ°´ä½“|æ²³æ®µ/.test(h)),
                    'æ°´ä½': headers.findIndex(h => /æ°´ä½/.test(h)),
                    'æµé€Ÿ': headers.findIndex(h => /æµé€Ÿ/.test(h)),
                    'æµé‡': headers.findIndex(h => /æµé‡/.test(h)),
                    'æ°”æ¸©': headers.findIndex(h => /æ°”æ¸©/.test(h)),
                    'æ°´æ¸©': headers.findIndex(h => /æ°´æ¸©|æ¸©åº¦/.test(h)),
                    'pHå€¼': headers.findIndex(h => /pHå€¼|pH/.test(h)),
                    'ç”µå¯¼ç‡': headers.findIndex(h => /ç”µå¯¼ç‡|EC/.test(h)),
                    'æº¶è§£æ°§': headers.findIndex(h => /æº¶è§£æ°§|DO/.test(h)),
                    'é«˜é”°é…¸ç›æŒ‡æ•°': headers.findIndex(h => /é«˜é”°é…¸ç›æŒ‡æ•°|CODMn/.test(h)),
                    'åŒ–å­¦éœ€æ°§é‡': headers.findIndex(h => /åŒ–å­¦éœ€æ°§é‡|CODcr/.test(h)),
                    'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡': headers.findIndex(h => /äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡|BOD5|BOD/.test(h)),
                    'æ°¨æ°®': headers.findIndex(h => /æ°¨æ°®|NH3-N/.test(h)),
                    'æ€»æ°®': headers.findIndex(h => /æ€»æ°®|TN/.test(h)),
                    'æ€»ç£·': headers.findIndex(h => /æ€»ç£·|TP/.test(h)),
                    'é“œ': headers.findIndex(h => /^é“œ$|Cu\b/.test(h)),
                    'é”Œ': headers.findIndex(h => /^é”Œ$|Zn\b/.test(h)),
                    'æ°ŸåŒ–ç‰©': headers.findIndex(h => /æ°ŸåŒ–ç‰©|F\b/.test(h)),
                    'ç¡’': headers.findIndex(h => /^ç¡’$|Se\b/.test(h)),
                    'ç ·': headers.findIndex(h => /^ç ·$|As\b/.test(h)),
                    'æ±': headers.findIndex(h => /^æ±$|Hg\b/.test(h)),
                    'é•‰': headers.findIndex(h => /^é•‰$|Cd\b/.test(h)),
                    'é“¬å…­ä»·': headers.findIndex(h => /é“¬.*å…­ä»·|å…­ä»·é“¬|Cr6/.test(h)),
                    'é“…': headers.findIndex(h => /^é“…$|Pb\b/.test(h)),
                    'æ°°åŒ–ç‰©': headers.findIndex(h => /æ°°åŒ–ç‰©|CN/.test(h)),
                    'æŒ¥å‘é…š': headers.findIndex(h => /æŒ¥å‘é…š|é…š/.test(h)),
                    'çŸ³æ²¹ç±»': headers.findIndex(h => /çŸ³æ²¹ç±»|çŸ³æ²¹/.test(h)),
                    'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚': headers.findIndex(h => /é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚|LAS/.test(h)),
                    'ç¡«åŒ–ç‰©': headers.findIndex(h => /ç¡«åŒ–ç‰©|S2-/.test(h)),
                    'å¶ç»¿ç´ a': headers.findIndex(h => /å¶ç»¿ç´ |Chl.a/.test(h)),
                    'é€æ˜åº¦': headers.findIndex(h => /é€æ˜åº¦|SD/.test(h)),
                    'ç¡é…¸ç›æ°®': headers.findIndex(h => /ç¡é…¸ç›æ°®|NO3-N/.test(h)),
                    'é“': headers.findIndex(h => /^é“$|Fe\b/.test(h)),
                    'é”°': headers.findIndex(h => /^é”°$|Mn\b/.test(h)),
                    'æ°¯åŒ–ç‰©': headers.findIndex(h => /æ°¯åŒ–ç‰©|Cl-/.test(h)),
                    'ç¡«é…¸ç›': headers.findIndex(h => /ç¡«é…¸ç›|SO4/.test(h)),
                    'ç²ªå¤§è‚ èŒç¾¤': headers.findIndex(h => /ç²ªå¤§è‚ èŒ/.test(h)),
                    'æ€»ç¡¬åº¦': headers.findIndex(h => /æ€»ç¡¬åº¦/.test(h)),
                    'é’™': headers.findIndex(h => /^é’™$|Ca\b/.test(h)),
                    'é•': headers.findIndex(h => /^é•$|Mg\b/.test(h)),
                    'ç¢³é…¸ç›': headers.findIndex(h => /ç¢³é…¸ç›/.test(h)),
                    'é‡ç¢³é…¸ç›': headers.findIndex(h => /é‡ç¢³é…¸ç›/.test(h)),
                    'çŸ¿åŒ–åº¦': headers.findIndex(h => /çŸ¿åŒ–åº¦/.test(h)),
                    'é’ ': headers.findIndex(h => /^é’ $|Na\b/.test(h)),
                    'é’¾': headers.findIndex(h => /^é’¾$|K\b/.test(h))
                };

                // æ£€æŸ¥å¿…è¦çš„åˆ—æ˜¯å¦å­˜åœ¨
                const requiredCols = ['ç«™ç‚¹åç§°'];
                const missingCols = requiredCols.filter(col => columnMap[col] === -1);
                
                if (missingCols.length > 0) {
                    addBotMessage(`ç¼ºå°‘å¿…è¦çš„åˆ—ï¼š${missingCols.join('ã€')}ã€‚å½“å‰è¡¨å¤´ï¼š${headers.join(', ')}`);
                    return;
                }

                // è§£ææ•°å€¼ï¼Œå¤„ç† "<0.005" è¿™ç§å°äºæ£€æµ‹é™çš„å€¼
                function parseValue(val) {
                    if (val === null || val === undefined || val === '') return null;
                    const strVal = String(val).trim();
                    if (strVal === '' || strVal === '-') return null;
                    // å¤„ç†å°äºæ£€æµ‹é™çš„å€¼ï¼Œå¦‚ "<0.005"ï¼Œå–æ£€æµ‹é™çš„ä¸€åŠ
                    if (strVal.startsWith('<')) {
                        const num = parseFloat(strVal.substring(1));
                        return isNaN(num) ? null : num * 0.5;
                    }
                    const num = parseFloat(strVal);
                    return isNaN(num) ? null : num;
                }

                parsedData = [];
                // ä»è¡¨å¤´åç¬¬2è¡Œå¼€å§‹è¯»å–æ•°æ®ï¼ˆè·³è¿‡å•ä½è¡Œï¼‰
                for (let i = headerRowIndex + 2; i < data.length; i++) {
                    const row = data[i];
                    if (!row || !row[columnMap['ç«™ç‚¹åç§°']]) continue;
                    
                    const item = {
                        'ç«™ç‚¹åç§°': String(row[columnMap['ç«™ç‚¹åç§°']]).trim(),
                        'æ‰€åœ¨æ°´ä½“åç§°': columnMap['æ‰€åœ¨æ°´ä½“åç§°'] >= 0 ? String(row[columnMap['æ‰€åœ¨æ°´ä½“åç§°']] || '').trim() : '',
                        'æ°´ä½': columnMap['æ°´ä½'] >= 0 ? parseValue(row[columnMap['æ°´ä½']]) : null,
                        'æµé€Ÿ': columnMap['æµé€Ÿ'] >= 0 ? parseValue(row[columnMap['æµé€Ÿ']]) : null,
                        'æµé‡': columnMap['æµé‡'] >= 0 ? parseValue(row[columnMap['æµé‡']]) : null,
                        'æ°”æ¸©': columnMap['æ°”æ¸©'] >= 0 ? parseValue(row[columnMap['æ°”æ¸©']]) : null,
                        'æ°´æ¸©': columnMap['æ°´æ¸©'] >= 0 ? parseValue(row[columnMap['æ°´æ¸©']]) : null,
                        'pHå€¼': columnMap['pHå€¼'] >= 0 ? parseValue(row[columnMap['pHå€¼']]) : null,
                        'ç”µå¯¼ç‡': columnMap['ç”µå¯¼ç‡'] >= 0 ? parseValue(row[columnMap['ç”µå¯¼ç‡']]) : null,
                        'æº¶è§£æ°§': columnMap['æº¶è§£æ°§'] >= 0 ? parseValue(row[columnMap['æº¶è§£æ°§']]) : null,
                        'é«˜é”°é…¸ç›æŒ‡æ•°': columnMap['é«˜é”°é…¸ç›æŒ‡æ•°'] >= 0 ? parseValue(row[columnMap['é«˜é”°é…¸ç›æŒ‡æ•°']]) : null,
                        'åŒ–å­¦éœ€æ°§é‡': columnMap['åŒ–å­¦éœ€æ°§é‡'] >= 0 ? parseValue(row[columnMap['åŒ–å­¦éœ€æ°§é‡']]) : null,
                        'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡': columnMap['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] >= 0 ? parseValue(row[columnMap['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡']]) : null,
                        'æ°¨æ°®': columnMap['æ°¨æ°®'] >= 0 ? parseValue(row[columnMap['æ°¨æ°®']]) : null,
                        'æ€»æ°®': columnMap['æ€»æ°®'] >= 0 ? parseValue(row[columnMap['æ€»æ°®']]) : null,
                        'æ€»ç£·': columnMap['æ€»ç£·'] >= 0 ? parseValue(row[columnMap['æ€»ç£·']]) : null,
                        'é“œ': columnMap['é“œ'] >= 0 ? parseValue(row[columnMap['é“œ']]) : null,
                        'é”Œ': columnMap['é”Œ'] >= 0 ? parseValue(row[columnMap['é”Œ']]) : null,
                        'æ°ŸåŒ–ç‰©': columnMap['æ°ŸåŒ–ç‰©'] >= 0 ? parseValue(row[columnMap['æ°ŸåŒ–ç‰©']]) : null,
                        'ç¡’': columnMap['ç¡’'] >= 0 ? parseValue(row[columnMap['ç¡’']]) : null,
                        'ç ·': columnMap['ç ·'] >= 0 ? parseValue(row[columnMap['ç ·']]) : null,
                        'æ±': columnMap['æ±'] >= 0 ? parseValue(row[columnMap['æ±']]) : null,
                        'é•‰': columnMap['é•‰'] >= 0 ? parseValue(row[columnMap['é•‰']]) : null,
                        'é“¬å…­ä»·': columnMap['é“¬å…­ä»·'] >= 0 ? parseValue(row[columnMap['é“¬å…­ä»·']]) : null,
                        'é“…': columnMap['é“…'] >= 0 ? parseValue(row[columnMap['é“…']]) : null,
                        'æ°°åŒ–ç‰©': columnMap['æ°°åŒ–ç‰©'] >= 0 ? parseValue(row[columnMap['æ°°åŒ–ç‰©']]) : null,
                        'æŒ¥å‘é…š': columnMap['æŒ¥å‘é…š'] >= 0 ? parseValue(row[columnMap['æŒ¥å‘é…š']]) : null,
                        'çŸ³æ²¹ç±»': columnMap['çŸ³æ²¹ç±»'] >= 0 ? parseValue(row[columnMap['çŸ³æ²¹ç±»']]) : null,
                        'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚': columnMap['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] >= 0 ? parseValue(row[columnMap['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚']]) : null,
                        'ç¡«åŒ–ç‰©': columnMap['ç¡«åŒ–ç‰©'] >= 0 ? parseValue(row[columnMap['ç¡«åŒ–ç‰©']]) : null,
                        'å¶ç»¿ç´ a': columnMap['å¶ç»¿ç´ a'] >= 0 ? parseValue(row[columnMap['å¶ç»¿ç´ a']]) : null,
                        'é€æ˜åº¦': columnMap['é€æ˜åº¦'] >= 0 ? parseValue(row[columnMap['é€æ˜åº¦']]) : null,
                        'ç¡é…¸ç›æ°®': columnMap['ç¡é…¸ç›æ°®'] >= 0 ? parseValue(row[columnMap['ç¡é…¸ç›æ°®']]) : null,
                        'é“': columnMap['é“'] >= 0 ? parseValue(row[columnMap['é“']]) : null,
                        'é”°': columnMap['é”°'] >= 0 ? parseValue(row[columnMap['é”°']]) : null,
                        'æ°¯åŒ–ç‰©': columnMap['æ°¯åŒ–ç‰©'] >= 0 ? parseValue(row[columnMap['æ°¯åŒ–ç‰©']]) : null,
                        'ç¡«é…¸ç›': columnMap['ç¡«é…¸ç›'] >= 0 ? parseValue(row[columnMap['ç¡«é…¸ç›']]) : null,
                        'ç²ªå¤§è‚ èŒç¾¤': columnMap['ç²ªå¤§è‚ èŒç¾¤'] >= 0 ? parseValue(row[columnMap['ç²ªå¤§è‚ èŒç¾¤']]) : null,
                        'æ€»ç¡¬åº¦': columnMap['æ€»ç¡¬åº¦'] >= 0 ? parseValue(row[columnMap['æ€»ç¡¬åº¦']]) : null,
                        'é’™': columnMap['é’™'] >= 0 ? parseValue(row[columnMap['é’™']]) : null,
                        'é•': columnMap['é•'] >= 0 ? parseValue(row[columnMap['é•']]) : null,
                        'ç¢³é…¸ç›': columnMap['ç¢³é…¸ç›'] >= 0 ? parseValue(row[columnMap['ç¢³é…¸ç›']]) : null,
                        'é‡ç¢³é…¸ç›': columnMap['é‡ç¢³é…¸ç›'] >= 0 ? parseValue(row[columnMap['é‡ç¢³é…¸ç›']]) : null,
                        'çŸ¿åŒ–åº¦': columnMap['çŸ¿åŒ–åº¦'] >= 0 ? parseValue(row[columnMap['çŸ¿åŒ–åº¦']]) : null,
                        'é’ ': columnMap['é’ '] >= 0 ? parseValue(row[columnMap['é’ ']]) : null,
                        'é’¾': columnMap['é’¾'] >= 0 ? parseValue(row[columnMap['é’¾']]) : null
                    };
                    // åªæ·»åŠ æœ‰ç«™ç‚¹åç§°çš„æ•°æ®è¡Œ
                    if (item['ç«™ç‚¹åç§°'] && item['ç«™ç‚¹åç§°'] !== '') {
                        parsedData.push(item);
                    }
                }

                if (parsedData.length === 0) {
                    addBotMessage("æœªè§£æåˆ°æœ‰æ•ˆæ•°æ®ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼ï¼");
                    return;
                }

                const parsedCols = Object.keys(parsedData[0] || {}).filter(k => parsedData[0][k] !== null && parsedData[0][k] !== '');
                addBotMessage(`å·²æˆåŠŸè§£ææ–‡ä»¶ï¼ŒåŒ…å« ${parsedData.length} ä¸ªç«™ç‚¹æ•°æ®ã€‚è¯†åˆ«åˆ°çš„é¡¹ç›®ï¼š${parsedCols.join('ã€')}ã€‚`);
                renderTable(parsedData);
                runEvalBtn.disabled = false;
                runEvalBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            }

            // æ¸²æŸ“è¡¨æ ¼
            function renderTable(data) {
                tableBody.innerHTML = '';
                data.forEach(row => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-slate-50 transition-colors';
                    tr.innerHTML = `
                        <td class="px-1 py-2 font-medium text-xs sticky left-0 bg-white z-10">${row['ç«™ç‚¹åç§°']}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°´ä½'] !== null ? row['æ°´ä½'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æµé€Ÿ'] !== null ? row['æµé€Ÿ'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æµé‡'] !== null ? row['æµé‡'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°”æ¸©'] !== null ? row['æ°”æ¸©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°´æ¸©'] !== null ? row['æ°´æ¸©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['pHå€¼'] !== null ? row['pHå€¼'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç”µå¯¼ç‡'] !== null ? row['ç”µå¯¼ç‡'] : '-'}</td>
                        <td class="px-1 py-2 text-xs font-medium">${row['æº¶è§£æ°§'] !== null ? row['æº¶è§£æ°§'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é«˜é”°é…¸ç›æŒ‡æ•°'] !== null ? row['é«˜é”°é…¸ç›æŒ‡æ•°'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['åŒ–å­¦éœ€æ°§é‡'] !== null ? row['åŒ–å­¦éœ€æ°§é‡'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] !== null ? row['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°¨æ°®'] !== null ? row['æ°¨æ°®'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ€»æ°®'] !== null ? row['æ€»æ°®'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ€»ç£·'] !== null ? row['æ€»ç£·'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é“œ'] !== null ? row['é“œ'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é”Œ'] !== null ? row['é”Œ'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°ŸåŒ–ç‰©'] !== null ? row['æ°ŸåŒ–ç‰©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç¡’'] !== null ? row['ç¡’'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç ·'] !== null ? row['ç ·'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ±'] !== null ? row['æ±'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é•‰'] !== null ? row['é•‰'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é“¬å…­ä»·'] !== null ? row['é“¬å…­ä»·'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é“…'] !== null ? row['é“…'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°°åŒ–ç‰©'] !== null ? row['æ°°åŒ–ç‰©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æŒ¥å‘é…š'] !== null ? row['æŒ¥å‘é…š'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['çŸ³æ²¹ç±»'] !== null ? row['çŸ³æ²¹ç±»'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] !== null ? row['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç¡«åŒ–ç‰©'] !== null ? row['ç¡«åŒ–ç‰©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['å¶ç»¿ç´ a'] !== null ? row['å¶ç»¿ç´ a'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é€æ˜åº¦'] !== null ? row['é€æ˜åº¦'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç¡é…¸ç›æ°®'] !== null ? row['ç¡é…¸ç›æ°®'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é“'] !== null ? row['é“'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é”°'] !== null ? row['é”°'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ°¯åŒ–ç‰©'] !== null ? row['æ°¯åŒ–ç‰©'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç¡«é…¸ç›'] !== null ? row['ç¡«é…¸ç›'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç²ªå¤§è‚ èŒç¾¤'] !== null ? row['ç²ªå¤§è‚ èŒç¾¤'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['æ€»ç¡¬åº¦'] !== null ? row['æ€»ç¡¬åº¦'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é’™'] !== null ? row['é’™'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é•'] !== null ? row['é•'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['ç¢³é…¸ç›'] !== null ? row['ç¢³é…¸ç›'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é‡ç¢³é…¸ç›'] !== null ? row['é‡ç¢³é…¸ç›'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['çŸ¿åŒ–åº¦'] !== null ? row['çŸ¿åŒ–åº¦'] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é’ '] !== null ? row['é’ '] : '-'}</td>
                        <td class="px-1 py-2 text-xs">${row['é’¾'] !== null ? row['é’¾'] : '-'}</td>
                        <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge bg-gray-100 text-gray-500">-</span></td>
                        <td class="px-1 py-2 text-xs bg-amber-50 text-xs text-slate-400">-</td>
                        <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge bg-gray-100 text-gray-500">-</span></td>
                        <td class="px-1 py-2 text-xs bg-amber-50">-</td>
                    `;
                    tableBody.appendChild(tr);
                });
                
                // å¡«å……æ€»ç£·æ¹–åº“æ ‡å‡†é€‰æ‹©ä¸‹æ‹‰æ¡†
                const stationNames = [...new Set(data.map(r => r['ç«™ç‚¹åç§°']).filter(n => n))];
                const saved = displayConfig.lakeTPStations || [];
                
                const lakeTPOptions = document.getElementById('lakeTPOptions');
                lakeTPOptions.innerHTML = '';
                stationNames.forEach(name => {
                    const div = document.createElement('div');
                    div.className = 'flex items-center gap-2 py-1 hover:bg-slate-50 cursor-pointer';
                    div.innerHTML = `
                        <input type="checkbox" value="${name}" id="lakeTP_${name}" ${saved.includes(name) ? 'checked' : ''}>
                        <label for="lakeTP_${name}" class="cursor-pointer text-xs">${name}</label>
                    `;
                    lakeTPOptions.appendChild(div);
                });
                
                // æ›´æ–°æŒ‰é’®æ–‡å­—
                updateLakeTPBtn();
            }

            function updateLakeTPBtn() {
                const btn = document.getElementById('lakeTPBtn');
                const checkboxes = document.querySelectorAll('#lakeTPOptions input[type="checkbox"]:checked');
                if (checkboxes.length === 0) {
                    btn.textContent = '--æ¹–åº“ç«™ç‚¹--';
                } else {
                    btn.textContent = `å·²é€‰${checkboxes.length}ä¸ª`;
                }
                displayConfig.lakeTPStations = Array.from(checkboxes).map(cb => cb.value);
            }

            // æ¹–åº“ç«™ç‚¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            document.getElementById('lakeTPBtn').addEventListener('click', function(e) {
                const dropdown = document.getElementById('lakeTPDropdown');
                if (dropdown.classList.contains('hidden')) {
                    dropdown.classList.remove('hidden');
                } else {
                    dropdown.classList.add('hidden');
                }
            });

            document.addEventListener('click', function(e) {
                const dropdown = document.getElementById('lakeTPDropdown');
                const btn = document.getElementById('lakeTPBtn');
                if (!dropdown.contains(e.target) && e.target !== btn) {
                    dropdown.classList.add('hidden');
                }
            });

            document.getElementById('lakeTPDropdown').addEventListener('click', function(e) {
                e.stopPropagation();
            });

            document.getElementById('lakeTPOptions').addEventListener('change', function(e) {
                if (e.target.type === 'checkbox') {
                    updateLakeTPBtn();
                }
            });

            // æ¹–åº“è¯„åˆ†è¡¨æŒ‰é’®
            document.getElementById('showLakeStandard').addEventListener('click', function() {
                const modal = document.getElementById('standardModal');
                const title = document.getElementById('standardModalTitle');
                const content = document.getElementById('standardModalContent');
                title.textContent = 'æ¹–åº“è¯„åˆ†è¡¨ (TLIè¥å…»çŠ¶æ€æŒ‡æ•°)';
                content.innerHTML = `
                    <table class="w-full text-sm border-collapse">
                        <thead class="bg-blue-50">
                            <tr><th class="border px-2 py-1">è¥å…»çŠ¶æ€</th><th class="border px-2 py-1">TLIæŒ‡æ•°</th><th class="border px-2 py-1">è¯´æ˜</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="border px-2 py-1 bg-blue-100">è´«è¥å…»</td><td class="border px-2 py-1">TLI < 30</td><td class="border px-2 py-1">æ°´è´¨ä¼˜ï¼Œè—»ç±»å°‘</td></tr>
                            <tr><td class="border px-2 py-1 bg-green-100">ä¸­è¥å…»</td><td class="border px-2 py-1">30 â‰¤ TLI < 50</td><td class="border px-2 py-1">æ°´è´¨è‰¯å¥½</td></tr>
                            <tr><td class="border px-2 py-1 bg-yellow-100">è½»åº¦å¯Œè¥å…»</td><td class="border px-2 py-1">50 â‰¤ TLI < 60</td><td class="border px-2 py-1">æ°´è´¨è½»åº¦æ±¡æŸ“</td></tr>
                            <tr><td class="border px-2 py-1 bg-orange-100">ä¸­åº¦å¯Œè¥å…»</td><td class="border px-2 py-1">60 â‰¤ TLI < 70</td><td class="border px-2 py-1">æ°´è´¨ä¸­åº¦æ±¡æŸ“</td></tr>
                            <tr><td class="border px-2 py-1 bg-red-100">é‡åº¦å¯Œè¥å…»</td><td class="border px-2 py-1">TLI â‰¥ 70</td><td class="border px-2 py-1">æ°´è´¨ä¸¥é‡æ±¡æŸ“</td></tr>
                        </tbody>
                    </table>
                    <p class="mt-4 text-sm text-slate-600">TLIè®¡ç®—å‚æ•°ï¼šå¶ç»¿ç´ aã€æ€»ç£·ã€æ€»æ°®ã€é«˜é”°é…¸ç›æŒ‡æ•°ã€é€æ˜åº¦ï¼ˆå¿…é¡»5é¡¹å…¨æœ‰ï¼‰</p>
                `;
                modal.classList.remove('hidden');
                lucide.createIcons();
            });

            // GB3838æ ‡å‡†æŒ‰é’®
            document.getElementById('showGBStandard').addEventListener('click', function() {
                const modal = document.getElementById('standardModal');
                const title = document.getElementById('standardModalTitle');
                const content = document.getElementById('standardModalContent');
                title.textContent = 'GB3838-2002 åœ°è¡¨æ°´ç¯å¢ƒè´¨é‡æ ‡å‡†';
                content.innerHTML = `
                    <p class="mb-2 text-sm font-bold text-slate-700">åŸºæœ¬é¡¹ç›®æ ‡å‡†é™å€¼ï¼ˆmg/Lï¼‰</p>
                    <table class="w-full text-xs border-collapse mb-4">
                        <thead class="bg-green-50">
                            <tr><th class="border px-1 py-1">åºå·</th><th class="border px-1 py-1">é¡¹ç›®</th><th class="border px-1 py-1">â… ç±»</th><th class="border px-1 py-1">â…¡ç±»</th><th class="border px-1 py-1">â…¢ç±»</th><th class="border px-1 py-1">â…£ç±»</th><th class="border px-1 py-1">â…¤ç±»</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="border px-1 py-1">1</td><td class="border px-1 py-1">pHå€¼ï¼ˆæ— é‡çº²ï¼‰</td><td class="border px-1 py-1" colspan="5">6ï½9</td></tr>
                            <tr><td class="border px-1 py-1">2</td><td class="border px-1 py-1">æº¶è§£æ°§ â‰¥</td><td class="border px-1 py-1">7.5</td><td class="border px-1 py-1">6</td><td class="border px-1 py-1">5</td><td class="border px-1 py-1">3</td><td class="border px-1 py-1">2</td></tr>
                            <tr><td class="border px-1 py-1">3</td><td class="border px-1 py-1">é«˜é”°é…¸ç›æŒ‡æ•° â‰¤</td><td class="border px-1 py-1">2</td><td class="border px-1 py-1">4</td><td class="border px-1 py-1">6</td><td class="border px-1 py-1">10</td><td class="border px-1 py-1">15</td></tr>
                            <tr><td class="border px-1 py-1">4</td><td class="border px-1 py-1">åŒ–å­¦éœ€æ°§é‡ â‰¤</td><td class="border px-1 py-1">15</td><td class="border px-1 py-1">15</td><td class="border px-1 py-1">20</td><td class="border px-1 py-1">30</td><td class="border px-1 py-1">40</td></tr>
                            <tr><td class="border px-1 py-1">5</td><td class="border px-1 py-1">äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡ â‰¤</td><td class="border px-1 py-1">3</td><td class="border px-1 py-1">3</td><td class="border px-1 py-1">4</td><td class="border px-1 py-1">6</td><td class="border px-1 py-1">10</td></tr>
                            <tr><td class="border px-1 py-1">6</td><td class="border px-1 py-1">æ°¨æ°® â‰¤</td><td class="border px-1 py-1">0.15</td><td class="border px-1 py-1">0.5</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.5</td><td class="border px-1 py-1">2.0</td></tr>
                            <tr><td class="border px-1 py-1">7</td><td class="border px-1 py-1">æ€»ç£· â‰¤ï¼ˆæ²³æµï¼‰</td><td class="border px-1 py-1">0.02</td><td class="border px-1 py-1">0.1</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.3</td><td class="border px-1 py-1">0.6</td></tr>
                            <tr><td class="border px-1 py-1">8</td><td class="border px-1 py-1">æ€»æ°® â‰¤</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.5</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.5</td><td class="border px-1 py-1">2.0</td></tr>
                            <tr><td class="border px-1 py-1">9</td><td class="border px-1 py-1">é“œ â‰¤</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td></tr>
                            <tr><td class="border px-1 py-1">10</td><td class="border px-1 py-1">é”Œ â‰¤</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">2.0</td><td class="border px-1 py-1">2.0</td></tr>
                            <tr><td class="border px-1 py-1">11</td><td class="border px-1 py-1">æ°ŸåŒ–ç‰© â‰¤</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.5</td><td class="border px-1 py-1">1.5</td></tr>
                            <tr><td class="border px-1 py-1">12</td><td class="border px-1 py-1">ç¡’ â‰¤</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.02</td><td class="border px-1 py-1">0.02</td></tr>
                            <tr><td class="border px-1 py-1">13</td><td class="border px-1 py-1">ç · â‰¤</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.1</td><td class="border px-1 py-1">0.1</td></tr>
                            <tr><td class="border px-1 py-1">14</td><td class="border px-1 py-1">æ± â‰¤</td><td class="border px-1 py-1">0.00005</td><td class="border px-1 py-1">0.00005</td><td class="border px-1 py-1">0.0001</td><td class="border px-1 py-1">0.001</td><td class="border px-1 py-1">0.001</td></tr>
                            <tr><td class="border px-1 py-1">15</td><td class="border px-1 py-1">é•‰ â‰¤</td><td class="border px-1 py-1">0.001</td><td class="border px-1 py-1">0.005</td><td class="border px-1 py-1">0.005</td><td class="border px-1 py-1">0.005</td><td class="border px-1 py-1">0.01</td></tr>
                            <tr><td class="border px-1 py-1">16</td><td class="border px-1 py-1">é“¬ï¼ˆå…­ä»·ï¼‰â‰¤</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.1</td></tr>
                            <tr><td class="border px-1 py-1">17</td><td class="border px-1 py-1">é“… â‰¤</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.1</td></tr>
                            <tr><td class="border px-1 py-1">18</td><td class="border px-1 py-1">æ°°åŒ–ç‰© â‰¤</td><td class="border px-1 py-1">0.005</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.2</td></tr>
                            <tr><td class="border px-1 py-1">19</td><td class="border px-1 py-1">æŒ¥å‘é…š â‰¤</td><td class="border px-1 py-1">0.002</td><td class="border px-1 py-1">0.002</td><td class="border px-1 py-1">0.005</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.1</td></tr>
                            <tr><td class="border px-1 py-1">20</td><td class="border px-1 py-1">çŸ³æ²¹ç±» â‰¤</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.5</td><td class="border px-1 py-1">1.0</td></tr>
                            <tr><td class="border px-1 py-1">21</td><td class="border px-1 py-1">é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚ â‰¤</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.3</td><td class="border px-1 py-1">0.3</td><td class="border px-1 py-1">0.3</td></tr>
                            <tr><td class="border px-1 py-1">22</td><td class="border px-1 py-1">ç¡«åŒ–ç‰© â‰¤</td><td class="border px-1 py-1">0.02</td><td class="border px-1 py-1">0.1</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.5</td><td class="border px-1 py-1">1.0</td></tr>
                            <tr><td class="border px-1 py-1">23</td><td class="border px-1 py-1">ç²ªå¤§è‚ èŒç¾¤ â‰¤</td><td class="border px-1 py-1">200</td><td class="border px-1 py-1">2000</td><td class="border px-1 py-1">10000</td><td class="border px-1 py-1">20000</td><td class="border px-1 py-1">40000</td></tr>
                        </tbody>
                    </table>
                    <p class="mb-2 text-sm font-bold text-slate-700">æ¹–åº“è¡¥å……é¡¹ç›®æ ‡å‡†é™å€¼ï¼ˆmg/Lï¼‰</p>
                    <table class="w-full text-xs border-collapse">
                        <thead class="bg-blue-50">
                            <tr><th class="border px-1 py-1">é¡¹ç›®</th><th class="border px-1 py-1">â… ç±»</th><th class="border px-1 py-1">â…¡ç±»</th><th class="border px-1 py-1">â…¢ç±»</th><th class="border px-1 py-1">â…£ç±»</th><th class="border px-1 py-1">â…¤ç±»</th></tr>
                        </thead>
                        <tbody>
                            <tr><td class="border px-1 py-1">æ€»ç£· â‰¤</td><td class="border px-1 py-1">0.01</td><td class="border px-1 py-1">0.025</td><td class="border px-1 py-1">0.05</td><td class="border px-1 py-1">0.1</td><td class="border px-1 py-1">0.2</td></tr>
                            <tr><td class="border px-1 py-1">æ€»æ°® â‰¤</td><td class="border px-1 py-1">0.2</td><td class="border px-1 py-1">0.3</td><td class="border px-1 py-1">0.5</td><td class="border px-1 py-1">1.0</td><td class="border px-1 py-1">1.5</td></tr>
                            <tr><td class="border px-1 py-1">å¶ç»¿ç´ a â‰¤ (Î¼g/L)</td><td class="border px-1 py-1">1</td><td class="border px-1 py-1">2</td><td class="border px-1 py-1">4</td><td class="border px-1 py-1">8</td><td class="border px-1 py-1">10</td></tr>
                        </tbody>
                    </table>
                `;
                modal.classList.remove('hidden');
                lucide.createIcons();
            });

            // åˆ¤æ–­æ˜¯å¦ä¸ºæ¹–åº“
            function isLake(stationName, waterBodyName) {
                const name = (stationName || '') + (waterBodyName || '');
                return LAKE_KEYWORDS.some(keyword => name.includes(keyword));
            }

            // GB3838-2002 å•å› å­è¯„ä»·ï¼ˆå®Œæ•´ç‰ˆï¼‰
            function evaluateGB3838(row, options = {}) {
                const useCOD = options.useCOD !== undefined ? options.useCOD : null;
                
                const stationName = row['ç«™ç‚¹åç§°'] || '';
                const waterBodyName = row['æ‰€åœ¨æ°´ä½“åç§°'] || '';
                const isLakeType = isLake(stationName, waterBodyName);
                
                // æ£€æŸ¥æ˜¯å¦æœ‰å¯è¯„ä»·çš„æ•°æ®
                const hasData = row['æº¶è§£æ°§'] !== null || row['é«˜é”°é…¸ç›æŒ‡æ•°'] !== null || row['æ°¨æ°®'] !== null || 
                               row['æ€»ç£·'] !== null || row['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] !== null || row['åŒ–å­¦éœ€æ°§é‡'] !== null ||
                               row['pHå€¼'] !== null || row['ç²ªå¤§è‚ èŒç¾¤'] !== null;
                
                if (!hasData) {
                    return { 
                        class: null, 
                        worstParam: '', 
                        isLake: isLakeType,
                        exceedanceRatio: 0,
                        exceedanceDetails: []
                    };
                }
                
                // æ ¹æ®æ°´ä½“ç±»å‹é€‰æ‹©è¯„ä»·æ ‡å‡†
                let tpStandards;
                if (displayConfig.lakeTPStations && displayConfig.lakeTPStations.includes(stationName)) {
                    tpStandards = GB3838_LAKE['æ€»ç£·'];  // è¯¥ç«™ç‚¹ä½¿ç”¨æ¹–åº“æ ‡å‡†
                } else {
                    tpStandards = GB3838_RIVER['æ€»ç£·'];  // é»˜è®¤ä½¿ç”¨æ²³æµæ ‡å‡†
                }
                const tnStandards = GB3838_RIVER['æ€»æ°®'];  // æ€»æ°®ä¹Ÿä½¿ç”¨æ²³æµæ ‡å‡†
                
                let worstClass = 'â… ';
                let worstParam = '';
                let exceedanceRatio = 0;
                let exceedanceDetails = [];
                
                // æ™ºèƒ½åˆ¤æ–­ï¼šCOD>=30æ—¶åªè¯„ä»·CODï¼ŒCOD<30æ—¶åªè¯„ä»·é«˜é”°é…¸ç›æŒ‡æ•°ï¼Œæ€»æ°®ä¸å‚ä¸è¯„ä»·
                const codValue = row['åŒ–å­¦éœ€æ°§é‡'];
                const codValueNum = parseFloat(codValue);
                // useCOD: true=è‡ªåŠ¨åˆ¤æ–­, false=å›ºå®šç”¨COD, null=å›ºå®šç”¨é«˜é”°
                const shouldUseCOD = useCOD === true ? (codValueNum >= 30) : useCOD;
                
                // æ ¹æ®æ¡ä»¶åŠ¨æ€æ„å»ºå‚è¯„åˆ—è¡¨
                let basicParams;
                if (shouldUseCOD) {
                    // COD>=30ï¼šåªè¯„åŒ–å­¦éœ€æ°§é‡ï¼Œä¸è¯„é«˜é”°é…¸ç›æŒ‡æ•°
                    basicParams = ['pHå€¼', 'æº¶è§£æ°§', 'åŒ–å­¦éœ€æ°§é‡', 'æ°¨æ°®', 'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡', 'ç²ªå¤§è‚ èŒç¾¤'];
                } else {
                    // COD<30ï¼šåªè¯„é«˜é”°é…¸ç›æŒ‡æ•°ï¼Œä¸è¯„åŒ–å­¦éœ€æ°§é‡
                    basicParams = ['pHå€¼', 'æº¶è§£æ°§', 'é«˜é”°é…¸ç›æŒ‡æ•°', 'æ°¨æ°®', 'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡', 'ç²ªå¤§è‚ èŒç¾¤'];
                }
                
                const allParams = [...basicParams];
                if (row['æ€»ç£·'] !== null) allParams.push('æ€»ç£·');
                // æ€»æ°®ä¸å‚ä¸è¯„ä»·
                
                for (const param of allParams) {
                    // è·³è¿‡è¢«æ’é™¤çš„å‚æ•°
                    if (displayConfig.excludedParams.includes(param)) continue;
                    
                    const value = row[param];
                    if (value === null || value === undefined) continue;
                    
                    let standards;
                    if (param === 'æ€»ç£·') standards = tpStandards;
                    else if (param === 'æ€»æ°®') standards = tnStandards;
                    else standards = GB3838_COMMON[param];
                    
                    if (!standards) continue;
                    
                    let currentClass = 'â… ';
                    let isExceed = false;
                    let paramExceedRatio = 0;
                    
                    // pHå€¼ç‰¹æ®Šå¤„ç†ï¼ˆèŒƒå›´åˆ¤æ–­ï¼‰
                    if (param === 'pHå€¼') {
                        const min = standards['â… '][0];
                        const max = standards['â… '][1];
                        if (value >= min && value <= max) currentClass = 'â… ';
                        else if (value >= 5 && value < 6) { currentClass = 'â…¤'; isExceed = true; }
                        else if (value < 5) { currentClass = 'â…¤'; isExceed = true; }
                        else if (value > 9) { currentClass = 'â…¤'; isExceed = true; }
                        else {
                            for (let cls of ['â…¡', 'â…¢', 'â…£']) {
                                const r = standards[cls];
                                if (value >= r[0] && value <= r[1]) { currentClass = cls; break; }
                            }
                        }
                    } 
                    // æº¶è§£æ°§æ˜¯è¶Šå¤§è¶Šå¥½ï¼Œå…¶ä»–æŒ‡æ ‡è¶Šå°è¶Šå¥½
                    else if (param === 'æº¶è§£æ°§') {
                        if (value >= standards['â… ']) currentClass = 'â… ';
                        else if (value >= standards['â…¡']) currentClass = 'â…¡';
                        else if (value >= standards['â…¢']) currentClass = 'â…¢';
                        else if (value >= standards['â…£']) { currentClass = 'â…£'; isExceed = true; paramExceedRatio = (standards['â…¢'] - value) / standards['â…¢']; }
                        else { currentClass = 'â…¤'; isExceed = true; paramExceedRatio = (standards['â…¢'] - value) / standards['â…¢']; }
                    } else {
                        // å…¶ä»–æŒ‡æ ‡è¶Šå°è¶Šå¥½ï¼Œè®¡ç®—ç›¸å¯¹äºâ…¢ç±»æ ‡å‡†çš„è¶…æ ‡å€æ•°
                        if (value <= standards['â… ']) currentClass = 'â… ';
                        else if (value <= standards['â…¡']) currentClass = 'â…¡';
                        else if (value <= standards['â…¢']) currentClass = 'â…¢';
                        else if (value <= standards['â…£']) { currentClass = 'â…£'; isExceed = true; paramExceedRatio = (value - standards['â…¢']) / standards['â…¢']; }
                        else { currentClass = 'â…¤'; isExceed = true; paramExceedRatio = (value - standards['â…¢']) / standards['â…¢']; }
                    }
                    
                    if (isExceed) {
                        exceedanceDetails.push({ param: param, value: value, stdIII: standards['â…¢'], ratio: paramExceedRatio });
                    }
                    
                    // æ›´æ–°æœ€å·®ç­‰çº§
                    const classOrder = { 'â… ': 1, 'â…¡': 2, 'â…¢': 3, 'â…£': 4, 'â…¤': 5 };
                    if (classOrder[currentClass] > classOrder[worstClass]) {
                        worstClass = currentClass;
                        worstParam = param;
                        exceedanceRatio = paramExceedRatio;
                    }
                }
                
                // è¯„ä»·é‡é‡‘å±å’Œæœ‰æ¯’ç‰©è´¨
                const heavyParams = ['é“œ', 'é”Œ', 'æ±', 'ç ·', 'é•‰', 'é“¬å…­ä»·', 'é“…', 'æ°°åŒ–ç‰©', 'æŒ¥å‘é…š', 'çŸ³æ²¹ç±»', 'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚', 'ç¡«åŒ–ç‰©'];
                for (const param of heavyParams) {
                    // è·³è¿‡è¢«æ’é™¤çš„å‚æ•°
                    if (displayConfig.excludedParams.includes(param)) continue;
                    
                    const value = row[param];
                    if (value === null || value === undefined) continue;
                    
                    const standards = GB3838_HEAVY[param];
                    if (!standards) continue;
                    
                    let currentClass = 'â… ';
                    let isExceed = false;
                    let paramExceedRatio = 0;
                    
                    if (value <= standards['â… ']) currentClass = 'â… ';
                    else if (value <= standards['â…¡']) currentClass = 'â…¡';
                    else if (value <= standards['â…¢']) currentClass = 'â…¢';
                    else if (value <= standards['â…£']) { currentClass = 'â…£'; isExceed = true; paramExceedRatio = (value - standards['â…¢']) / standards['â…¢']; }
                    else { currentClass = 'â…¤'; isExceed = true; paramExceedRatio = (value - standards['â…¢']) / standards['â…¢']; }
                    
                    if (isExceed) {
                        exceedanceDetails.push({ param: param, value: value, stdIII: standards['â…¢'], ratio: paramExceedRatio });
                    }
                    
                    const classOrder = { 'â… ': 1, 'â…¡': 2, 'â…¢': 3, 'â…£': 4, 'â…¤': 5 };
                    if (classOrder[currentClass] > classOrder[worstClass]) {
                        worstClass = currentClass;
                        worstParam = param;
                        exceedanceRatio = paramExceedRatio;
                    }
                }
                
                return { 
                    class: worstClass, 
                    worstParam: worstParam, 
                    isLake: isLakeType,
                    exceedanceRatio: exceedanceRatio,
                    exceedanceDetails: exceedanceDetails
                };
            }

            // TLI è¥å…»çŠ¶æ€æŒ‡æ•°è®¡ç®—ï¼ˆä»…æ¹–åº“éœ€è¦è®¡ç®—ï¼‰
            function calculateTLI(row) {
                const stationName = row['ç«™ç‚¹åç§°'] || '';
                const waterBodyName = row['æ‰€åœ¨æ°´ä½“åç§°'] || '';
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºæ¹–åº“ç«™ç‚¹
                const isSelectedLake = displayConfig.lakeTPStations && displayConfig.lakeTPStations.includes(stationName);
                
                // åªæœ‰æ¹–åº“ç«™ç‚¹æ‰è®¡ç®—TLIï¼Œå…¶ä»–ä¸è®¡ç®—
                if (!isSelectedLake) {
                    return { tli: null, status: 'ä¸è¯„ä»·' };
                }

                const hasChla = row['å¶ç»¿ç´ a'] !== null && row['å¶ç»¿ç´ a'] > 0;
                const hasTP = row['æ€»ç£·'] !== null && row['æ€»ç£·'] > 0;
                const hasTN = row['æ€»æ°®'] !== null && row['æ€»æ°®'] > 0;
                const hasCOD = row['é«˜é”°é…¸ç›æŒ‡æ•°'] !== null && row['é«˜é”°é…¸ç›æŒ‡æ•°'] > 0;
                const hasSD = row['é€æ˜åº¦'] !== null && row['é€æ˜åº¦'] > 0;

                // è¦æ±‚5é¡¹å…¨éƒ¨æœ‰æ•°æ®æ‰èƒ½è®¡ç®—TLI
                const validCount = [hasChla, hasTP, hasTN, hasCOD, hasSD].filter(v => v).length;
                if (validCount < 5) {
                    return { tli: null, status: 'æ•°æ®ä¸è¶³', details: `æœ‰${validCount}é¡¹` };
                }

                let tliSum = 0;
                let count = 0;

                if (hasChla) {
                    const chla = row['å¶ç»¿ç´ a'] * 1000;
                    const tli = 10 * (2.5 + 1.086 * Math.log(chla));
                    console.log(`å¶ç»¿ç´ a=${chla}Î¼g/L, TLI=${tli.toFixed(2)}`);
                    tliSum += tli;
                    count++;
                }
                if (hasTP) {
                    const tp = row['æ€»ç£·'];
                    const tli = 10 * (9.436 + 1.624 * Math.log(tp));
                    console.log(`æ€»ç£·=${tp}mg/L, TLI=${tli.toFixed(2)}`);
                    tliSum += tli;
                    count++;
                }
                if (hasTN) {
                    const tn = row['æ€»æ°®'];
                    const tli = 10 * (5.453 + 1.694 * Math.log(tn));
                    console.log(`æ€»æ°®=${tn}mg/L, TLI=${tli.toFixed(2)}`);
                    tliSum += tli;
                    count++;
                }
                if (hasCOD) {
                    const cod = row['é«˜é”°é…¸ç›æŒ‡æ•°'];
                    const tli = 10 * (0.109 + 2.619 * Math.log(cod));
                    console.log(`é«˜é”°é…¸ç›æŒ‡æ•°=${cod}mg/L, TLI=${tli.toFixed(2)}`);
                    tliSum += tli;
                    count++;
                }
                if (hasSD) {
                    const sd = row['é€æ˜åº¦'];
                    const tli = 10 * (5.118 - 1.588 * Math.log(sd));
                    console.log(`é€æ˜åº¦=${sd}m, TLI=${tli.toFixed(2)}`);
                    tliSum += tli;
                    count++;
                }

                const tliIndex = count > 0 ? (tliSum / count).toFixed(1) : null;
                console.log(`TLIè®¡ç®—: tliSum=${tliSum}, count=${count}, tliIndex=${tliIndex}`);

                let status = '';
                if (tliIndex === null) status = 'æ•°æ®ä¸è¶³';
                else if (tliIndex < 30) status = 'è´«è¥å…»';
                else if (tliIndex < 50) status = 'ä¸­è¥å…»';
                else if (tliIndex < 60) status = 'è½»åº¦å¯Œè¥å…»';
                else if (tliIndex < 70) status = 'ä¸­åº¦å¯Œè¥å…»';
                else status = 'é‡åº¦å¯Œè¥å…»';

                return { tli: tliIndex, status };
            }

            // è·å–ç­‰çº§å¾½ç« æ ·å¼
            function getClassBadge(className) {
                const colors = {
                    'â… ': 'bg-blue-100 text-blue-700',
                    'â…¡': 'bg-green-100 text-green-700',
                    'â…¢': 'bg-yellow-100 text-yellow-700',
                    'â…£': 'bg-orange-100 text-orange-700',
                    'â…¤': 'bg-red-100 text-red-700'
                };
                return colors[className] || 'bg-gray-100 text-gray-700';
            }

            // è·å–å¯Œè¥å…»åŒ–çŠ¶æ€å¾½ç« æ ·å¼
            function getEutrophicationBadge(status) {
                const colors = {
                    'è´«è¥å…»': 'bg-blue-100 text-blue-700',
                    'ä¸­è¥å…»': 'bg-green-100 text-green-700',
                    'è½»åº¦å¯Œè¥å…»': 'bg-yellow-100 text-yellow-700',
                    'ä¸­åº¦å¯Œè¥å…»': 'bg-orange-100 text-orange-700',
                    'é‡åº¦å¯Œè¥å…»': 'bg-red-100 text-red-700'
                };
                return colors[status] || 'bg-gray-100 text-gray-700';
            }

            // å¼€å§‹æ™ºèƒ½è¯„ä»·
            runEvalBtn.addEventListener('click', function() {
                if (parsedData.length === 0) {
                    addBotMessage("è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶ï¼");
                    return;
                }

                const evalMode = 'gb3838';
                
                this.innerHTML = `<i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> è¯„ä»·ä¸­...`;
                lucide.createIcons();

                setTimeout(() => {
                    evaluationResults = parsedData.map(row => {
                        const gbResult = evaluateGB3838(row, { useCOD: displayConfig.autoCOD });
                        const tliResult = calculateTLI(row);
                        
                        // ç»Ÿä¸€ä½¿ç”¨GB3838è¯„ä»·
                        let displayClass = gbResult.class;
                        let displayStatus = tliResult.status;
                        let displayTli = tliResult.tli;
                        
                        return {
                            ...row,
                            gbClass: displayClass,
                            worstParam: gbResult.worstParam,
                            tli: displayTli,
                            eutrophicStatus: displayStatus,
                            exceedanceRatio: gbResult.exceedanceRatio,
                            exceedanceDetails: gbResult.exceedanceDetails
                        };
                    });

                    // æ›´æ–°è¡¨æ ¼æ˜¾ç¤ºè¯„ä»·ç»“æœ
                    const rows = tableBody.querySelectorAll('tr');
                    evaluationResults.forEach((result, index) => {
                        if (rows[index]) {
                            // è¶…æ ‡é¡¹ç›®åŠå€æ•°æ˜¾ç¤º - æ™ºèƒ½å°æ•°ä½æ•°ï¼ŒæŒ‰å€æ•°ä»å¤§åˆ°å°æ’åº
                            let exceedInfo = '';
                            if (result.exceedanceDetails && result.exceedanceDetails.length > 0) {
                                // æŒ‰è¶…æ ‡å€æ•°ä»å¤§åˆ°å°æ’åº
                                const sortedDetails = [...result.exceedanceDetails].sort((a, b) => b.ratio - a.ratio);
                                const exceedStrs = sortedDetails.map(item => {
                                    // æ™ºèƒ½å°æ•°ä½æ•°ï¼š>=0.05æ˜¾ç¤º1ä½ï¼Œ<0.05æ˜¾ç¤º2ä½
                                    const decimal = item.ratio >= 0.05 ? 1 : 2;
                                    const ratio = item.ratio.toFixed(decimal);
                                    return `${item.param}ï¼ˆ${ratio}ï¼‰`;
                                });
                                exceedInfo = exceedStrs.join('ã€');
                            }
                            
                            rows[index].innerHTML = `
                                <td class="px-1 py-2 font-medium text-xs sticky left-0 bg-white z-10">${result['ç«™ç‚¹åç§°']}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°´ä½'] !== null ? result['æ°´ä½'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æµé€Ÿ'] !== null ? result['æµé€Ÿ'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æµé‡'] !== null ? result['æµé‡'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°”æ¸©'] !== null ? result['æ°”æ¸©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°´æ¸©'] !== null ? result['æ°´æ¸©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['pHå€¼'] !== null ? result['pHå€¼'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç”µå¯¼ç‡'] !== null ? result['ç”µå¯¼ç‡'] : '-'}</td>
                                <td class="px-1 py-2 text-xs font-medium">${result['æº¶è§£æ°§'] !== null ? result['æº¶è§£æ°§'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é«˜é”°é…¸ç›æŒ‡æ•°'] !== null ? result['é«˜é”°é…¸ç›æŒ‡æ•°'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['åŒ–å­¦éœ€æ°§é‡'] !== null ? result['åŒ–å­¦éœ€æ°§é‡'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] !== null ? result['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°¨æ°®'] !== null ? result['æ°¨æ°®'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ€»æ°®'] !== null ? result['æ€»æ°®'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ€»ç£·'] !== null ? result['æ€»ç£·'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é“œ'] !== null ? result['é“œ'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é”Œ'] !== null ? result['é”Œ'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°ŸåŒ–ç‰©'] !== null ? result['æ°ŸåŒ–ç‰©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç¡’'] !== null ? result['ç¡’'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç ·'] !== null ? result['ç ·'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ±'] !== null ? result['æ±'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é•‰'] !== null ? result['é•‰'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é“¬å…­ä»·'] !== null ? result['é“¬å…­ä»·'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é“…'] !== null ? result['é“…'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°°åŒ–ç‰©'] !== null ? result['æ°°åŒ–ç‰©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æŒ¥å‘é…š'] !== null ? result['æŒ¥å‘é…š'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['çŸ³æ²¹ç±»'] !== null ? result['çŸ³æ²¹ç±»'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] !== null ? result['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç¡«åŒ–ç‰©'] !== null ? result['ç¡«åŒ–ç‰©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['å¶ç»¿ç´ a'] !== null ? result['å¶ç»¿ç´ a'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é€æ˜åº¦'] !== null ? result['é€æ˜åº¦'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç¡é…¸ç›æ°®'] !== null ? result['ç¡é…¸ç›æ°®'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é“'] !== null ? result['é“'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é”°'] !== null ? result['é”°'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ°¯åŒ–ç‰©'] !== null ? result['æ°¯åŒ–ç‰©'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç¡«é…¸ç›'] !== null ? result['ç¡«é…¸ç›'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç²ªå¤§è‚ èŒç¾¤'] !== null ? result['ç²ªå¤§è‚ èŒç¾¤'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['æ€»ç¡¬åº¦'] !== null ? result['æ€»ç¡¬åº¦'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é’™'] !== null ? result['é’™'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é•'] !== null ? result['é•'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['ç¢³é…¸ç›'] !== null ? result['ç¢³é…¸ç›'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é‡ç¢³é…¸ç›'] !== null ? result['é‡ç¢³é…¸ç›'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['çŸ¿åŒ–åº¦'] !== null ? result['çŸ¿åŒ–åº¦'] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é’ '] !== null ? result['é’ '] : '-'}</td>
                                <td class="px-1 py-2 text-xs">${result['é’¾'] !== null ? result['é’¾'] : '-'}</td>
                                <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge ${result.gbClass ? getClassBadge(result.gbClass) : 'bg-gray-100 text-gray-500'}">${result.gbClass ? result.gbClass + 'ç±»' : '-'}</span></td>
                                <td class="px-1 py-2 text-xs bg-amber-50 text-red-500 font-medium">${exceedInfo || '-'}</td>
                                <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge ${getEutrophicationBadge(result.eutrophicStatus)}">${result.eutrophicStatus}</span></td>
                                <td class="px-1 py-2 text-xs bg-amber-50 font-mono text-primary font-bold">${result.tli !== null ? result.tli : '-'}</td>
                            `;
                        }
                    });

                    // ç»Ÿè®¡ä¿¡æ¯
                    const classCount = {};
                    const eutrophicCount = {};
                    evaluationResults.forEach(r => {
                        classCount[r.gbClass] = (classCount[r.gbClass] || 0) + 1;
                        eutrophicCount[r.eutrophicStatus] = (eutrophicCount[r.eutrophicStatus] || 0) + 1;
                    });

                    this.innerHTML = `<i data-lucide="check" class="w-3 h-3"></i> è¯„ä»·å®Œæˆ`;
                    lucide.createIcons();

                    // å¯ç”¨å¯¼å‡ºæŒ‰é’®
                    document.getElementById('exportBtn').disabled = false;

                    let summary = `è¯„ä»·å®Œæˆï¼å…± ${evaluationResults.length} ä¸ªç«™ç‚¹ã€‚\n`;
                    summary += `æ°´è´¨ç±»åˆ«åˆ†å¸ƒï¼š${Object.entries(classCount).map(([k,v]) => `${k}ç±»${v}ä¸ª`).join('ã€')}\n`;
                    summary += `è¥å…»çŠ¶æ€ï¼š${Object.entries(eutrophicCount).map(([k,v]) => `${k}${v}ä¸ª`).join('ã€')}`;
                    addBotMessage(summary);

                }, 1000);
            });

            // å¯¼å‡ºåŠŸèƒ½
            window.exportResults = function() {
                if (evaluationResults.length === 0) {
                    addBotMessage("è¯·å…ˆå®Œæˆè¯„ä»·å†å¯¼å‡ºç»“æœï¼");
                    return;
                }

                // åˆ›å»ºç«™ç‚¹åç§°åˆ°è¯„ä»·ç»“æœçš„æ˜ å°„
                const resultMap = {};
                evaluationResults.forEach(r => {
                    resultMap[r['ç«™ç‚¹åç§°']] = r;
                });

                // è¡¨å¤´
                const headers = [
                    'æ‰€åœ¨æ°´èµ„æºä¸‰çº§åŒº', 'æ‰€åœ¨æ°´ä½“åç§°', 'æ°´è´¨ç«™ç¼–ç ', 'ã€Šåå½•ã€‹å†…åºå·', 'æ°´è´¨ç«™åç§°',
                    'é‡‡æ ·æ—¥æœŸ', 'é‡‡æ ·æ—¶é—´', 'æ°´ä½', 'æµé€Ÿ', 'æµé‡', 'æ°”æ¸©', 'æ°´æ¸©', 'pHå€¼', 'ç”µå¯¼ç‡',
                    'æº¶è§£æ°§', 'é«˜é”°é…¸ç›æŒ‡æ•°', 'åŒ–å­¦éœ€æ°§é‡', 'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡', 'æ°¨æ°®', 'æ€»æ°®', 'æ€»ç£·',
                    'é“œ', 'é”Œ', 'æ°ŸåŒ–ç‰©', 'ç¡’', 'ç ·', 'æ±', 'é•‰', 'é“¬ï¼ˆå…­ä»·ï¼‰', 'é“…', 'æ°°åŒ–ç‰©', 'æŒ¥å‘é…š',
                    'çŸ³æ²¹ç±»', 'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚', 'ç¡«åŒ–ç‰©', 'å¶ç»¿ç´ ', 'é€æ˜åº¦', 'ç¡é…¸ç›', 'é“', 'é”°',
                    'æ°¯åŒ–ç‰©', 'ç¡«é…¸ç›', 'ç²ªå¤§è‚ èŒç¾¤', 'æ€»ç¡¬åº¦', 'é’™', 'é•', 'ç¢³é…¸ç›', 'é‡ç¢³é…¸ç›', 'çŸ¿åŒ–åº¦', 'é’ ', 'é’¾',
                    'æ°´è´¨ç±»åˆ«', 'ä¸»è¦è¶…æ ‡é¡¹ç›®åŠå€æ•°', 'è¥å…»çŠ¶æ€'
                ];

                // å•ä½è¡Œ
                const units = [
                    null, null, null, null, null, null, null, 'm', 'm/s', 'm3/s', 'â„ƒ', 'â„ƒ', null, 'us/cm', 
                    'mg/L', null, null, null, null, null, null, null, null, null, null, null, null, null, null, 
                    null, null, null, null, null, null, null, null, 'mg/L', null, null, null, null, null, null, 
                    'CFU/L', 'mg/L', null, null, null, null, null, null, null, null, null, 'mg/L'
                ];

                // æ„å»ºæ•°æ®
                const aoa = [
                    ['2026å¹´å›½å®¶é‡ç‚¹æ°´è´¨ç«™æ°´è´¨ç›‘æµ‹æˆæœè¡¨'],  // æ ‡é¢˜è¡Œ
                    headers,  // è¡¨å¤´è¡Œ
                    units  // å•ä½è¡Œ
                ];

                parsedData.forEach(row => {
                    const stationName = row['ç«™ç‚¹åç§°'];
                    const result = resultMap[stationName] || {};
                    
                    const rowData = [];
                    headers.forEach(field => {
                        if (field === 'æ°´è´¨ç«™åç§°') {
                            rowData.push(stationName);
                        } else if (field === 'æ°´è´¨ç±»åˆ«') {
                            rowData.push(result.gbClass ? result.gbClass + 'ç±»' : '');
                        } else if (field === 'ä¸»è¦è¶…æ ‡é¡¹ç›®åŠå€æ•°') {
                            rowData.push(result.worstParam || '');
                        } else if (field === 'è¥å…»çŠ¶æ€') {
                            rowData.push(result.eutrophicStatus || '');
                        } else {
                            let value = null;
                            if (row[field] !== undefined) {
                                value = row[field];
                            } else if (field === 'å¶ç»¿ç´ ' && row['å¶ç»¿ç´ a'] !== undefined) {
                                value = row['å¶ç»¿ç´ a'];
                            } else if (field === 'é“¬ï¼ˆå…­ä»·ï¼‰' && row['é“¬å…­ä»·'] !== undefined) {
                                value = row['é“¬å…­ä»·'];
                            }
                            rowData.push(value);
                        }
                    });
                    aoa.push(rowData);
                });

                const ws = XLSX.utils.aoa_to_sheet(aoa);
                
                // è®¾ç½®åˆå¹¶å•å…ƒæ ¼
                ws['!merges'] = [
                    {s: {c: 0, r: 0}, e: {c: 53, r: 0}}  // æ ‡é¢˜è¡Œåˆå¹¶
                ];

                // è®¾ç½®åˆ—å®½
                ws['!cols'] = [
                    {wch: 16}, {wch: 14}, {wch: 12}, {wch: 10}, {wch: 18}, 
                    {wch: 12}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 10}, {wch: 8}, {wch: 8}, 
                    {wch: 6}, {wch: 10}, {wch: 10}, {wch: 12}, {wch: 10}, {wch: 10}, {wch: 10}, 
                    {wch: 10}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 8}, 
                    {wch: 8}, {wch: 8}, {wch: 10}, {wch: 8}, {wch: 8}, {wch: 8}, {wch: 10}, 
                    {wch: 12}, {wch: 14}, {wch: 8}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 8}, 
                    {wch: 8}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, 
                    {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 10}, {wch: 8}, {wch: 8}, 
                    {wch: 10}
                ];

                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "æ°´è´¨ç›‘æµ‹æˆæœè¡¨");
                
                const fileName = `æ°´è´¨ç›‘æµ‹æˆæœè¡¨_${new Date().toISOString().slice(0,10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                addBotMessage(`ç»“æœå·²å¯¼å‡ºåˆ°ï¼š${fileName}`);
            };

            // èŠå¤©åŠŸèƒ½
            // addBotMessage å·²åœ¨å…¨å±€å®šä¹‰

            function addUserMessage(text) {
                const div = document.createElement('div');
                div.className = 'flex gap-2 flex-row-reverse animate-in fade-in slide-in-from-bottom-2 duration-300';
                div.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-slate-200 flex-shrink-0 flex items-center justify-center text-slate-600 font-bold text-xs">ME</div>
                    <div class="user-chat-bubble bg-primary text-white p-3 text-sm shadow-md">${text}</div>
                `;
                chatHistory.appendChild(div);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                lucide.createIcons();
            }

            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMsgBtn.click();
                }
            });

            // AIæŒ‡ä»¤é…ç½®ä¸å¤„ç†ç³»ç»Ÿ
            let displayConfig = {
                exceedanceDecimal: 2,  // è¶…æ ‡å€æ•°å°æ•°ä½æ•°
                tliDecimal: 1,           // TLIå°æ•°ä½æ•°
                showExceedance: true,   // æ˜¯å¦æ˜¾ç¤ºè¶…æ ‡å€æ•°
                exceedanceBase: 'â…¢',     // è¶…æ ‡åŸºå‡†ï¼šâ…¢ç±»æ ‡å‡†
                excludedParams: [],       // æ’é™¤çš„è¯„ä»·å‚æ•°
                autoCOD: true,           // è‡ªåŠ¨åˆ¤æ–­COD/é«˜é”°é…¸ç›æŒ‡æ•°ï¼štrue=è‡ªåŠ¨ï¼Œfalse=å›ºå®šç”¨CODï¼Œnull=å›ºå®šç”¨é«˜é”°é…¸ç›æŒ‡æ•°
                useLakeTP: false,         // æ€»ç£·æ˜¯å¦ä½¿ç”¨æ¹–åº“æ ‡å‡†è¯„ä»·
                lakeTPStations: []        // æ€»ç£·ç”¨æ¹–åº“æ ‡å‡†çš„ç«™ç‚¹åˆ—è¡¨
            };

            // å¤§æ¨¡å‹APIé…ç½®ï¼ˆè±†åŒ…ï¼‰
            const LLM_CONFIG = {
                apiUrl: 'https://ark.cn-beijing.volces.com/api/v3/chat/completions',
                apiKey: '7b4f3ff4-1ee0-4b4c-8551-0441674dbdbe',
                model: 'doubao-seed-1-6-vision-250815'
            };

            // è°ƒç”¨å¤§æ¨¡å‹API
            async function callLLM(userMessage) {
                try {
                    const response = await fetch(LLM_CONFIG.apiUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${LLM_CONFIG.apiKey}`
                        },
                        body: JSON.stringify({
                            model: LLM_CONFIG.model,
                            messages: [
                                {
                                    role: 'system',
                                    content: `ä½ æ˜¯ä¸€ä¸ªæ°´è´¨è¯„ä»·ç³»ç»Ÿçš„æ™ºèƒ½åŠ©æ‰‹ã€‚è¯·ç”¨ç®€æ´çš„ä¸­æ–‡å›ç­”ç”¨æˆ·çš„é—®é¢˜ã€‚

æ³¨æ„ï¼šä¸è¦è¿”å›ä»£ç æˆ–JavaScriptä»£ç å—ï¼Œåªéœ€è¦è¿”å›çº¯æ–‡å­—è¯´æ˜ã€‚
ä¼šæ ¹æ®ç”¨æˆ·çš„æŒ‡ä»¤è‡ªåŠ¨æ‰§è¡Œç›¸åº”çš„æ“ä½œï¼Œä½ åªéœ€è¦å‘Šè¯‰ç”¨æˆ·ç»“æœå³å¯ã€‚`
                                },
                                {
                                    role: 'user',
                                    content: `ç”¨æˆ·æŒ‡ä»¤: ${userMessage}

å½“å‰è¯„ä»·ç»“æœæ•°æ®: ${JSON.stringify(evaluationResults.slice(0, 3))}

è¯·ç›´æ¥å›ç­”ç”¨æˆ·ï¼Œä¸éœ€è¦æä¾›ä»£ç ã€‚`
                                }
                            ],
                            max_tokens: 1000
                        })
                    });

                    if (!response.ok) {
                        throw new Error(`APIé”™è¯¯: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.choices[0].message.content;
                } catch (error) {
                    console.error('LLMè°ƒç”¨å¤±è´¥:', error);
                    return `è°ƒç”¨å¤§æ¨¡å‹å¤±è´¥: ${error.message}`;
                }
            }

            // å¤„ç†ç”¨æˆ·æŒ‡ä»¤
            function processAICommand(msg) {
                console.log('processAICommand called:', msg);
                const lowerMsg = msg.toLowerCase();
                
                // è°ƒæ•´è¶…æ ‡å€æ•°å°æ•°ä½æ•°
                if (/è¶…æ ‡.*(å°æ•°|ä½æ•°|ä½)/.test(msg) || /.*ä½.*è¶…æ ‡/.test(msg) || /æ”¹æˆ.*ä½/.test(msg) || /æ”¹ä¸º.*ä½/.test(msg) || /å°æ•°.*1/.test(msg)) {
                    console.log('Match: è¶…æ ‡å°æ•°ä½æ•°');
                    const match = msg.match(/(\d+)/);
                    if (match) {
                        console.log('Setting exceedanceDecimal to:', match[1]);
                        displayConfig.exceedanceDecimal = parseInt(match[1]);
                        rerenderEvaluationResults();
                        return `å·²å°†è¶…æ ‡å€æ•°æ˜¾ç¤ºè°ƒæ•´ä¸ºå°æ•°ç‚¹å${match[1]}ä½ï¼Œå·²é‡æ–°æ¸²æŸ“è¡¨æ ¼ã€‚`;
                    }
                }
                
                // è°ƒæ•´TLIå°æ•°ä½æ•°
                if (/tli.*(å°æ•°|ä½æ•°|ä½)/.test(msg) || /.*ä½.*tli/i.test(msg)) {
                    const match = msg.match(/(\d+)\s*ä½?/);
                    if (match) {
                        displayConfig.tliDecimal = parseInt(match[1]);
                        rerenderEvaluationResults();
                        return `å·²å°†TLIæŒ‡æ•°æ˜¾ç¤ºè°ƒæ•´ä¸ºå°æ•°ç‚¹å${match[1]}ä½ï¼Œå·²é‡æ–°æ¸²æŸ“è¡¨æ ¼ã€‚`;
                    }
                }
                
                // è°ƒæ•´æ‰€æœ‰æ•°å€¼å°æ•°ä½æ•°
                if (/ç»Ÿä¸€.*(å°æ•°|ä½æ•°|ä½)/.test(msg) || /.*ä½.*ç»Ÿä¸€/.test(msg)) {
                    const match = msg.match(/(\d+)\s*ä½?/);
                    if (match) {
                        displayConfig.exceedanceDecimal = parseInt(match[1]);
                        displayConfig.tliDecimal = parseInt(match[1]);
                        rerenderEvaluationResults();
                        return `å·²å°†æ‰€æœ‰æ•°å€¼æ˜¾ç¤ºè°ƒæ•´ä¸ºå°æ•°ç‚¹å${match[1]}ä½ï¼Œå·²é‡æ–°æ¸²æŸ“è¡¨æ ¼ã€‚`;
                    }
                }
                
                // åˆ‡æ¢è¶…æ ‡å€æ•°æ˜¾ç¤º
                if (/éšè—è¶…æ ‡/.test(msg)) {
                    displayConfig.showExceedance = false;
                    rerenderEvaluationResults();
                    return "å·²éšè—è¶…æ ‡å€æ•°æ˜¾ç¤ºã€‚";
                }
                if (/æ˜¾ç¤ºè¶…æ ‡/.test(msg)) {
                    displayConfig.showExceedance = true;
                    rerenderEvaluationResults();
                    return "å·²æ˜¾ç¤ºè¶…æ ‡å€æ•°ã€‚";
                }
                
                // é‡æ–°è¯„ä»·
                if (/é‡æ–°è¯„ä»·|åˆ·æ–°è¯„ä»·/.test(msg)) {
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                        return "æ­£åœ¨é‡æ–°è¯„ä»·...";
                    } else {
                        return "è¯·å…ˆä¸Šä¼ æ•°æ®æ–‡ä»¶å†è¿›è¡Œè¯„ä»·ã€‚";
                    }
                }
                
                return null;
            }

            // é‡æ–°æ¸²æŸ“è¯„ä»·ç»“æœ
            function rerenderEvaluationResults() {
                console.log('rerender called, displayConfig:', displayConfig);
                if (evaluationResults.length === 0) {
                    console.log('No evaluation results');
                    return;
                }
                
                const rows = tableBody.querySelectorAll('tr');
                console.log('Rows found:', rows.length);
                evaluationResults.forEach((result, index) => {
                    if (rows[index]) {
                        // æ™ºèƒ½æ ¼å¼åŒ–è¶…æ ‡å€æ•°ï¼šé»˜è®¤1ä½å°æ•°ï¼Œ<0.05æ—¶2ä½ï¼ŒæŒ‰å€æ•°ä»å¤§åˆ°å°æ’åº
                        let exceedInfo = '';
                        if (displayConfig.showExceedance && result.exceedanceDetails && result.exceedanceDetails.length > 0) {
                            // æŒ‰è¶…æ ‡å€æ•°ä»å¤§åˆ°å°æ’åº
                            const sortedDetails = [...result.exceedanceDetails].sort((a, b) => b.ratio - a.ratio);
                            const exceedStrs = sortedDetails.map(item => {
                                // æ™ºèƒ½å°æ•°ä½æ•°ï¼š>=0.05æ˜¾ç¤º1ä½ï¼Œ<0.05æ˜¾ç¤º2ä½
                                const decimal = item.ratio >= 0.05 ? 1 : 2;
                                const ratio = item.ratio.toFixed(decimal);
                                return `${item.param}ï¼ˆ${ratio}ï¼‰`;
                            });
                            exceedInfo = exceedStrs.join('ã€');
                        }
                        
                        // æ ¼å¼åŒ–TLI
                        const tliDisplay = result.tli !== null && result.tli !== '-' ? 
                            parseFloat(result.tli).toFixed(displayConfig.tliDecimal) : '-';
                        
                        rows[index].innerHTML = `
                            <td class="px-1 py-2 font-medium text-xs sticky left-0 bg-white z-10">${result['ç«™ç‚¹åç§°']}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°´ä½'] !== null ? result['æ°´ä½'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æµé€Ÿ'] !== null ? result['æµé€Ÿ'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æµé‡'] !== null ? result['æµé‡'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°”æ¸©'] !== null ? result['æ°”æ¸©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°´æ¸©'] !== null ? result['æ°´æ¸©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['pHå€¼'] !== null ? result['pHå€¼'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç”µå¯¼ç‡'] !== null ? result['ç”µå¯¼ç‡'] : '-'}</td>
                            <td class="px-1 py-2 text-xs font-medium">${result['æº¶è§£æ°§'] !== null ? result['æº¶è§£æ°§'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é«˜é”°é…¸ç›æŒ‡æ•°'] !== null ? result['é«˜é”°é…¸ç›æŒ‡æ•°'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['åŒ–å­¦éœ€æ°§é‡'] !== null ? result['åŒ–å­¦éœ€æ°§é‡'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] !== null ? result['äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°¨æ°®'] !== null ? result['æ°¨æ°®'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ€»æ°®'] !== null ? result['æ€»æ°®'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ€»ç£·'] !== null ? result['æ€»ç£·'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é“œ'] !== null ? result['é“œ'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é”Œ'] !== null ? result['é”Œ'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°ŸåŒ–ç‰©'] !== null ? result['æ°ŸåŒ–ç‰©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç¡’'] !== null ? result['ç¡’'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç ·'] !== null ? result['ç ·'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ±'] !== null ? result['æ±'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é•‰'] !== null ? result['é•‰'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é“¬å…­ä»·'] !== null ? result['é“¬å…­ä»·'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é“…'] !== null ? result['é“…'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°°åŒ–ç‰©'] !== null ? result['æ°°åŒ–ç‰©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æŒ¥å‘é…š'] !== null ? result['æŒ¥å‘é…š'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['çŸ³æ²¹ç±»'] !== null ? result['çŸ³æ²¹ç±»'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] !== null ? result['é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç¡«åŒ–ç‰©'] !== null ? result['ç¡«åŒ–ç‰©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['å¶ç»¿ç´ a'] !== null ? result['å¶ç»¿ç´ a'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é€æ˜åº¦'] !== null ? result['é€æ˜åº¦'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç¡é…¸ç›æ°®'] !== null ? result['ç¡é…¸ç›æ°®'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é“'] !== null ? result['é“'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é”°'] !== null ? result['é”°'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ°¯åŒ–ç‰©'] !== null ? result['æ°¯åŒ–ç‰©'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç¡«é…¸ç›'] !== null ? result['ç¡«é…¸ç›'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç²ªå¤§è‚ èŒç¾¤'] !== null ? result['ç²ªå¤§è‚ èŒç¾¤'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['æ€»ç¡¬åº¦'] !== null ? result['æ€»ç¡¬åº¦'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é’™'] !== null ? result['é’™'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é•'] !== null ? result['é•'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['ç¢³é…¸ç›'] !== null ? result['ç¢³é…¸ç›'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é‡ç¢³é…¸ç›'] !== null ? result['é‡ç¢³é…¸ç›'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['çŸ¿åŒ–åº¦'] !== null ? result['çŸ¿åŒ–åº¦'] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é’ '] !== null ? result['é’ '] : '-'}</td>
                            <td class="px-1 py-2 text-xs">${result['é’¾'] !== null ? result['é’¾'] : '-'}</td>
                            <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge ${result.gbClass ? getClassBadge(result.gbClass) : 'bg-gray-100 text-gray-500'}">${result.gbClass ? result.gbClass + 'ç±»' : '-'}</span></td>
                            <td class="px-1 py-2 text-xs bg-amber-50 text-red-500 font-medium">${exceedInfo || '-'}</td>
                            <td class="px-1 py-2 text-xs bg-amber-50"><span class="standard-badge ${getEutrophicationBadge(result.eutrophicStatus)}">${result.eutrophicStatus}</span></td>
                            <td class="px-1 py-2 text-xs bg-amber-50 font-mono text-primary font-bold">${tliDisplay}</td>
                        `;
                    }
                });
            }

            // æ›´æ–°èŠå¤©æ¶ˆæ¯å¤„ç†é€»è¾‘
            sendMsgBtn.addEventListener('click', async () => {
                const msg = chatInput.value.trim();
                if (!msg) return;
                
                addUserMessage(msg);
                chatInput.value = '';
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'flex gap-2 animate-in fade-in slide-in-from-bottom-2 duration-300';
                loadingDiv.innerHTML = `
                    <div class="w-8 h-8 rounded-full bg-blue-100 flex-shrink-0 flex items-center justify-center text-primary">
                        <i data-lucide="bot" class="w-4 h-4"></i>
                    </div>
                    <div class="ai-chat-bubble bg-white border border-slate-200 p-3 text-sm shadow-sm">
                        <span class="text-slate-400">æ­£åœ¨æ€è€ƒ...</span>
                    </div>
                `;
                chatHistory.appendChild(loadingDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
                
                try {
                    const response = await callLLM(msg);
                    
                    // ç§»é™¤åŠ è½½æç¤º
                    loadingDiv.remove();
                    
                    // å°è¯•æ‰§è¡Œæœ¬åœ°æ“ä½œ
                    processLLMResponse(msg, response);
                    
                    addBotMessage(response);
                } catch (error) {
                    loadingDiv.remove();
                    addBotMessage(`å‡ºé”™äº†: ${error.message}`);
                }
            });

            // å¤„ç†å¤§æ¨¡å‹å›å¤ï¼Œæ‰§è¡Œç›¸åº”æ“ä½œ
            function processLLMResponse(userMsg, llmResponse) {
                const msg = userMsg;
                console.log('processLLMResponse called:', msg);
                
                // æå–æ•°å­—
                const numMatch = msg.match(/(\d+)/);
                const num = numMatch ? parseInt(numMatch[1]) : null;
                
                // è°ƒæ•´è¶…æ ‡å€æ•°å°æ•°ä½æ•° - æ›´å®½æ¾çš„åŒ¹é…
                if (/è¶…æ ‡|æ”¹æˆ|æ”¹ä¸º|è°ƒæ•´|ä¿®æ”¹|å˜/.test(msg) && /ä½|å°æ•°/.test(msg)) {
                    if (num && num >= 0 && num <= 10) {
                        displayConfig.exceedanceDecimal = num;
                        rerenderEvaluationResults();
                        return;
                    }
                }
                
                // è°ƒæ•´TLIå°æ•°ä½æ•°
                if (/tli|TLI|å¯Œè¥å…»/.test(msg) && /ä½|å°æ•°/.test(msg)) {
                    if (num && num >= 0 && num <= 10) {
                        displayConfig.tliDecimal = num;
                        rerenderEvaluationResults();
                        return;
                    }
                }
                
                // ç»Ÿä¸€è°ƒæ•´
                if (/ç»Ÿä¸€|å…¨éƒ¨|æ‰€æœ‰/.test(msg) && /ä½|å°æ•°/.test(msg)) {
                    if (num && num >= 0 && num <= 10) {
                        displayConfig.exceedanceDecimal = num;
                        displayConfig.tliDecimal = num;
                        rerenderEvaluationResults();
                        return;
                    }
                }
                
                // éšè—è¶…æ ‡å€æ•°
                if (/éšè—|ä¸æ˜¾ç¤º|å…³é—­/.test(msg) && /è¶…æ ‡/.test(msg)) {
                    displayConfig.showExceedance = false;
                    rerenderEvaluationResults();
                    return;
                }
                
                // æ˜¾ç¤ºè¶…æ ‡å€æ•°
                if (/æ˜¾ç¤º|å¼€å¯/.test(msg) && /è¶…æ ‡/.test(msg)) {
                    displayConfig.showExceedance = true;
                    rerenderEvaluationResults();
                    return;
                }
                
                // æ’é™¤å‚æ•°å‚ä¸è¯„ä»·
                if (/æ’é™¤|å»é™¤|ä¸è¯„|å»æ‰|å‰”é™¤/.test(msg)) {
                    const allParams = ['æ€»ç£·', 'æ€»æ°®', 'é«˜é”°é…¸ç›æŒ‡æ•°', 'æ°¨æ°®', 'æº¶è§£æ°§', 'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡', 'åŒ–å­¦éœ€æ°§é‡', 'ç²ªå¤§è‚ èŒç¾¤', 'pHå€¼', 'ç”µå¯¼ç‡', 'æ°´æ¸©', 'å¶ç»¿ç´ a', 'é“œ', 'é”Œ', 'æ±', 'ç ·', 'é“…', 'é•‰', 'é“¬å…­ä»·', 'æŒ¥å‘é…š', 'çŸ³æ²¹ç±»', 'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'];
                    let excluded = [];
                    
                    // æ£€æµ‹æ‰€æœ‰å¯èƒ½çš„å‚æ•°
                    allParams.forEach(param => {
                        if (msg.includes(param)) {
                            excluded.push(param);
                        }
                    });
                    
                    if (excluded.length > 0) {
                        // æ·»åŠ åˆ°æ’é™¤åˆ—è¡¨
                        excluded.forEach(param => {
                            if (!displayConfig.excludedParams.includes(param)) {
                                displayConfig.excludedParams.push(param);
                            }
                        });
                        // é‡æ–°è¯„ä»·
                        if (parsedData.length > 0) {
                            document.getElementById('runEval').click();
                        }
                        return;
                    }
                }
                
                // æ¢å¤å‚æ•°å‚ä¸è¯„ä»·
                if (/æ¢å¤|é‡æ–°åŠ å…¥|é‡æ–°è¯„/.test(msg) && /æ€»ç£·|æ€»æ°®|é«˜é”°|æ°¨æ°®|æº¶è§£æ°§/.test(msg)) {
                    const allParams = ['æ€»ç£·', 'æ€»æ°®', 'é«˜é”°é…¸ç›æŒ‡æ•°', 'æ°¨æ°®', 'æº¶è§£æ°§', 'äº”æ—¥ç”ŸåŒ–éœ€æ°§é‡', 'åŒ–å­¦éœ€æ°§é‡', 'ç²ªå¤§è‚ èŒç¾¤', 'pHå€¼', 'ç”µå¯¼ç‡', 'æ°´æ¸©', 'å¶ç»¿ç´ a', 'é“œ', 'é”Œ', 'æ±', 'ç ·', 'é“…', 'é•‰', 'é“¬å…­ä»·', 'æŒ¥å‘é…š', 'çŸ³æ²¹ç±»', 'é˜´ç¦»å­è¡¨é¢æ´»æ€§å‰‚'];
                    
                    allParams.forEach(param => {
                        if (msg.includes(param)) {
                            const idx = displayConfig.excludedParams.indexOf(param);
                            if (idx > -1) {
                                displayConfig.excludedParams.splice(idx, 1);
                            }
                        }
                    });
                    
                    // é‡æ–°è¯„ä»·
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                
                // æ¸…é™¤æ‰€æœ‰æ’é™¤
                if (/æ¸…é™¤.*æ’é™¤|å–æ¶ˆ.*æ’é™¤|é‡ç½®.*æ’é™¤/.test(msg)) {
                    displayConfig.excludedParams = [];
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                
                // æŸ¥è¯¢æ’é™¤çŠ¶æ€
                if (/å½“å‰æ’é™¤|æŸ¥çœ‹æ’é™¤|æœ‰å“ªäº›æ’é™¤/.test(msg)) {
                    if (displayConfig.excludedParams.length === 0) {
                        rerenderEvaluationResults();
                        return;
                    }
                    rerenderEvaluationResults();
                    return;
                }
                
                // COD/é«˜é”°é…¸ç›æŒ‡æ•°æ™ºèƒ½è¯„ä»·æ§åˆ¶
                if (/åªè¯„.*COD|åªç”¨.*åŒ–å­¦éœ€æ°§é‡|åªçœ‹.*COD/.test(msg)) {
                    displayConfig.autoCOD = false;  // å¼ºåˆ¶åªè¯„COD
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                if (/åªè¯„.*é«˜é”°|åªç”¨.*é«˜é”°é…¸ç›|åªçœ‹.*é«˜é”°/.test(msg)) {
                    displayConfig.autoCOD = null;  // å¼ºåˆ¶åªè¯„é«˜é”°
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                if (/æ™ºèƒ½.*COD|è‡ªåŠ¨.*COD|è‡ªåŠ¨.*åŒ–å­¦éœ€æ°§/.test(msg)) {
                    displayConfig.autoCOD = true;  // è‡ªåŠ¨åˆ¤æ–­
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                
                // æ¢å¤æ€»æ°®è¯„ä»·
                if (/æ¢å¤.*æ€»æ°®|é‡æ–°è¯„.*æ€»æ°®|æ€»æ°®.*å‚ä¸/.test(msg)) {
                    const idx = displayConfig.excludedParams.indexOf('æ€»æ°®');
                    if (idx > -1) {
                        displayConfig.excludedParams.splice(idx, 1);
                    }
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                
                // æ€»ç£·æ¹–åº“æ ‡å‡†æ§åˆ¶
                if (/æ€»ç£·.*æ¹–åº“|æ€»ç£·.*ç”¨æ¹–åº“|æ€»ç£·.*æŒ‰æ¹–åº“/.test(msg)) {
                    // è§¦å‘é‡æ–°è¯„ä»·
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                if (/æ€»ç£·.*ä¸ç”¨|æ€»ç£·.*ä¸ç”¨æ¹–åº“|æ€»ç£·.*å–æ¶ˆ/.test(msg)) {
                    // æ¸…ç©ºé€‰æ‹©å¹¶é‡æ–°è¯„ä»·
                    document.querySelectorAll('#lakeTPOptions input[type="checkbox"]').forEach(cb => cb.checked = false);
                    updateLakeTPBtn();
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }
                
                // é‡æ–°è¯„ä»·
                if (/é‡æ–°|åˆ·æ–°|å†è¯„/.test(msg) && /è¯„ä»·/.test(msg)) {
                    if (parsedData.length > 0) {
                        document.getElementById('runEval').click();
                    }
                    return;
                }

                // åˆç†æ€§ç»Ÿè®¡
                if (/åˆç†æ€§|æ•°æ®æ ¡éªŒ|ç¦»å­æ ¡éªŒ|åŒ–å­¦æ ¡éªŒ/.test(msg)) {
                    const result = performRationalityCheck();
                    addBotMessage(result);
                    return;
                }
                
                // é»˜è®¤ä¹Ÿå°è¯•é‡æ–°æ¸²æŸ“
                rerenderEvaluationResults();
            }

            // ç¦ç”¨è¯„ä»·æŒ‰é’®ç›´åˆ°åŠ è½½æ•°æ®
            runEvalBtn.disabled = true;
            runEvalBtn.classList.add('opacity-50', 'cursor-not-allowed');
        });

        // å°ä¹æ‚¬æµ®æŒ‰é’® - ç‚¹å‡»å¼¹å‡ºAIåŠ©æ‰‹é¢æ¿
        document.addEventListener('DOMContentLoaded', function() {
            const xiaoJiuBtn = document.getElementById('xiaoJiuBtn');
            const xiaoJiuPanel = document.getElementById('xiaoJiuPanel');
            const chatInput = document.getElementById('chatInput');

            if (xiaoJiuBtn && xiaoJiuPanel) {
                xiaoJiuBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    xiaoJiuPanel.classList.toggle('hidden');
                    if (!xiaoJiuPanel.classList.contains('hidden')) {
                        lucide.createIcons();
                    }
                });

                // å…³é—­é¢æ¿æŒ‰é’®
                const closeBtn = document.getElementById('closeXiaoJiuPanel');
                if (closeBtn) {
                    closeBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        xiaoJiuPanel.classList.add('hidden');
                    });
                }

                // é¢æ¿æ‹–æ‹½åŠŸèƒ½
                const panelHeader = document.getElementById('xiaoJiuPanelHeader');
                if (panelHeader) {
                    let isDragging = false;
                    let offsetX, offsetY;

                    panelHeader.addEventListener('mousedown', function(e) {
                        isDragging = true;
                        offsetX = e.clientX - xiaoJiuPanel.getBoundingClientRect().left;
                        offsetY = e.clientY - xiaoJiuPanel.getBoundingClientRect().top;
                        xiaoJiuPanel.style.cursor = 'grabbing';
                    });

                    document.addEventListener('mousemove', function(e) {
                        if (isDragging) {
                            xiaoJiuPanel.style.left = (e.clientX - offsetX) + 'px';
                            xiaoJiuPanel.style.top = (e.clientY - offsetY) + 'px';
                            xiaoJiuPanel.style.right = 'auto';
                            xiaoJiuPanel.style.bottom = 'auto';
                        }
                    });

                    document.addEventListener('mouseup', function() {
                        isDragging = false;
                        xiaoJiuPanel.style.cursor = 'move';
                    });
                }
            }

            // å¿«æ·æç¤ºæŒ‰é’®ç‚¹å‡»
            if (chatInput) {
                document.querySelectorAll('.quick-hint').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const hint = this.getAttribute('data-hint');
                        if (hint.includes('åˆç†æ€§ç»Ÿè®¡')) {
                            const result = performRationalityCheck();
                            addBotMessage(result);
                        } else {
                            chatInput.value = hint;
                            chatInput.focus();
                        }
                    });
                });
            }
        });
    </script>

    <!-- å°ä¹æ‚¬æµ®æŒ‰é’®å’Œé¢æ¿ -->
    <button id="xiaoJiuBtn" class="fixed bottom-6 right-6 w-14 h-14 bg-gradient-to-br from-cyan-400 to-blue-500 rounded-full shadow-lg flex items-center justify-center text-white hover:scale-110 hover:shadow-xl transition-all z-50 animate-pulse">
        <i data-lucide="waves" class="w-7 h-7"></i>
    </button>

    <!-- å°ä¹æ‚¬æµ®é¢æ¿ -->
    <div id="xiaoJiuPanel" class="hidden fixed bottom-24 right-6 w-96 h-[500px] bg-white rounded-2xl shadow-2xl border border-blue-100 flex flex-col overflow-hidden z-40" style="cursor: move;">
        <div class="p-4 bg-gradient-to-r from-cyan-500 to-blue-500 text-white flex justify-between items-center flex-shrink-0" id="xiaoJiuPanelHeader">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center">
                    <i data-lucide="waves" class="w-4 h-4"></i>
                </div>
                <div>
                    <p class="font-bold text-sm leading-tight">å°ä¹</p>
                    <p class="text-[10px] text-white/70">æ°´è´¨å®éªŒå®¤åŠ©ç† âœ¨</p>
                </div>
            </div>
            <button id="closeXiaoJiuPanel" class="p-1 hover:bg-white/20 rounded transition-colors">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </div>
        
        <div class="flex-1 p-4 overflow-y-auto space-y-4 bg-gradient-to-b from-slate-50 to-blue-50/30" id="chatHistory">
            <div class="flex gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex-shrink-0 flex items-center justify-center text-white shadow-md">
                    <i data-lucide="waves" class="w-4 h-4"></i>
                </div>
                <div class="ai-chat-bubble bg-white border border-blue-100 p-3 text-sm shadow-sm">
                    å—¨ï½æˆ‘æ˜¯å°ä¹ï¼Œä½ çš„æ°´è´¨å®éªŒå®¤åŠ©ç†ï¼ğŸŒŠ ä¸Šä¼ æ•°æ®æˆ‘å°±å¸®ä½ åˆ†æè¶…æ ‡æƒ…å†µï¼Œè¿˜èƒ½è®¡ç®—å¯Œè¥å…»åŒ–æŒ‡æ•°å“¦ï½æœ‰ä»€ä¹ˆæƒ³é—®çš„å°½ç®¡è¯´ï¼
                </div>
            </div>
            
            <div class="flex gap-2 flex-row-reverse">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-purple-400 to-pink-400 flex-shrink-0 flex items-center justify-center text-white font-bold text-xs shadow-sm">
                    ä½ 
                </div>
                <div class="user-chat-bubble bg-gradient-to-r from-blue-500 to-cyan-500 text-white p-3 text-sm shadow-md">
                    å¸®æˆ‘çœ‹çœ‹æœ‰å“ªäº›ç«™ç‚¹è¶…æ ‡äº†ï¼Ÿ
                </div>
            </div>

            <div class="flex gap-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-br from-cyan-400 to-blue-500 flex-shrink-0 flex items-center justify-center text-white shadow-md">
                    <i data-lucide="waves" class="w-4 h-4"></i>
                </div>
                <div class="ai-chat-bubble bg-white border border-blue-100 p-3 text-sm shadow-sm">
                    å¥½çš„å‘€ï½è®©æˆ‘æ¥åˆ†æä¸€ä¸‹æ•°æ®ï¼ç¨ç­‰å“¦ï½ ğŸ”
                </div>
            </div>
        </div>

        <div class="p-4 bg-white border-t flex-shrink-0">
            <div class="relative">
                <textarea id="chatInput" placeholder="è¾“å…¥æŒ‡ä»¤ï¼Œå¦‚ï¼š'æ‰¾å‡ºæ‰€æœ‰è¶…æ ‡æ–­é¢'..." class="w-full pl-4 pr-12 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-primary focus:border-transparent outline-none resize-none transition-all" rows="2"></textarea>
                <button id="sendMsg" class="absolute right-2 bottom-2 w-8 h-8 bg-primary text-white rounded-lg flex items-center justify-center hover:bg-secondary transition-colors">
                    <i data-lucide="send-horizontal" class="w-4 h-4"></i>
                </button>
            </div>
            <div class="mt-3 flex gap-2 flex-wrap">
                <span class="quick-hint px-2 py-1 bg-blue-50 rounded text-[10px] text-blue-600 cursor-pointer hover:bg-blue-100 hover:text-blue-700 transition-colors" data-hint="å¸®æˆ‘è¿›è¡Œåˆç†æ€§ç»Ÿè®¡">ğŸ” åˆç†æ€§ç»Ÿè®¡</span>
            </div>
        </div>
    </div>
</body>
</html>