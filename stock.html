<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标准物质管理助手 - 库存管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.1/build/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', success: '#22c55e',
                        danger: '#ef4444', warning: '#f59e0b', info: '#0ea5e9'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="header bg-primary text-white p-4 fixed top-0 left-0 right-0 z-100 flex justify-between items-center">
        <div class="flex items-center">
            <button onclick="navigateTo('dashboard.html')" class="mr-4">
                <i class="fa fa-arrow-left text-xl"></i>
            </button>
            <h1 class="text-xl font-bold">库存管理</h1>
        </div>
        <div class="flex items-center space-x-4">
            <button onclick="document.getElementById('searchInput').focus()">
                <i class="fa fa-search text-xl"></i>
            </button>
            <button onclick="showAddModal()">
                <i class="fa fa-plus text-xl"></i>
            </button>
        </div>
    </div>

    <div class="content pt-20 p-4 pb-20">
        <div class="bg-white rounded-xl shadow mb-4 p-3">
            <input type="text" id="searchInput" placeholder="搜索标准物质..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary">
        </div>

        <div class="flex border-b border-gray-200 mb-4 overflow-x-auto">
            <div class="tab active flex-shrink-0 px-4 py-2 border-b-2 border-primary text-primary font-semibold cursor-pointer" data-tab="all">全部</div>
            <div class="tab flex-shrink-0 px-4 py-2 border-b-2 border-transparent text-gray-500 cursor-pointer" data-tab="normal">正常</div>
            <div class="tab flex-shrink-0 px-4 py-2 border-b-2 border-transparent text-gray-500 cursor-pointer" data-tab="warning">即将过期</div>
            <div class="tab flex-shrink-0 px-4 py-2 border-b-2 border-transparent text-gray-500 cursor-pointer" data-tab="expired">已过期</div>
        </div>

        <div id="stockList" class="bg-white rounded-xl shadow p-4">
            <p class="text-center text-gray-500 py-4">加载中...</p>
        </div>
    </div>

    <div class="footer bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 z-100">
        <div class="flex justify-around">
            <div class="nav-item" onclick="navigateTo('dashboard.html')">
                <i class="fa fa-home"></i><span>首页</span>
            </div>
            <div class="nav-item active" onclick="navigateTo('stock.html')">
                <i class="fa fa-cubes"></i><span>库存</span>
            </div>
            <div class="nav-item" onclick="navigateTo('personnel.html')">
                <i class="fa fa-users"></i><span>人员</span>
            </div>
            <div class="nav-item" onclick="navigateTo('settings.html')">
                <i class="fa fa-cog"></i><span>设置</span>
            </div>
        </div>
    </div>

    <div id="outModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">出库登记</h2>
                <button onclick="hideOutModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="outForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">选择标准物质<span class="text-danger">*</span></label>
                    <select id="outMaterial" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                        <option value="">请选择</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">操作人员<span class="text-danger">*</span></label>
                    <input type="text" id="outOperator" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">出库用途</label>
                    <input type="text" id="outPurpose" class="w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="选填">
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideOutModal()" class="px-4 py-2 border border-gray-300 rounded-md">取消</button>
                    <button type="button" onclick="processOutbound()" class="px-4 py-2 bg-warning text-white rounded-md">确认出库</button>
                </div>
            </form>
        </div>
    </div>

    <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-lg w-full max-w-md max-h-[90vh] overflow-y-auto p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold">入库登记</h2>
                <button onclick="hideAddModal()" class="text-gray-500 hover:text-gray-700">
                    <i class="fa fa-times"></i>
                </button>
            </div>
            <form id="addForm" class="space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">名称<span class="text-danger">*</span></label>
                        <input type="text" id="name" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">编号<span class="text-danger">*</span></label>
                        <input type="text" id="code" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">批次号</label>
                        <input type="text" id="batchNumber" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">数量<span class="text-danger">*</span></label>
                        <input type="number" id="quantity" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">浓度</label>
                        <input type="text" id="concentration" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">有效期<span class="text-danger">*</span></label>
                        <input type="date" id="expiryDate" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">生产厂家</label>
                    <input type="text" id="manufacturer" class="w-full px-3 py-2 border border-gray-300 rounded-md">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">操作人员<span class="text-danger">*</span></label>
                    <input type="text" id="operator" class="w-full px-3 py-2 border border-gray-300 rounded-md" required>
                </div>
                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="hideAddModal()" class="px-4 py-2 border border-gray-300 rounded-md">取消</button>
                    <button type="submit" class="px-4 py-2 bg-primary text-white rounded-md">保存</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://nzqosgvjovormymsiqml.supabase.co';
        const supabaseKey = 'sb_publishable_WJ5NB6wngsil8LT5qOmDRg_tVBQ4A54';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let stockData = [];
        let activeTab = 'all';

        document.addEventListener('DOMContentLoaded', async () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('operator').value = localStorage.getItem('userName') || '';
            document.getElementById('outOperator').value = localStorage.getItem('userName') || '';
            
            await loadStockData();
            setupEventListeners();
            
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('action') === 'add') showAddModal();
            if (urlParams.get('action') === 'out') showOutModal();
        });

        async function loadStockData() {
            // 移除user_id过滤，查询所有库存数据
            const { data, error } = await supabase
                .from('stock')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('加载失败:', error);
                return;
            }
            
            stockData = data || [];
            renderStockList();
        }

        function renderStockList() {
            const container = document.getElementById('stockList');
            const searchInput = document.getElementById('searchInput').value.toLowerCase();
            
            let filtered = stockData.filter(item => {
                const matchSearch = !searchInput || 
                    item.name?.toLowerCase().includes(searchInput) || 
                    item.code?.toLowerCase().includes(searchInput);
                
                if (activeTab === 'all') return matchSearch;
                return matchSearch && item.status === activeTab;
            });
            
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">暂无数据</p>';
                return;
            }
            
            const grouped = {};
            filtered.forEach(item => {
                if (!grouped[item.name]) {
                    grouped[item.name] = { items: [], total: 0 };
                }
                grouped[item.name].items.push(item);
                grouped[item.name].total += item.quantity || 0;
            });
            
            container.innerHTML = Object.entries(grouped).map(([name, group]) => {
                const statusCounts = group.items.reduce((acc, item) => {
                    acc[item.status] = (acc[item.status] || 0) + (item.quantity || 0);
                    return acc;
                }, {});
                
                const groupId = `group-${name.replace(/\s+/g, '-').toLowerCase()}`;
                const hasWarning = statusCounts.warning > 0 || statusCounts.expired > 0;
                const statusClass = statusCounts.expired > 0 ? 'text-danger' : 
                                   statusCounts.warning > 0 ? 'text-warning' : 'text-success';
                
                return `
                    <div class="border border-gray-200 rounded-lg overflow-hidden mb-4">
                        <div class="bg-gray-50 p-4 flex justify-between items-center cursor-pointer" onclick="toggleGroup('${groupId}')">
                            <div class="flex items-center">
                                <i class="fa fa-chevron-down mr-2 text-gray-500" id="arrow-${groupId}"></i>
                                <h3 class="font-semibold">${name}</h3>
                                ${hasWarning ? `<span class="ml-2 text-sm ${statusClass}">
                                    ${statusCounts.expired > 0 ? `过期:${statusCounts.expired}` : ''}
                                    ${statusCounts.warning > 0 ? `即将:${statusCounts.warning}` : ''}
                                </span>` : ''}
                            </div>
                            <span class="text-lg font-bold">${group.total}</span>
                        </div>
                        <div id="${groupId}" class="hidden">
                            ${group.items.map(item => `
                                <div class="p-4 border-t border-gray-100">
                                    <div class="flex justify-between items-start">
                                        <div class="text-sm">
                                            <p>唯一标识: ${item.unique_id || 'N/A'}</p>
                                            <p>有效期: ${item.expiry_date}</p>
                                            <p>浓度: ${item.concentration || 'N/A'}</p>
                                            <p>录入人: ${item.operator}</p>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="outboundStockItem(${item.id})" class="px-3 py-1 bg-warning text-white text-xs rounded">出库</button>
                                            <button onclick="viewStockItem(${item.id})" class="px-3 py-1 bg-info text-white text-xs rounded">查看</button>
                                            <button onclick="deleteStockItem(${item.id})" class="px-3 py-1 bg-danger text-white text-xs rounded">删除</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleGroup(groupId) {
            const el = document.getElementById(groupId);
            const arrow = document.getElementById(`arrow-${groupId}`);
            el.classList.toggle('hidden');
            arrow.style.transform = el.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', renderStockList);
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    document.querySelectorAll('.tab').forEach(t => {
                        t.classList.remove('active', 'border-primary', 'text-primary');
                        t.classList.add('border-transparent', 'text-gray-500');
                    });
                    this.classList.remove('border-transparent', 'text-gray-500');
                    this.classList.add('active', 'border-primary', 'text-primary');
                    activeTab = this.dataset.tab;
                    renderStockList();
                });
            });
            
            document.getElementById('addForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                await processInbound();
            });
        }

        async function processInbound() {
            const item = {
                name: document.getElementById('name').value,
                code: document.getElementById('code').value,
                batch_number: document.getElementById('batchNumber').value,
                quantity: parseInt(document.getElementById('quantity').value),
                concentration: document.getElementById('concentration').value,
                expiry_date: document.getElementById('expiryDate').value,
                manufacturer: document.getElementById('manufacturer').value,
                operator: document.getElementById('operator').value,
                unique_id: `${document.getElementById('batchNumber').value || 'BATCH'}-${Date.now().toString().slice(-4)}`,
                status: calculateStatus(parseInt(document.getElementById('quantity').value), document.getElementById('expiryDate').value),
                created_at: new Date().toISOString()
            };
            
            const { error } = await supabase.from('stock').insert([item]);
            
            if (error) {
                alert('入库失败: ' + error.message);
            } else {
                await addRecord('in', item);
                hideAddModal();
                await loadStockData();
                alert('入库成功！');
            }
        }

        async function processOutbound() {
            const materialId = parseInt(document.getElementById('outMaterial').value);
            const operator = document.getElementById('outOperator').value;
            const purpose = document.getElementById('outPurpose').value;
            
            if (!materialId || !operator) {
                alert('请填写必填字段');
                return;
            }
            
            const item = stockData.find(i => i.id === materialId);
            if (!item) {
                alert('未找到该标准物质');
                return;
            }
            
            if (!confirm(`确定要将 ${item.name} 出库吗？`)) return;
            
            const { error } = await supabase.from('stock').delete().eq('id', materialId);
            
            if (error) {
                alert('出库失败: ' + error.message);
            } else {
                await addRecord('out', { ...item, operator, purpose });
                hideOutModal();
                await loadStockData();
                alert('出库成功！');
            }
        }

        async function addRecord(type, item) {
            const record = {
                type,
                material_name: item.name,
                quantity: item.quantity || 1,
                operator: item.operator || item.operatorName,
                note: `${type === 'in' ? '入库' : '出库'}${item.purpose ? ' - ' + item.purpose : ''}`,
                created_at: new Date().toISOString()
            };
            
            await supabase.from('records').insert([record]);
        }

        async function deleteStockItem(id) {
            if (!confirm('确定要删除该标准物质吗？')) return;
            
            const { error } = await supabase.from('stock').delete().eq('id', id);
            
            if (error) {
                alert('删除失败: ' + error.message);
            } else {
                await loadStockData();
                alert('删除成功！');
            }
        }

        function calculateStatus(quantity, expiryDate) {
            if (quantity === 0) return 'low';
            const now = new Date();
            const expiry = new Date(expiryDate);
            const diffTime = expiry - now;
            
            if (diffTime < 30 * 24 * 60 * 60 * 1000) return diffTime < 0 ? 'expired' : 'warning';
            return 'normal';
        }

        function showAddModal() {
            document.getElementById('addModal').classList.remove('hidden');
            document.getElementById('addForm').reset();
            document.getElementById('operator').value = localStorage.getItem('userName') || '';
        }

        function hideAddModal() {
            document.getElementById('addModal').classList.add('hidden');
        }

        function showOutModal() {
            document.getElementById('outModal').classList.remove('hidden');
            const select = document.getElementById('outMaterial');
            select.innerHTML = '<option value="">请选择</option>';
            
            // 显示所有未过期的库存
            stockData.filter(item => item.status !== 'expired' && item.quantity > 0).forEach(item => {
                select.innerHTML += `<option value="${item.id}">${item.name} (${item.unique_id})</option>`;
            });
            
            document.getElementById('outOperator').value = localStorage.getItem('userName') || '';
        }

        function hideOutModal() {
            document.getElementById('outModal').classList.add('hidden');
        }

        function outboundStockItem(id) {
            showOutModal();
            setTimeout(() => document.getElementById('outMaterial').value = id, 100);
        }

        function viewStockItem(id) {
            const item = stockData.find(i => i.id === id);
            if (!item) return;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg w-full max-w-md p-6 max-h-[90vh] overflow-y-auto">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">标准物质详情</h2>
                        <button onclick="this.closest('.fixed').remove()" class="text-gray-500">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-3 text-sm">
                        <p><span class="font-medium">名称:</span> ${item.name}</p>
                        <p><span class="font-medium">编号:</span> ${item.code}</p>
                        <p><span class="font-medium">唯一标识:</span> ${item.unique_id}</p>
                        <p><span class="font-medium">有效期:</span> ${item.expiry_date}</p>
                        <p><span class="font-medium">浓度:</span> ${item.concentration || 'N/A'}</p>
                        <p><span class="font-medium">厂家:</span> ${item.manufacturer || 'N/A'}</p>
                        <p><span class="font-medium">录入人:</span> ${item.operator}</p>
                        <p><span class="font-medium">状态:</span> <span class="status-badge status-${item.status}">${getStatusText(item.status)}</span></p>
                    </div>
                    <div class="mt-6 flex justify-end space-x-3">
                        <button onclick="outboundStockItem(${item.id}); this.closest('.fixed').remove();" class="px-4 py-2 bg-warning text-white rounded-md">出库</button>
                        <button onclick="deleteStockItem(${item.id}); this.closest('.fixed').remove();" class="px-4 py-2 bg-danger text-white rounded-md">删除</button>
                        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 bg-gray-200 rounded-md">关闭</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function getStatusText(status) {
            const map = { normal: '正常', warning: '即将过期', expired: '已过期', low: '库存不足' };
            return map[status] || status;
        }

        function navigateTo(page) {
            window.location.href = page;
        }
    </script>
</body>
</html>
