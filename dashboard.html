<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>标准物质管理助手 - 首页</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3b82f6', success: '#22c55e',
                        danger: '#ef4444', warning: '#f59e0b'
                    }
                }
            }
        }
    </script>
</head>
<body class="min-h-screen bg-gray-100">
    <div class="header bg-primary text-white p-4 fixed top-0 left-0 right-0 z-100 flex justify-between items-center">
        <h1 class="text-xl font-bold">标准物质管理</h1>
        <div class="flex items-center space-x-4">
            <button id="notificationBtn" class="relative">
                <i class="fa fa-bell-o text-xl"></i>
                <span id="unreadBadge" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center">0</span>
            </button>
            <button id="userBtn" class="flex items-center">
                <i class="fa fa-user-o text-xl mr-2"></i>
                <span id="usernameDisplay">用户</span>
            </button>
        </div>
    </div>

    <div class="content pt-20 p-4 pb-20">
        <div class="grid grid-cols-2 gap-4 mb-4">
            <div class="bg-white rounded-xl shadow p-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">总库存</p>
                    <p id="totalStock" class="text-2xl font-bold">0</p>
                </div>
                <div class="bg-blue-100 p-3 rounded-full">
                    <i class="fa fa-cubes text-primary text-xl"></i>
                </div>
            </div>
            <div class="bg-white rounded-xl shadow p-4 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-500">近效期预警</p>
                    <p id="expiryWarning" class="text-2xl font-bold text-warning">0</p>
                </div>
                <div class="bg-yellow-100 p-3 rounded-full">
                    <i class="fa fa-exclamation-triangle text-warning text-xl"></i>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <h2 class="text-lg font-semibold mb-4">库存状态分布</h2>
            <div class="h-64">
                <canvas id="stockStatusChart"></canvas>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4 mb-4">
            <h2 class="text-lg font-semibold mb-4">快速操作</h2>
            <div class="grid grid-cols-4 gap-4">
                <button class="quick-action-btn" onclick="navigateTo('stock.html?action=add')">
                    <div class="bg-blue-100 p-3 rounded-full mb-2">
                        <i class="fa fa-archive text-primary"></i>
                    </div>
                    <span class="text-xs">入库</span>
                </button>
                <button class="quick-action-btn" onclick="navigateTo('stock.html?action=out')">
                    <div class="bg-green-100 p-3 rounded-full mb-2">
                        <i class="fa fa-sign-out text-success"></i>
                    </div>
                    <span class="text-xs">出库</span>
                </button>
                <button class="quick-action-btn" onclick="navigateTo('stock.html')">
                    <div class="bg-purple-100 p-3 rounded-full mb-2">
                        <i class="fa fa-list text-purple-600"></i>
                    </div>
                    <span class="text-xs">库存</span>
                </button>
                <button class="quick-action-btn" onclick="navigateTo('records.html')">
                    <div class="bg-gray-100 p-3 rounded-full mb-2">
                        <i class="fa fa-history text-gray-600"></i>
                    </div>
                    <span class="text-xs">记录</span>
                </button>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow p-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold">最近活动</h2>
                <a href="records.html" class="text-primary text-sm">查看全部</a>
            </div>
            <div id="recentActivities" class="space-y-3">
                <p class="text-center text-gray-500 py-4">加载中...</p>
            </div>
        </div>
    </div>

    <div class="footer bg-white border-t border-gray-200 fixed bottom-0 left-0 right-0 z-100">
        <div class="flex justify-around">
            <div class="nav-item active" onclick="navigateTo('dashboard.html')">
                <i class="fa fa-home"></i><span>首页</span>
            </div>
            <div class="nav-item" onclick="navigateTo('stock.html')">
                <i class="fa fa-cubes"></i><span>库存</span>
            </div>
            <div class="nav-item" onclick="navigateTo('personnel.html')">
                <i class="fa fa-users"></i><span>人员</span>
            </div>
            <div class="nav-item" onclick="navigateTo('settings.html')">
                <i class="fa fa-cog"></i><span>设置</span>
            </div>
        </div>
    </div>

    <script>
        const { createClient } = supabase;
        const supabaseUrl = 'https://nzqosgvjovormymsiqml.supabase.co';
        const supabaseKey = 'sb_publishable_WJ5NB6wngsil8LT5qOmDRg_tVBQ4A54';
        const supabase = createClient(supabaseUrl, supabaseKey);

        let stockStatusChart;

        document.addEventListener('DOMContentLoaded', async () => {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return;
            }
            
            const userName = localStorage.getItem('userName') || '用户';
            document.getElementById('usernameDisplay').textContent = userName;
            
            initChart();
            await loadStockData();
            await loadRecentActivities();
        });

        function initChart() {
            const ctx = document.getElementById('stockStatusChart').getContext('2d');
            stockStatusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['正常', '即将过期', '已过期', '库存不足'],
                    datasets: [{
                        data: [0, 0, 0, 0],
                        backgroundColor: ['#22c55e', '#f59e0b', '#ef4444', '#3b82f6'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        async function loadStockData() {
            // 移除user_id过滤，查询所有数据
            const { data: stock, error } = await supabase
                .from('stock')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('加载库存数据失败:', error);
                return;
            }
            
            const totalStock = stock.reduce((sum, item) => sum + (item.quantity || 0), 0);
            document.getElementById('totalStock').textContent = totalStock;
            
            const today = new Date();
            const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            const expiryWarning = stock.filter(item => {
                const expiryDate = new Date(item.expiry_date);
                return expiryDate <= thirtyDaysLater && expiryDate >= today;
            }).length;
            document.getElementById('expiryWarning').textContent = expiryWarning;
            
            calculateStockStatusDistribution(stock || []);
        }

        function calculateStockStatusDistribution(stockData) {
            const today = new Date();
            const thirtyDaysLater = new Date(today.getTime() + 30 * 24 * 60 * 60 * 1000);
            
            let normalCount = 0, warningCount = 0, expiredCount = 0, lowCount = 0;
            
            stockData.forEach(item => {
                if (item.quantity === 0) {
                    lowCount++;
                } else {
                    const expiryDate = new Date(item.expiry_date);
                    if (expiryDate < today) expiredCount++;
                    else if (expiryDate <= thirtyDaysLater) warningCount++;
                    else normalCount++;
                }
            });
            
            if (stockStatusChart) {
                stockStatusChart.data.datasets[0].data = [normalCount, warningCount, expiredCount, lowCount];
                stockStatusChart.update();
            }
        }

        async function loadRecentActivities() {
            // 移除user_id过滤，查询所有记录
            const { data: records, error } = await supabase
                .from('records')
                .select('*')
                .order('created_at', { ascending: false })
                .limit(10);
            
            const container = document.getElementById('recentActivities');
            
            if (error || !records || records.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">暂无活动记录</p>';
                return;
            }
            
            container.innerHTML = records.slice(0, 5).map(record => {
                const icon = record.type === 'in' ? 'fa-archive text-primary' : 'fa-sign-out text-success';
                const bgColor = record.type === 'in' ? 'bg-blue-100' : 'bg-green-100';
                const activityText = `${record.material_name} ${record.type === 'in' ? '入库' : '出库'}`;
                
                return `
                    <div class="flex items-center">
                        <div class="${bgColor} p-2 rounded-full mr-3">
                            <i class="fa ${icon}"></i>
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${activityText}</p>
                            <p class="text-xs text-gray-500">${new Date(record.created_at).toLocaleString('zh-CN')} | 操作人: ${record.operator}</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function navigateTo(page) {
            window.location.href = page;
        }

        document.getElementById('userBtn').addEventListener('click', async () => {
            if (confirm('确定要退出登录吗？')) {
                await supabase.auth.signOut();
                localStorage.clear();
                window.location.href = 'index.html';
            }
        });

        document.getElementById('notificationBtn').addEventListener('click', () => {
            alert('消息功能开发中');
        });
    </script>
</body>
</html>
